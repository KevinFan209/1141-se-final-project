<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Tasker æ¡ˆä»¶ç®¡ç†</title>
    <style>
      /* modal å…±ç”¨ */
      /* Modal èƒŒæ™¯é®ç½© */
      /* Modal èƒŒæ™¯é®ç½© */
      .modal {
        display: none; /* åˆå§‹éš±è— */
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.6);
        z-index: 1000;
        justify-content: center;
        align-items: center;
        overflow: auto;
      }

      /* é¡¯ç¤ºæ™‚åŠ ä¸Šå‹•ç•« class */
      .modal.show {
        display: flex;
      }

      /* Modal å…§å®¹å®¹å™¨ï¼šå‹•ç•«åˆå§‹ç‹€æ…‹ */
      .modal-content {
        background-color: #fff;
        padding: 2rem;
        border-radius: 8px;
        max-width: 600px;
        width: 90%;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        position: relative;
        transform: translateY(50px);
        opacity: 0;
        transition: transform 0.4s ease, opacity 0.4s ease;
      }

      /* é¡¯ç¤ºå‹•ç•«ï¼šç”±ä¸‹å¾€ä¸Šæ·¡å…¥ */
      .modal.show .modal-content {
        transform: translateY(0);
        opacity: 1;
      }

      /* é—œé–‰å‹•ç•«ï¼šç”±ä¸Šå¾€ä¸‹æ·¡å‡º */
      .modal.hide .modal-content {
        transform: translateY(-50px);
        opacity: 0;
      }

      /* é—œé–‰æŒ‰éˆ• */
      .close-btn {
        position: absolute;
        top: 1rem;
        right: 1rem;
        font-size: 1.5rem;
        background: none;
        border: none;
        cursor: pointer;
      }
      /* --- æ–°å¢ï¼šå¾…è§£æ±ºäº‹é …èˆ‡èŠå¤©è¦–çª—æ¨£å¼ --- */
      /* è®“æ–°çš„å½ˆçª—å±¤ç´šæ¯”åŸæœ¬çš„é«˜ï¼Œç¢ºä¿è“‹åœ¨ä¸Šé¢ */
      #issuesModal {
        z-index: 2000;
      }

      .chat-layout {
        display: flex;
        height: 60vh;
        border: 1px solid #e6e9ef;
        border-radius: 8px;
        overflow: hidden;
        margin-top: 10px;
      }

      /* å·¦å´ï¼šå¾…è§£æ±ºäº‹é … */
      .chat-sidebar {
        width: 280px;
        background: #f7f8fb;
        border-right: 1px solid #e6e9ef;
        display: flex;
        flex-direction: column;
      }

      .sidebar-header {
        padding: 15px;
        border-bottom: 1px solid #e6e9ef;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #fff;
      }

      .sidebar-header h4 {
        margin: 0;
        font-size: 16px;
        color: #333;
      }

      /* åœ“å½¢ç„¡æ–‡å­—åŠ è™ŸæŒ‰éˆ• */
      .add-issue-btn {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        background: var(--brand);
        color: #fff;
        border: none;
        font-size: 20px;
        line-height: 28px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0;
      }
      .add-issue-btn:hover {
        background: #3367d6;
      }

      .issue-list-container {
        flex: 1;
        overflow-y: auto;
        padding: 10px;
      }

      .issue-item {
        background: #fff;
        padding: 10px;
        border-radius: 6px;
        margin-bottom: 8px;
        border: 1px solid #e6e9ef;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 14px;
      }

      .issue-done-btn {
        background: #fff;
        border: 1px solid #4caf50;
        color: #4caf50;
        border-radius: 4px;
        font-size: 12px;
        padding: 4px 8px;
        cursor: pointer;
      }
      .issue-done-btn:hover {
        background: #4caf50;
        color: #fff;
      }

      /* å³å´ï¼šèŠå¤©ä»‹é¢ */
      .chat-main {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: #fff;
      }

      .chat-history {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        background: #fafafa;
      }

      .chat-message {
        margin-bottom: 15px;
        max-width: 80%;
        padding: 10px 14px;
        border-radius: 12px;
        font-size: 14px;
        line-height: 1.4;
        position: relative;
      }

      .msg-left {
        background: #fff;
        border: 1px solid #e6e9ef;
        align-self: flex-start;
        margin-right: auto;
        border-bottom-left-radius: 2px;
      }

      .msg-right {
        background: #eef6ff;
        color: #1a73e8;
        align-self: flex-end;
        margin-left: auto;
        border-bottom-right-radius: 2px;
        float: right;
        clear: both;
      }

      .chat-input-area {
        padding: 10px;
        border-top: 1px solid #e6e9ef;
        gap: 10px;
        background: #fff;
      }

      .chat-input-area input {
        flex: 1;
        border: 1px solid #d7dbe0;
        border-radius: 20px;
        padding: 8px 16px;
        outline: none;
      }
      /* æ–°å¢ï¼šæœªé¸æ“‡äº‹é …æ™‚çš„æç¤ºæ¨£å¼ */
      .chat-prompt {
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        color: #999;
        background: #fff;
        text-align: center;
        padding: 20px;
      }
    </style>
  </head>
  <body>
    <button
      id="openIssuesBtn"
      class="primary"
      style="background: #009688; margin-right: auto"
    >
      å¾…è§£æ±ºäº‹é …ç®¡ç†
    </button>
    <!-- Issues Modal -->
    <div id="issuesModal" class="modal" aria-hidden="true">
      <div
        class="modal-content"
        style="max-width: 900px; padding: 0; overflow: hidden; height: 80vh"
      >
        <button
          class="close-btn"
          id="closeIssuesModal"
          style="z-index: 10; top: 10px; right: 10px"
        >
          &times;
        </button>

        <div style="padding: 15px 20px; border-bottom: 1px solid #eee">
          <h3 style="margin: 0">æ¡ˆä»¶å”ä½œèˆ‡æºé€š</h3>
        </div>

        <div class="chat-layout">
          <div class="chat-sidebar">
            <div class="sidebar-header">
              <h4>å¾…è§£æ±ºäº‹é …åˆ—è¡¨</h4>
            </div>
            <div id="issueListContainer" class="issue-list-container"></div>
          </div>

          <div class="chat-main">
            <div id="chatHistory" class="chat-history"></div>

            <div id="chatInputArea" class="chat-input-area">
              <input type="text" id="chatInput" placeholder="è¼¸å…¥è¨Šæ¯..." />
              <button
                id="chatSendBtn"
                class="primary"
                style="padding: 6px 16px"
              >
                é€å‡º
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script>
      // 1. å…¨åŸŸè®Šæ•¸å®£å‘Š
      let allIssues = []; // å„²å­˜å¾ API æŠ“å–çš„æ‰€æœ‰äº‹é …
      let currentSelectedIssueId = null; // ç›®å‰é¸ä¸­çš„äº‹é …è³‡æ–™åº« ID
      let currentIssueTaskId = null; // ç›®å‰å°ˆæ¡ˆçš„ ID

      const BASE_API_URL = "backend/issue.php";
      // å®šç¾© API è·¯å¾‘ (è«‹ç¢ºä¿èˆ‡å¾Œç«¯ä¸€è‡´)
      const GET_ISSUES_URL = `${BASE_API_URL}?action=issues/list`;
      const GET_COMMENTS_URL = `${BASE_API_URL}?action=issues/comments`;
      const CREATE_COMMENT_URL = `${BASE_API_URL}?action=issue/comment/create`;

      // 2. ç•¶ DOM è¼‰å…¥å®Œæˆå¾ŒåŸ·è¡Œçš„é‚è¼¯
      document.addEventListener("DOMContentLoaded", () => {
        // ç¶å®šé—œé–‰å½ˆçª—äº‹ä»¶
        const closeBtn = document.getElementById("closeIssuesModal");
        if (closeBtn) {
          closeBtn.onclick = () => {
            const modal = document.getElementById("issuesModal");
            if (modal) {
              modal.style.display = "none";
              document.body.style.overflow = ""; // æ¢å¾©æ²å‹•
            }
          };
        }

        // ç¶å®šç™¼é€æŒ‰éˆ•äº‹ä»¶
        const chatSendBtn = document.getElementById("chatSendBtn");
        if (chatSendBtn) {
          chatSendBtn.onclick = handleSendMessage;
        }

        // ç¶å®š Enter éµäº‹ä»¶
        const chatInput = document.getElementById("chatInput");
        if (chatInput) {
          chatInput.addEventListener("keypress", (e) => {
            if (e.key === "Enter") {
              handleSendMessage();
            }
          });
        }
      });

      // 3. å½ˆçª—é–‹å•Ÿå‡½å¼ (æ›è¼‰åˆ° window ç¢ºä¿ HTML onclick æŠ“å¾—åˆ°)
      window.openIssuesModal = async function (taskId) {
        console.log("è§¸ç™¼å½ˆçª—, taskId:", taskId);
        currentIssueTaskId = taskId;

        const modal = document.getElementById("issuesModal");
        if (modal) {
          // 1. å¼·åˆ¶é¡¯ç¤ºå½ˆçª—
          modal.style.setProperty("display", "flex", "important");
          modal.style.visibility = "visible";
          modal.style.opacity = "1";

          // 2. è®“èƒŒæ™¯ä¸èƒ½æ²å‹•
          document.body.style.overflow = "hidden";

          // 3. æŠ“å–è³‡æ–™
          await fetchAndRenderIssues(taskId);

          // 4. åˆå§‹åŒ–å³å´ç•«é¢
          renderChatHistory();
        } else {
          alert("æ‰¾ä¸åˆ° id='issuesModal' çš„ HTML å…ƒç´ ï¼");
        }
      };

      // 4. æŠ“å–äº‹é …åˆ—è¡¨
      async function fetchAndRenderIssues(taskId) {
        try {
          const resp = await fetch(`${GET_ISSUES_URL}&project_id=${taskId}`);
          const data = await resp.json();
          if (data.success) {
            allIssues = data.issues || [];
            renderIssueList(allIssues);
          }
        } catch (err) {
          console.error("è¼‰å…¥åˆ—è¡¨å¤±æ•—:", err);
        }
      }

      // 5. æ¸²æŸ“å·¦å´åˆ—è¡¨
      function renderIssueList(issues) {
        const container = document.getElementById("issueListContainer");
        if (!container) return;

        if (!issues || issues.length === 0) {
          container.innerHTML = `<div style="padding:20px; color:#999; text-align:center;">æš«ç„¡å¾…è§£æ±ºäº‹é …</div>`;
          return;
        }

        container.innerHTML = "";
        issues.forEach((issue) => {
          const div = document.createElement("div");
          div.className = `issue-item ${
            currentSelectedIssueId == issue.id ? "active" : ""
          }`;
          const statusIcon = issue.issue_is_opened == 1 ? "ğŸ”´" : "ğŸŸ¢";
          div.innerHTML = `<span>${statusIcon} ${issue.title}</span>`;
          div.onclick = () => selectIssue(issue.id);
          container.appendChild(div);
        });
      }

      // 6. é¸æ“‡äº‹é …
      window.selectIssue = async function (issueId) {
        currentSelectedIssueId = issueId;

        // æ›´æ–°å·¦å´åˆ—è¡¨é¸ä¸­æ¨£å¼
        renderIssueList(allIssues);

        // æŠ“å–ç•™è¨€
        await fetchAndRenderComments(issueId);
      };

      // 7. æŠ“å–ç•™è¨€å…§å®¹
      async function fetchAndRenderComments(issueId) {
        try {
          const resp = await fetch(`${GET_COMMENTS_URL}&issue_id=${issueId}`);
          const data = await resp.json();
          if (data.success) {
            renderChatHistory(data.comments);
          }
        } catch (err) {
          console.error("è¼‰å…¥ç•™è¨€å¤±æ•—:", err);
        }
      }

      // 8. æ¸²æŸ“å°è©±å€åŸŸ
      function renderChatHistory(comments = []) {
        const historyContainer = document.getElementById("chatHistory");
        const inputArea = document.getElementById("chatInputArea");
        if (!historyContainer) return;

        historyContainer.innerHTML = "";

        if (currentSelectedIssueId === null) {
          historyContainer.innerHTML = `<div class="chat-prompt">è«‹å¾å·¦å´åˆ—è¡¨é¸æ“‡äº‹é …ä»¥æŸ¥çœ‹è¨è«–ã€‚</div>`;
          if (inputArea) inputArea.style.display = "none";
          return;
        }

        // ğŸ’¡ é—œéµï¼šæ ¹æ“š allIssues ä¸­çš„ç‹€æ…‹æ±ºå®šæ˜¯å¦é¡¯ç¤ºè¼¸å…¥æ¡†
        const currentIssue = allIssues.find(
          (i) => i.id == currentSelectedIssueId
        );
        if (inputArea) {
          const isOpen =
            currentIssue &&
            (currentIssue.issue_is_opened == 1 ||
              currentIssue.issue_is_opened == true);
          inputArea.style.display = isOpen ? "flex" : "none";
        }

        // æ¸²æŸ“è¨Šæ¯æ³¡æ³¡
        if (comments.length === 0) {
          historyContainer.innerHTML = `<div style="text-align:center; color:#999; margin:20px;">å°šç„¡è¨è«–ç´€éŒ„ã€‚</div>`;
        } else {
          comments.forEach((c) => {
            const isMe = String(c.user_id) === String(window.currentUserId);
            const msgDiv = document.createElement("div");
            msgDiv.className = `chat-message ${
              isMe ? "msg-right" : "msg-left"
            }`;
            msgDiv.textContent = c.content;
            historyContainer.appendChild(msgDiv);
          });
        }

        historyContainer.scrollTop = historyContainer.scrollHeight;
      }

      // 9. ç™¼é€ç•™è¨€è™•ç† (æ‰¿åŒ…è€…å°ˆç”¨ï¼šç§»é™¤çµæ¡ˆåŠŸèƒ½)
      async function handleSendMessage() {
        const input = document.getElementById("chatInput");
        if (!input) return;

        const content = input.value.trim();
        if (!currentSelectedIssueId || !content) return;

        // æ‰¿åŒ…è€…ä¸åˆ¤æ–·ã€ŒçµæŸissueã€ï¼Œç›´æ¥ç•¶ä¸€èˆ¬è¨Šæ¯ç™¼é€
        const form = new FormData();
        form.append("issue_id", currentSelectedIssueId);
        form.append("content", content);

        try {
          const resp = await fetch(CREATE_COMMENT_URL, {
            method: "POST",
            body: form,
          });
          const data = await resp.json();
          if (data.success) {
            input.value = "";
            await fetchAndRenderComments(currentSelectedIssueId);
          } else {
            alert("ç™¼é€å¤±æ•—ï¼š" + data.message);
          }
        } catch (err) {
          console.error("ç™¼é€å‡ºéŒ¯:", err);
        }
      }
    </script>
  </body>
</html>
