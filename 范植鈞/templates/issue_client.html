<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Tasker æ¡ˆä»¶ç®¡ç†</title>
    <style>
      /* modal å…±ç”¨ */
      /* Modal èƒŒæ™¯é®ç½© */
      /* Modal èƒŒæ™¯é®ç½© */
      .modal {
        display: none; /* åˆå§‹éš±è— */
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.6);
        z-index: 1000;
        justify-content: center;
        align-items: center;
        overflow: auto;
      }

      /* é¡¯ç¤ºæ™‚åŠ ä¸Šå‹•ç•« class */
      .modal.show {
        display: flex;
      }

      /* Modal å…§å®¹å®¹å™¨ï¼šå‹•ç•«åˆå§‹ç‹€æ…‹ */
      .modal-content {
        background-color: #fff;
        padding: 2rem;
        border-radius: 8px;
        max-width: 600px;
        width: 90%;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        position: relative;
        transform: translateY(50px);
        opacity: 0;
        transition: transform 0.4s ease, opacity 0.4s ease;
      }

      /* é¡¯ç¤ºå‹•ç•«ï¼šç”±ä¸‹å¾€ä¸Šæ·¡å…¥ */
      .modal.show .modal-content {
        transform: translateY(0);
        opacity: 1;
      }

      /* é—œé–‰å‹•ç•«ï¼šç”±ä¸Šå¾€ä¸‹æ·¡å‡º */
      .modal.hide .modal-content {
        transform: translateY(-50px);
        opacity: 0;
      }

      /* é—œé–‰æŒ‰éˆ• */
      .close-btn {
        position: absolute;
        top: 1rem;
        right: 1rem;
        font-size: 1.5rem;
        background: none;
        border: none;
        cursor: pointer;
      }
      /* --- æ–°å¢ï¼šå¾…è§£æ±ºäº‹é …èˆ‡èŠå¤©è¦–çª—æ¨£å¼ --- */
      /* è®“æ–°çš„å½ˆçª—å±¤ç´šæ¯”åŸæœ¬çš„é«˜ï¼Œç¢ºä¿è“‹åœ¨ä¸Šé¢ */
      #issuesModal {
        z-index: 2000;
      }

      .chat-layout {
        display: flex;
        height: 60vh;
        border: 1px solid #e6e9ef;
        border-radius: 8px;
        overflow: hidden;
        margin-top: 10px;
      }

      /* å·¦å´ï¼šå¾…è§£æ±ºäº‹é … */
      .chat-sidebar {
        width: 280px;
        background: #f7f8fb;
        border-right: 1px solid #e6e9ef;
        display: flex;
        flex-direction: column;
      }

      .sidebar-header {
        padding: 15px;
        border-bottom: 1px solid #e6e9ef;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #fff;
      }

      .sidebar-header h4 {
        margin: 0;
        font-size: 16px;
        color: #333;
      }

      /* åœ“å½¢ç„¡æ–‡å­—åŠ è™ŸæŒ‰éˆ• */
      .add-issue-btn {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        background: var(--brand);
        color: #fff;
        border: none;
        font-size: 20px;
        line-height: 28px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0;
      }
      .add-issue-btn:hover {
        background: #3367d6;
      }

      .issue-list-container {
        flex: 1;
        overflow-y: auto;
        padding: 10px;
      }

      .issue-item {
        background: #fff;
        padding: 10px;
        border-radius: 6px;
        margin-bottom: 8px;
        border: 1px solid #e6e9ef;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 14px;
      }

      .issue-done-btn {
        background: #fff;
        border: 1px solid #4caf50;
        color: #4caf50;
        border-radius: 4px;
        font-size: 12px;
        padding: 4px 8px;
        cursor: pointer;
      }
      .issue-done-btn:hover {
        background: #4caf50;
        color: #fff;
      }

      /* å³å´ï¼šèŠå¤©ä»‹é¢ */
      .chat-main {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: #fff;
      }

      .chat-history {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        background: #fafafa;
      }

      .chat-message {
        margin-bottom: 15px;
        max-width: 80%;
        padding: 10px 14px;
        border-radius: 12px;
        font-size: 14px;
        line-height: 1.4;
        position: relative;
      }

      .msg-left {
        background: #fff;
        border: 1px solid #e6e9ef;
        align-self: flex-start;
        margin-right: auto;
        border-bottom-left-radius: 2px;
      }

      .msg-right {
        background: #eef6ff;
        color: #1a73e8;
        align-self: flex-end;
        margin-left: auto;
        border-bottom-right-radius: 2px;
        float: right;
        clear: both;
      }

      .chat-input-area {
        padding: 10px;
        border-top: 1px solid #e6e9ef;
        gap: 10px;
        background: #fff;
      }

      .chat-input-area input {
        flex: 1;
        border: 1px solid #d7dbe0;
        border-radius: 20px;
        padding: 8px 16px;
        outline: none;
      }
      /* æ–°å¢ï¼šæœªé¸æ“‡äº‹é …æ™‚çš„æç¤ºæ¨£å¼ */
      .chat-prompt {
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        color: #999;
        background: #fff;
        text-align: center;
        padding: 20px;
      }
    </style>
  </head>
  <body>
    <button
      id="openIssuesBtn"
      class="primary"
      style="background: #009688; margin-right: auto"
    >
      å¾…è§£æ±ºäº‹é …ç®¡ç†
    </button>
    <!-- Issues Modal -->
    <div id="issuesModal" class="modal" aria-hidden="true">
      <div
        class="modal-content"
        style="max-width: 900px; padding: 0; overflow: hidden; height: auto"
      >
        <button
          class="close-btn"
          id="closeIssuesModal"
          style="z-index: 10; top: 10px; right: 10px"
        >
          &times;
        </button>

        <div style="padding: 15px 20px; border-bottom: 1px solid #eee">
          <h3 style="margin: 0">æ¡ˆä»¶å”ä½œèˆ‡æºé€š</h3>
        </div>

        <div class="chat-layout">
          <div class="chat-sidebar">
            <div class="sidebar-header">
              <h4>å¾…è§£æ±ºäº‹é …</h4>
              <button id="addIssueBtn" class="add-issue-btn" title="æ–°å¢äº‹é …">
                +
              </button>
            </div>
            <div id="issueListContainer" class="issue-list-container"></div>
          </div>

          <div class="chat-main">
            <div id="chatHistory" class="chat-history"></div>

            <div id="chatInputArea" class="chat-input-area">
              <input
                type="text"
                id="chatInput"
                placeholder="è¼¸å…¥è¨Šæ¯... (è¼¸å…¥ã€ŒçµæŸissueã€ä»¥é—œé–‰æ­¤è¨è«–)"
              />
              <button
                id="chatSendBtn"
                class="primary"
                style="padding: 6px 16px"
              >
                é€å‡º
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script>
      /* --- æ–°å¢/ä¿®æ”¹ï¼šå¾…è§£æ±ºäº‹é …èˆ‡èŠå¤©å®¤é‚è¼¯ (æ•´åˆ DB API) --- */

      // åœ¨ä½ çš„ <script> å€å¡Šå…§
      // åŸæœ¬: const FETCH_ISSUES_URL = "/issue.php/api/issues/list";

      // --- ä¿®æ”¹å¾Œ ---
      const BASE_API_URL = "backend/issue.php"; // ç¢ºä¿é€™æ˜¯ issue.php çš„çµ•å°æˆ–ç›¸å°è·¯å¾‘

      const FETCH_ISSUES_URL = `${BASE_API_URL}?action=issues/list`;
      const CREATE_ISSUE_URL = `${BASE_API_URL}?action=issues/create`;
      const RESOLVE_ISSUE_URL = `${BASE_API_URL}?action=issues/resolve`;
      const FETCH_COMMENTS_URL = `${BASE_API_URL}?action=issues/comments`;
      const CREATE_COMMENT_URL = `${BASE_API_URL}?action=issue/comment/create`;
      // --- ç‹€æ…‹ç®¡ç† (ä¿ç•™) ---
      let currentIssueTaskId = null;
      let currentSelectedIssueId = null;
      const commentCache = {};
      // ... ä¿æŒå…¶ä»– JS é‚è¼¯ä¸è®Š ...
      // --- 1. å½ˆçª—é–‹å•Ÿèˆ‡é—œé–‰ ---
      document
        .getElementById("openIssuesBtn")
        .addEventListener("click", function () {
          if (
            typeof currentRepliesTaskId !== "undefined" &&
            currentRepliesTaskId
          ) {
            openIssuesModal(currentRepliesTaskId);
          } else {
            alert("ç„¡æ³•å–å¾—æ¡ˆä»¶ ID");
          }
        });

      window.openIssuesModal = async function (taskId) {
        if (!window.currentUserId) {
          alert("è«‹å…ˆç™»å…¥æˆ–ç­‰å¾…ä½¿ç”¨è€…è³‡è¨Šè¼‰å…¥å®Œæˆã€‚");
          return;
        }

        currentIssueTaskId = taskId;
        currentSelectedIssueId = null;

        const modal = document.getElementById("issuesModal");
        const addIssueBtn = document.getElementById("addIssueBtn"); // å–å¾—æ–°å¢æŒ‰éˆ•

        // --- ğŸ’¡ éš±è—/é¡¯ç¤ºæ–°å¢æŒ‰éˆ•é‚è¼¯ ---
        // å¾ä¸»æ¸…å–®è®Šæ•¸ (å‡è¨­ç‚º allTasks) æ‰¾å‡ºè©²æ¡ˆä»¶
        // æ³¨æ„ï¼šè«‹ç¢ºä¿ä½ çš„ fetchAndRenderTasks æˆåŠŸå¾Œæœ‰å°‡è³‡æ–™å­˜å…¥ allTasks
        const currentTask = allTasks.find((t) => t.id == taskId);

        if (currentTask) {
          // åˆ¤æ–·æ¡ˆä»¶æ˜¯å¦å·²çµæ¡ˆ (ç›¸å®¹å¸ƒæ—å€¼ true æˆ–è³‡æ–™åº«å­—ä¸² "t")
          const isTaskCompleted =
            currentTask.is_completed === true ||
            currentTask.is_completed === "t";

          if (addIssueBtn) {
            if (isTaskCompleted) {
              // è‹¥å·²çµæ¡ˆï¼Œéš±è—æ–°å¢æŒ‰éˆ•
              addIssueBtn.style.display = "none";
            } else {
              // è‹¥æœªçµæ¡ˆï¼Œé¡¯ç¤ºæ–°å¢æŒ‰éˆ• (flex æ˜¯ç‚ºäº†ç¶­æŒåŸæœ‰çš„ UI æ’ç‰ˆ)
              addIssueBtn.style.display = "flex";
            }
          }
        }
        // ---------------------------------

        modal.classList.add("show");
        modal.setAttribute("aria-hidden", "false");
        document.body.style.overflow = "hidden";

        try {
          await fetchAndRenderIssues(taskId);
        } catch (error) {
          console.error("Open Issues Modal failed to load data:", error);
          alert("è¼‰å…¥å¾…è§£æ±ºäº‹é …å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ã€‚");
        }

        // æ¸²æŸ“èŠå¤©å€
        renderChatHistory();
      };
      function closeIssuesModal() {
        const modal = document.getElementById("issuesModal");
        modal.classList.remove("show");
        modal.setAttribute("aria-hidden", "true");
        document.body.style.overflow = "";
        currentIssueTaskId = null;
        currentSelectedIssueId = null;
      }

      // ç¶å®šé—œé–‰äº‹ä»¶
      document
        .getElementById("closeIssuesModal")
        .addEventListener("click", closeIssuesModal);
      document.getElementById("issuesModal").addEventListener("click", (e) => {
        if (e.target === document.getElementById("issuesModal"))
          closeIssuesModal();
      });

      // --- 2. äº‹é …åˆ—è¡¨é‚è¼¯ (CRUD) ---

      // ç²å–ä¸¦æ¸²æŸ“äº‹é …
      // boss.html:1568 é™„è¿‘
      async function fetchAndRenderIssues(taskId) {
        const issueListContainer =
          document.getElementById("issueListContainer");
        issueListContainer.innerHTML = `<div style="text-align:center; padding: 20px; font-size:12px;">è¼‰å…¥ä¸­...</div>`;

        try {
          const resp = await fetch(`${FETCH_ISSUES_URL}&project_id=${taskId}`);
          // --- é—œéµæ–°å¢é‚è¼¯ ---
          // æª¢æŸ¥ Content-Type Header æ˜¯å¦ç‚º JSON
          const contentType = resp.headers.get("content-type");
          if (!contentType || !contentType.includes("application/json")) {
            // å¦‚æœä¸æ˜¯ JSONï¼Œå‰‡è®€å–å›æ‡‰æ–‡æœ¬ï¼Œä¸¦æ‹‹å‡ºéŒ¯èª¤
            const errorText = await resp.text();
            console.error("Non-JSON Response Received:", errorText);
            throw new Error(
              "ä¼ºæœå™¨å›æ‡‰é JSON æ ¼å¼ï¼Œè«‹æª¢æŸ¥ä¼ºæœå™¨éŒ¯èª¤æ—¥èªŒæˆ– API ç¶²å€ï¼"
            );
          }
          // --- é—œéµæ–°å¢é‚è¼¯çµæŸ ---

          // å¦‚æœå›æ‡‰æ˜¯ JSONï¼Œå‰‡ç¹¼çºŒè§£æ
          const data = await resp.json();

          if (data.success && data.issues) {
            renderIssueList(data.issues);
            allIssues = data.issues || [];
          } else {
            issueListContainer.innerHTML = `<div style="color:red; text-align:center; padding: 20px; font-size:12px;">è¼‰å…¥äº‹é …å¤±æ•—: ${
              data.message || "æœªçŸ¥éŒ¯èª¤"
            }</div>`;
          }
        } catch (err) {
          console.error("Fetch issues error:", err);
          // å°‡éŒ¯èª¤è¨Šæ¯é¡¯ç¤ºåœ¨ç•«é¢ä¸Šï¼Œæ–¹ä¾¿æª¢æŸ¥
          issueListContainer.innerHTML = `<div style="color:red; text-align:center; padding: 20px; font-size:12px;">
            API è«‹æ±‚éŒ¯èª¤ï¼š${err.message || "ç„¡æ³•é€£ç·šæˆ–è§£æè³‡æ–™"}
            <br>
            è«‹æª¢æŸ¥ Console å…§æ˜¯å¦æœ‰ 'Non-JSON Response Received' è¨Šæ¯ã€‚
        </div>`;
        }
      }

      // æ¸²æŸ“äº‹é …åˆ—è¡¨ UI
      // åœ¨ä½ çš„ <script> å€å¡Šå…§ï¼Œä¿®æ”¹ renderIssueList å‡½å¼ï¼š

      function renderIssueList(issues) {
        const container = document.getElementById("issueListContainer");
        container.innerHTML = "";

        issues.forEach((issue) => {
          const div = document.createElement("div");
          div.className = "issue-item";

          // 1. è™•ç†æ—¥æœŸæ ¼å¼åŒ– (åªå–å‰ 10 ä½å­—å…ƒ: YYYY-MM-DD)
          const rawDate = issue.created_at || "";
          const formattedDate = rawDate.includes(" ")
            ? rawDate.split(" ")[0]
            : rawDate.slice(0, 10);

          // 2. è™•ç†ç´…ç¶ ç‡ˆé‚è¼¯ (false=ç¶ è‰²/è™•ç†ä¸­, true=ç´…è‰²/å·²çµæ¡ˆ)
          const isClosed =
            issue.issue_is_opened == true || issue.issue_is_opened == 1;
          const statusChar = isClosed ? "ğŸ”´" : "ğŸŸ¢";
          const statusColor = isClosed ? "#e53935" : "#2e7d32";

          div.innerHTML = `
            <span class="issue-status" style="color: ${statusColor}">${statusChar}</span>
            <span class="issue-title">${escapeHtml(issue.title)}</span>
            <span class="issue-date">${formattedDate}</span>
        `;

          div.onclick = () => selectIssue(issue.id);
          container.appendChild(div);
        });
      }

      // æ–°å¢äº‹é …
      // ç¶å®šå·¦å´åˆ—è¡¨ä¸Šæ–¹çš„ "+" æŒ‰éˆ•
      document.getElementById("addIssueBtn").onclick = function () {
        // ğŸš¨ ä¿®æ­£ï¼šç¢ºä¿ container æœ‰è¢«å®šç¾©
        const container = document.getElementById("issueListContainer");

        if (!container) {
          console.error("æ‰¾ä¸åˆ° issueListContainerï¼Œè«‹æª¢æŸ¥ HTML ID æ˜¯å¦æ­£ç¢º");
          return;
        }

        if (document.querySelector(".issue-item.creating")) return;

        const newItem = document.createElement("div");
        newItem.className = "issue-item opened creating";
        newItem.id = "issue-temp-new-issue";

        // æ–°å¢æ™‚é è¨­ç‚ºè™•ç†ä¸­ï¼Œæ‰€ä»¥é¡¯ç¤ºç¶ è‰² (false)
        newItem.innerHTML = `
        <span class="issue-status" style="color: #2e7d32">ğŸŸ¢</span>
        <input type="text" id="tempIssueInput" placeholder="è¼¸å…¥åç¨±å¾ŒæŒ‰ Enter..." 
               style="width: 100%; border: 1px solid var(--brand); outline: none; padding: 2px 5px;">
        <span class="issue-date">ç¾åœ¨</span>
    `;

        container.prepend(newItem); // å°‡æ–°é …ç›®æ”¾åˆ°æœ€ä¸Šæ–¹
        const input = newItem.querySelector("#tempIssueInput");
        input.focus();

        input.onkeydown = async (e) => {
          if (e.key === "Enter") {
            const title = input.value.trim();
            if (title.length < 2) {
              alert("æ¨™é¡Œå¤ªçŸ­å›‰ï¼");
              newItem.remove();
              return;
            }
            await performSaveIssueToDB(title, newItem);
          }
        };

        input.onblur = () => {
          if (!input.value.trim()) newItem.remove();
        };
      };

      // å¯¦éš›å‚³é€åˆ°å¾Œç«¯çš„å‡½å¼
      async function performSaveIssueToDB(title, element) {
        const form = new FormData();
        form.append("project_id", currentRepliesTaskId); // ç¢ºä¿ä½ æœ‰é€™å€‹è®Šæ•¸
        form.append("title", title);

        element.querySelector(".issue-status").textContent = "âŒ›";

        try {
          const resp = await fetch(CREATE_ISSUE_URL, {
            method: "POST",
            body: form,
            credentials: "same-origin",
          });
          const j = await resp.json();

          if (j.success) {
            const realId = j.issue_id;
            // æ¨£å¼ç«‹å³æ”¹è®Šç‚ºå„²å­˜å¾Œçš„æ¨£å­
            element.id = `issue-${realId}`;
            element.dataset.id = realId;
            element.className = "issue-item opened";
            element.innerHTML = `
                <span class="issue-status">ğŸŸ¢</span>
                <span class="issue-title">${title}</span>
                <span class="issue-date">ç¾åœ¨</span>
            `;
            // é»æ“Šå¾Œå¯ä»¥é–‹å•ŸèŠå¤©
            element.onclick = () => selectIssue(realId);
            selectIssue(realId);
          } else {
            alert("æ–°å¢å¤±æ•—ï¼š" + j.message);
            element.remove();
          }
        } catch (err) {
          console.error("Save issue error:", err);
          element.remove();
        }
      }

      // å®Œæˆäº‹é …
      window.completeIssue = async function (issueId) {
        if (!confirm(`ç¢ºå®šæ¨™è¨˜ Issue #${issueId} ç‚ºã€Œå·²è™•ç†å®Œæˆã€å—ï¼Ÿ`)) return;

        const form = new FormData();
        form.append("issue_id", issueId);

        try {
          const resp = await fetch(RESOLVE_ISSUE_URL, {
            method: "POST",
            body: form,
            credentials: "same-origin",
          });
          const j = await resp.json();

          if (j.success) {
            alert("äº‹é …å·²æ¨™è¨˜ç‚ºå®Œæˆã€‚");
            if (currentSelectedIssueId === issueId) {
              currentSelectedIssueId = null; // å¦‚æœå®Œæˆçš„æ˜¯ç•¶å‰é¸ä¸­çš„ï¼Œå–æ¶ˆé¸æ“‡
            }
            await fetchAndRenderIssues(currentIssueTaskId); // é‡æ–°è¼‰å…¥åˆ—è¡¨
            renderChatHistory(); // é‡æ–°æ¸²æŸ“èŠå¤©å€ (å¯èƒ½é¡¯ç¤ºæç¤º)
          } else {
            alert("æ¨™è¨˜å¤±æ•—ï¼š" + (j.message || ""));
          }
        } catch (err) {
          console.error("Resolve issue error:", err);
          alert("ç¶²è·¯éŒ¯èª¤ï¼Œç„¡æ³•å®Œæˆäº‹é …");
        }
      };

      // é¸æ“‡äº‹é …
      window.selectIssue = async function (issueId) {
        if (issueId === currentSelectedIssueId) return; // é¿å…é‡è¤‡é¸æ“‡

        currentSelectedIssueId = issueId;

        // é‡æ–°æ¸²æŸ“åˆ—è¡¨ä»¥æ›´æ–°é¸ä¸­ç‹€æ…‹
        await fetchAndRenderIssues(currentIssueTaskId);

        // ç²å–ä¸¦æ¸²æŸ“è©²äº‹é …çš„ç•™è¨€
        await fetchAndRenderComments(issueId);
      };

      // --- 3. ç•™è¨€èŠå¤©é‚è¼¯ (CRUD) ---

      // ç²å–ä¸¦æ¸²æŸ“ç•™è¨€
      async function fetchAndRenderComments(issueId) {
        const historyContainer = document.getElementById("chatHistory");
        historyContainer.innerHTML = `<div style="text-align:center; padding: 20px; font-size:12px;">è¼‰å…¥ç•™è¨€ä¸­...</div>`;

        try {
          const resp = await fetch(`${FETCH_COMMENTS_URL}&issue_id=${issueId}`);
          const data = await resp.json();

          if (data.success && data.comments) {
            commentCache[issueId] = data.comments; // å¿«å–ç•™è¨€
            renderChatHistory(data.comments);
          } else {
            historyContainer.innerHTML = `<div style="color:red; text-align:center; padding: 20px; font-size:12px;">è¼‰å…¥ç•™è¨€å¤±æ•—: ${
              data.message || "æœªçŸ¥éŒ¯èª¤"
            }</div>`;
          }
        } catch (err) {
          console.error("Fetch comments error:", err);
          historyContainer.innerHTML = `<div style="color:red; text-align:center; padding: 20px; font-size:12px;">ç¶²è·¯éŒ¯èª¤ï¼Œç„¡æ³•è¼‰å…¥ç•™è¨€</div>`;
        }
      }

      // æ¸²æŸ“ç•™è¨€æ­·å²ç´€éŒ„ UI
      // ... (åœ¨ renderChatHistory å‡½å¼å…§éƒ¨)
      // è«‹ç¢ºèªæ‚¨çš„ renderChatHistory å‡½å¼èˆ‡ä»¥ä¸‹ç‰ˆæœ¬ä¸€è‡´
      let allIssues = []; // ç”¨æ–¼å­˜å„²ç›®å‰çš„æ‰€æœ‰äº‹é …åˆ—è¡¨

      function renderChatHistory(comments = null) {
        const historyContainer = document.getElementById("chatHistory"); // ç¢ºä¿å®šç¾©
        const inputArea = document.getElementById("chatInputArea"); // ç¢ºä¿å®šç¾©
        historyContainer.innerHTML = "";

        // æª¢æŸ¥æ˜¯å¦æœ‰é¸ä¸­çš„äº‹é …
        if (currentSelectedIssueId === null) {
          historyContainer.innerHTML = `<div class="chat-prompt">è«‹å¾å·¦å´åˆ—è¡¨ä¸­é¸æ“‡ä¸€å€‹å¾…è§£æ±ºäº‹é …ä»¥é–‹å§‹è¨è«–ã€‚</div>`;
          inputArea.style.display = "none"; // éš±è—è¼¸å…¥æ¡†
          return;
        }

        // æ ¹æ“šç›®å‰é¸ä¸­çš„ Issue çš„is_openç‹€æ…‹æ±ºå®šè¼¸å…¥å€é¡¯ç¤ºèˆ‡å¦
        const currentIssue = allIssues.find(
          (i) => i.id == currentSelectedIssueId
        );
        if (inputArea) {
          // åªæœ‰åœ¨ Issue å­˜åœ¨ä¸”ç‹€æ…‹ç‚º true (1) æ™‚æ‰é¡¯ç¤º flex
          if (
            currentIssue &&
            (currentIssue.issue_is_opened == true ||
              currentIssue.issue_is_opened == 1)
          ) {
            inputArea.style.display = "flex";
          } else {
            // å¦å‰‡è¨­ç‚º noneï¼Œé€™æœƒç›´æ¥å¯«å…¥ element.styleï¼Œæ¬Šé‡è¶³ä»¥è¦†è“‹ CSS
            inputArea.style.display = "none";
          }
        }

        const list = comments || commentCache[currentSelectedIssueId] || [];
        const currentUserIdStr = window.currentUserId;

        if (list.length === 0) {
          const div = document.createElement("div");
          div.style.textAlign = "center";
          div.style.color = "#999";
          div.style.fontSize = "12px";
          div.style.margin = "10px 0";
          div.textContent = "é€™æ˜¯æ–°çš„è¨è«–ï¼Œé–‹å§‹å°è©±å§ï¼";
          historyContainer.appendChild(div);
        }

        list.forEach((comment) => {
          const div = document.createElement("div");
          const isMe = String(comment.user_id) === currentUserIdStr;

          div.className = `chat-message ${isMe ? "msg-right" : "msg-left"}`;
          div.textContent = escapeHtml(comment.content);
          historyContainer.appendChild(div);

          const clear = document.createElement("div");
          clear.style.clear = "both";
          historyContainer.appendChild(clear);
        });
        // æ²å‹•åˆ°åº•éƒ¨
        historyContainer.scrollTop = historyContainer.scrollHeight;
      }

      // ç™¼é€ç•™è¨€
      // ç™¼é€ç•™è¨€æŒ‰éˆ•
      document.getElementById("chatSendBtn").onclick = async function (event) {
        if (currentSelectedIssueId === null) {
          alert("è«‹å…ˆé¸æ“‡ä¸€å€‹äº‹é …å†ç•™è¨€");
          return;
        }

        const input = document.getElementById("chatInput");
        const content = input.value.trim();
        if (content === "çµæŸissue") {
          if (!confirm("ç¢ºå®šè¦çµæ¡ˆä¸¦é—œé–‰æ­¤è¨è«–å—ï¼Ÿ")) return;

          const form = new FormData();
          form.append("issue_id", currentSelectedIssueId);

          try {
            // å‘¼å«æ‚¨ä¹‹å‰çš„å¾Œç«¯ API
            const resp = await fetch(
              "backend/issue.php?action=issues/resolve",
              {
                method: "POST",
                body: form,
              }
            );
            const j = await resp.json();

            if (j.success) {
              alert("æ­¤äº‹é …å·²çµæ¡ˆ");
              input.value = "";

              // ğŸš¨ é‡è¦ï¼šç«‹åˆ»é‡æ–°æŠ“å–è³‡æ–™ï¼Œé€™æœƒæ›´æ–° allIssues é™£åˆ—
              await fetchAndRenderIssues(currentIssueTaskId);

              // ğŸš¨ é‡è¦ï¼šé‡æ–°æ¸²æŸ“å°è©±æ¡†ï¼Œé€™æœƒè§¸ç™¼æˆ‘å€‘å¯«å¥½çš„éš±è—é‚è¼¯
              await renderChatHistory();
            } else {
              alert("é—œé–‰å¤±æ•—ï¼š" + j.message);
            }
          } catch (err) {
            console.error("Resolve error:", err);
          }
          return; // çµæŸåŸ·è¡Œï¼Œä¸è·‘å¾Œé¢çš„ã€Œç™¼é€ä¸€èˆ¬ç•™è¨€ã€é‚è¼¯
        }

        if (content) {
          const form = new FormData();
          form.append("issue_id", currentSelectedIssueId);
          form.append("content", content);

          try {
            // æ³¨æ„ï¼šé€™è£¡æ˜¯ CREATE_COMMENT_URL
            const resp = await fetch(CREATE_COMMENT_URL, {
              method: "POST",
              body: form,
              credentials: "same-origin",
            });
            const j = await resp.json();

            if (j.success) {
              input.value = ""; // æ¸…ç©ºè¼¸å…¥æ¡†
              await fetchAndRenderComments(currentSelectedIssueId); // åˆ·æ–°å°è©±
            } else {
              alert("ç™¼é€å¤±æ•—ï¼š" + j.message);
            }
          } catch (err) {
            console.error("Comment send error:", err);
          }
        }
      };

      // æ”¯æ´æŒ‰ Enter ç™¼é€
      document.getElementById("chatInput").addEventListener("keypress", (e) => {
        if (e.key === "Enter" && currentSelectedIssueId !== null) {
          document.getElementById("chatSendBtn").click();
        }
      });

      // åœ¨ä½ çš„ <script> å€å¡Šå…§æ–°å¢ä»¥ä¸‹å‡½å¼å’Œäº‹ä»¶ï¼š

      let isCreatingNewIssue = false; // ç‹€æ…‹æ¨™è¨˜ï¼Œé˜²æ­¢åŒæ™‚å‰µå»ºå¤šå€‹

      /**
       * åœ¨ UI ä¸Šæ–°å¢ä¸€å€‹å¯ä¾›ç·¨è¼¯çš„äº‹é …é …ç›®
       */
      function addNewIssueToUI() {
        if (isCreatingNewIssue) {
          // å¦‚æœå·²ç¶“åœ¨ç·¨è¼¯ï¼Œå‰‡ä¸åŸ·è¡Œ
          alert("è«‹å…ˆå®Œæˆç•¶å‰æ–°å¢çš„äº‹é …ã€‚");
          return;
        }

        // å‡è¨­æˆ‘å€‘ä½¿ç”¨ä¸€å€‹è‡¨æ™‚ ID ä¾†æ¨™è¨˜é€™å€‹ã€Œæœªå„²å­˜ã€çš„é …ç›®
        const TEMP_ID = "temp-new-issue";

        // 1. å‰µå»ºæ–°çš„åˆ—è¡¨é …ç›®
        const item = document.createElement("div");
        item.className = `issue-item opened creating`;
        item.dataset.id = TEMP_ID;
        item.id = `issue-${TEMP_ID}`;

        item.innerHTML = `
        <span class="issue-status">ğŸ†•</span>
        <span class="issue-title" data-issue-id="${TEMP_ID}">è«‹è¼¸å…¥æ¨™é¡Œ</span>
        <span class="issue-date">ä»Šå¤©</span>
    `;

        const issueListContainer =
          document.getElementById("issueListContainer");
        issueListContainer.prepend(item); // æ”¾åˆ°æœ€é ‚ç«¯

        // 2. ç«‹å³å•Ÿç”¨ç·¨è¼¯æ¨¡å¼
        const titleSpan = item.querySelector(".issue-title");
        enableIssueEdit(titleSpan);

        isCreatingNewIssue = true;
      }

      // ç¶å®š '+' æŒ‰éˆ•
      document
        .getElementById("addIssueBtn")
        .addEventListener("click", addNewIssueToUI);

      // å…¨åŸŸç‹€æ…‹ï¼šå„²å­˜ç•¶å‰ç·¨è¼¯çš„ Issue DOM å…ƒç´ 
      // å…¨åŸŸç‹€æ…‹ï¼šå„²å­˜ç•¶å‰ç·¨è¼¯çš„ Issue DOM å…ƒç´ 
      let currentEditingElement = null;

      // æ–°å¢æ¨™è¨˜ï¼šç”¨æ–¼é˜»æ­¢åœ¨ alert ä¹‹å¾Œç«‹å³é‡æ–°è§¸ç™¼ blur
      let isAlertActive = false;

      /**
       * å°‡ span å…ƒç´ è½‰æ›ç‚ºå¯è¼¸å…¥çš„ input æ¡†ï¼Œä¸¦ç¶å®šäº‹ä»¶
       */
      function enableIssueEdit(titleElement) {
        if (currentEditingElement) {
          // ç¢ºä¿åªèƒ½æœ‰ä¸€å€‹ç·¨è¼¯ä¸­çš„é …ç›®
          currentEditingElement.focus();
          return;
        }

        const issueId = titleElement.dataset.issueId;
        const originalText =
          titleElement.textContent.trim() === "è«‹è¼¸å…¥æ¨™é¡Œ"
            ? ""
            : titleElement.textContent;

        // å‰µå»º Input å…ƒç´ 
        const input = document.createElement("input");
        input.type = "text";
        input.value = originalText;
        input.placeholder = "è«‹è¼¸å…¥äº‹é …æ¨™é¡Œ (å¿…å¡«)";
        input.style.width = "100%";

        // æ›¿æ› DOM
        titleElement.replaceWith(input);
        input.focus();

        currentEditingElement = input; // è¨­ç½®ç•¶å‰ç·¨è¼¯å…ƒç´ 

        // --- ç¶å®šäº‹ä»¶ ---

        // 1. Enter éµäº‹ä»¶
        input.addEventListener("keydown", function (e) {
          if (e.key === "Enter") {
            e.preventDefault(); // é˜»æ­¢æ›è¡Œ
            input.blur(); // è§¸ç™¼å¤±ç„¦äº‹ä»¶ä¾†å„²å­˜
          }
        });

        // 2. å¤±ç„¦ (Blur) äº‹ä»¶ - ä¿®æ­£ç„¡é™è¿´åœˆçš„é—œéµ
        input.addEventListener("blur", async function () {
          if (isAlertActive) return;

          const newTitle = input.value.trim();

          // é©—è­‰é•·åº¦
          if (newTitle.length < 3) {
            isAlertActive = true;
            alert("âš ï¸ æ¨™é¡Œé•·åº¦ä¸è¶³ï¼Œè«‹è¼¸å…¥è‡³å°‘ 3 å€‹å­—ç¬¦ã€‚");
            setTimeout(() => {
              isAlertActive = false;
              input.focus();
            }, 100);
            return;
          }

          // --- é—œéµä¿®æ”¹ï¼šå‘¼å«å„²å­˜å‡½å¼ ---
          await saveNewIssue(issueId, newTitle, input);
        });

        // 3. é›¢é–‹é é¢å‰æç¤ºä¿å­˜
        window.addEventListener("beforeunload", function (e) {
          if (currentEditingElement) {
            e.preventDefault();
            e.returnValue = "";
          }
        });
      }

      /**
       * å„²å­˜æ–°çš„ Issue åˆ°è³‡æ–™åº«
       */
      async function saveNewIssue(issueId, title, inputElement) {
        if (issueId !== "temp-new-issue" || !isCreatingNewIssue) return;

        const itemElement = document.getElementById(`issue-${issueId}`);
        if (!itemElement) return;

        // --- ğŸš€ æ¨‚è§€æ›´æ–°ï¼šç«‹å³æ”¹è®Šæ¨£å¼ ---
        const newSpan = document.createElement("span");
        newSpan.className = "issue-title";
        newSpan.textContent = title;
        newSpan.dataset.issueId = issueId; // æš«æ™‚ä½¿ç”¨ temp ID

        // ç«‹å³å°‡è¼¸å…¥æ¡†æ›å›æ–‡å­—æ¨™ç±¤
        inputElement.replaceWith(newSpan);
        itemElement.classList.remove("creating"); // ç§»é™¤ã€Œå»ºç«‹ä¸­ã€çš„ç‰¹æ®Šæ¨£å¼(å¦‚æœ‰)
        itemElement.querySelector(".issue-status").textContent = "âŒ›"; // é¡¯ç¤ºè™•ç†ä¸­åœ–ç¤º

        try {
          const form = new FormData();
          form.append("project_id", currentRepliesTaskId);
          form.append("title", title);

          const resp = await fetch(CREATE_ISSUE_URL, {
            method: "POST",
            body: form,
          });
          const data = await resp.json();

          if (data.success) {
            // å„²å­˜æˆåŠŸï¼šæ›´æ–°ç‚ºçœŸå¯¦ ID èˆ‡æ­£å¼åœ–ç¤º
            newSpan.dataset.issueId = data.issue_id;
            itemElement.dataset.id = data.issue_id;
            itemElement.id = `issue-${data.issue_id}`;
            itemElement.querySelector(".issue-status").textContent = "ğŸŸ¢";

            // é‡æ–°ç¶å®šé»æ“Šäº‹ä»¶ï¼Œè®“æ–°é …ç›®å¯ä»¥è¢«é¸ä¸­
            itemElement.onclick = () => selectIssue(data.issue_id);

            console.log("è³‡æ–™åº«å„²å­˜æˆåŠŸ");
          } else {
            throw new Error(data.message || "å„²å­˜å¤±æ•—");
          }
        } catch (err) {
          console.error("Save issue error:", err);
          alert("å„²å­˜å¤±æ•—ï¼š" + err.message);

          // --- ğŸ”™ å¾©åŸé‚è¼¯ï¼šå¦‚æœå¤±æ•—ï¼Œç§»é™¤è©²é …ç›®ä¸¦å…è¨±é‡æ–°æ–°å¢ ---
          itemElement.remove();
        } finally {
          isCreatingNewIssue = false;
          currentEditingElement = null;
        }
      }

      // æš´éœ² openIssuesModal çµ¦å…¨åŸŸä½¿ç”¨
      window.openIssuesModal = openIssuesModal;
    </script>
  </body>
</html>
