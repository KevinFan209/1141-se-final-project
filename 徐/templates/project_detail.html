{% extends "base.html" %}
{% block content %}
    <h2>ğŸ” å°ˆæ¡ˆè©³æƒ…ï¼š{{ project.title }}</h2>

    <p>
        ç‹€æ…‹: <span class="status-{{ project.status }}">{{ project.status }}</span> |
        å§”è¨—äºº: **{{ project.client.username }}** |
        {% if project.contractor %}
            æ¥æ¡ˆäºº: **{{ project.contractor.username }}** {% else %}
            æ¥æ¡ˆäºº: å¾…å®š
        {% endif %}
    </p>

    <h3>è©³ç´°éœ€æ±‚æè¿°</h3>
    <p>{{ project.description }}</p>

    <!-- âœ… (A) ä¹™æ–¹æŸ¥çœ‹éœ€æ±‚ï¼šé¡¯ç¤ºç”²æ–¹ï¼ˆå§”è¨—äººï¼‰éå¾€å¹³å‡è©•åƒ¹èˆ‡è³ªæ€§æ„è¦‹ -->
    {% if is_contractor %}
    <div style="border:1px solid #ddd; padding:12px; margin:12px 0;">
      <h3>â­ å§”è¨—äººè©•åƒ¹</h3>
      <p>
        å¹³å‡è©•åˆ†ï¼š<b>{{ "%.2f"|format(client_rating.avg_rating) }}</b> / 5
        ï¼ˆå…± {{ client_rating.count }} å‰‡ï¼‰
      </p>

      {% if client_rating.recent_comments and client_rating.recent_comments|length > 0 %}
        <ul>
          {% for c in client_rating.recent_comments %}
            <li>
              <b>{{ c.reviewer_name }}</b>ï¼ˆ{{ "%.2f"|format(c.avg_score) }}/5ï¼‰ï¼š
              {{ c.comment }}
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p style="color:#666;">ç›®å‰å°šç„¡æ–‡å­—è©•è«–ã€‚</p>
      {% endif %}
    </div>
    {% endif %}

    <hr>

    {# -------------------------------------------------------------------------------- #}
    {# è§’è‰²åŠŸèƒ½å€å¡Š #}
    {# -------------------------------------------------------------------------------- #}

    {% if is_client %}
        {# ---------------------- å§”è¨—äººåŠŸèƒ½å€ ---------------------- #}

        {% if project.status == 'open' %}
            <h3>ğŸ’° å ±åƒ¹åˆ—è¡¨ ({{ proposals | length }} ä»½å ±åƒ¹)</h3>
            {% if proposals %}
                <table>
                    <tr>
                        <th>å ±åƒ¹äºº</th>
                        <th>å ±åƒ¹é‡‘é¡ (NTD)</th>
                        <th>å ±åƒ¹ç´°ç¯€</th>
                        <th>ç‹€æ…‹</th>
                        <th>æ“ä½œ</th>
                    </tr>
                    {% for proposal in proposals %}
                    <tr>
                        <td>
                            {{ proposal.contractor.username }}

                            <!-- âœ… (B) ç”²æ–¹æŸ¥çœ‹ææ¡ˆï¼šé¡¯ç¤ºä¹™æ–¹ï¼ˆæ¥æ¡ˆäººï¼‰å¹³å‡è©•åƒ¹èˆ‡è³ªæ€§æ„è¦‹ -->
                            {% set r = contractor_ratings.get(proposal.contractor_id) %}
                            {% if r %}
                              <div style="border:1px dashed #bbb; padding:10px; margin:10px 0;">
                                <p style="margin:0 0 6px 0;">
                                  æ¥æ¡ˆäººè©•åƒ¹ï¼š<b>{{ "%.2f"|format(r.avg_rating) }}</b> / 5ï¼ˆ{{ r.count }} å‰‡ï¼‰
                                </p>
                                {% if r.recent_comments and r.recent_comments|length > 0 %}
                                  <details>
                                    <summary>æŸ¥çœ‹æœ€è¿‘è©•è«–</summary>
                                    <ul>
                                      {% for c in r.recent_comments %}
                                        <li><b>{{ c.reviewer_name }}</b>ï¼š{{ c.comment }}</li>
                                      {% endfor %}
                                    </ul>
                                  </details>
                                {% else %}
                                  <p style="color:#666; margin:0;">å°šç„¡æ–‡å­—è©•è«–ã€‚</p>
                                {% endif %}
                              </div>
                            {% endif %}
                        </td>

                        <td>{{ proposal.price | round(2) }}</td>
                        <td>{{ proposal.details }}</td>
                        <td>{{ proposal.status }}</td>
                        <td>
                            <form method="POST" action="{{ url_for('accept_proposal', proposal_id=proposal.id) }}" style="display:inline;">
                                <button type="submit" class="btn btn-success" onclick="return confirm('ç¢ºå®šæ¥å—æ­¤å ±åƒ¹å—ï¼Ÿæ¥å—å¾Œå°ˆæ¡ˆå°‡é€²å…¥é€²è¡Œä¸­ç‹€æ…‹ï¼')">é¸æ“‡æ­¤å ±åƒ¹</button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </table>
            {% else %}
                <p>ç›®å‰æ²’æœ‰ä»»ä½•å ±åƒ¹ã€‚</p>
            {% endif %}

        {% elif project.status == 'waiting_review' %}
            {# ---------------------- å§”è¨—äººï¼šçµæ¡ˆç®¡ç† (é€€ä»¶ã€æ¥å—çµæ¡ˆ) ---------------------- #}
            <h3>âœ… çµæ¡ˆå¯©æ ¸</h3>
            <p>æ¥æ¡ˆäººå·²æäº¤çµæ¡ˆæª”æ¡ˆï¼š
                {% if project.delivery_file_path %}
                    <a href="{{ url_for('download_delivery', filename=project.delivery_file_path) }}" class="btn btn-info">ä¸‹è¼‰çµæ¡ˆæª”æ¡ˆ</a>
                {% else %}
                    **[æª”æ¡ˆè·¯å¾‘éºå¤±æˆ–æœªæ­£ç¢ºå„²å­˜]**
                {% endif %}
            </p>

            <form method="POST" action="{{ url_for('review_delivery', project_id=project.id) }}" style="display:inline;">
                <input type="hidden" name="action" value="accept">
                <button type="submit" class="btn btn-success" onclick="return confirm('ç¢ºå®šæ¥å—çµæ¡ˆå—ï¼Ÿæ¥å—å¾Œå°ˆæ¡ˆå°‡çµæ¡ˆï¼')">âœ… æ¥å—çµæ¡ˆ</button>
            </form>

            <form method="POST" action="{{ url_for('review_delivery', project_id=project.id) }}" style="display:inline;">
                <input type="hidden" name="action" value="reject">
                <button type="submit" class="btn btn-warning" onclick="return confirm('ç¢ºå®šé€€ä»¶å—ï¼Ÿå°ˆæ¡ˆå°‡é€€å›é€²è¡Œä¸­ç‹€æ…‹ã€‚')">âš ï¸ é€€ä»¶ (è¦æ±‚ä¿®æ”¹)</button>
            </form>

        {% elif project.status == 'pending' %}
            <h3>é€²è¡Œä¸­</h3>
            <p>å°ˆæ¡ˆå·²å§”è¨—çµ¦ **{{ project.contractor.username }}**ï¼Œç­‰å¾…å°æ–¹æäº¤çµæ¡ˆæª”æ¡ˆã€‚</p>

        {% elif project.status == 'closed' %}
            <h3>å·²çµæ¡ˆ</h3>
            <p>å°ˆæ¡ˆå·²æ–¼ {{ project.created_at.strftime('%Y-%m-%d') }} æˆåŠŸçµæ¡ˆã€‚</p>

            <!-- âœ… (C) çµæ¡ˆå¾Œäº’è©•ï¼ˆåœ–ç‰‡ä¸€éœ€æ±‚ï¼‰ -->
            {% if project.contractor_id %}
              <div style="border:2px solid #333; padding:14px; margin-top:18px;">
                <h3>äº’è©•æ©Ÿåˆ¶</h3>
                <p style="color:#555;">çµæ¡ˆå¾Œ {{ review_deadline_days }} å¤©å…§å¯è©•åƒ¹åˆä½œå°è±¡ï¼ˆä¸‰ç¶­åº¦ 1~5 æ˜Ÿ + æ–‡å­—è©•è«–ï¼‰ã€‚</p>

                {% if my_existing_review %}
                  <p style="color:green;"><b>ä½ å·²é€å‡ºè©•åƒ¹ï¼š</b>ï¼ˆ{{ my_existing_review.avg_score()|round(2) }}/5ï¼‰</p>
                  <ul>
                    <li>åˆ†æ•¸1ï¼š{{ my_existing_review.score_1 }}</li>
                    <li>åˆ†æ•¸2ï¼š{{ my_existing_review.score_2 }}</li>
                    <li>åˆ†æ•¸3ï¼š{{ my_existing_review.score_3 }}</li>
                  </ul>
                  {% if my_existing_review.comment %}
                    <p>è©•è«–ï¼š{{ my_existing_review.comment }}</p>
                  {% endif %}
                {% else %}
                  {% if can_review %}
                    <p><b>è©•åƒ¹ç¶­åº¦ï¼š</b>{{ review_dims[0] }}ã€{{ review_dims[1] }}ã€{{ review_dims[2] }}</p>

                    <form method="POST" action="{{ url_for('submit_review', project_id=project.id) }}">
                      <label>{{ review_dims[0] }}ï¼ˆ1~5ï¼‰</label>
                      <input type="number" name="score_1" min="1" max="5" required><br><br>

                      <label>{{ review_dims[1] }}ï¼ˆ1~5ï¼‰</label>
                      <input type="number" name="score_2" min="1" max="5" required><br><br>

                      <label>{{ review_dims[2] }}ï¼ˆ1~5ï¼‰</label>
                      <input type="number" name="score_3" min="1" max="5" required><br><br>

                      <label>æ•´é«”è©•è«–ï¼ˆé¸å¡«ï¼‰</label><br>
                      <textarea name="comment" rows="3" style="width:100%;"></textarea><br><br>

                      <button type="submit" class="btn btn-success">é€å‡ºè©•åƒ¹</button>
                    </form>
                  {% else %}
                    <p style="color:#b00;">ç›®å‰ç„¡æ³•è©•åƒ¹ï¼ˆå¯èƒ½å·²è¶…éæœŸé™æˆ–ä¸ç¬¦åˆæ¢ä»¶ï¼‰ã€‚</p>
                  {% endif %}
                {% endif %}
              </div>
            {% endif %}

        {% endif %}

    {% elif is_contractor %}
        {# ---------------------- æ¥æ¡ˆäººåŠŸèƒ½å€ ---------------------- #}

        {% if project.status == 'open' and not my_proposal %}
            {# ---------------------- æ¥æ¡ˆäººï¼šæå‡ºæ‰¿åŒ…æ„é¡˜ (å ±åƒ¹) ---------------------- #}
            <h3>ğŸ’µ æå‡ºæ‰¿åŒ…æ„é¡˜</h3>
            <form method="POST" action="{{ url_for('make_proposal', project_id=project.id) }}">
                <label for="price">æ‚¨çš„å ±åƒ¹é‡‘é¡ (NTD):</label>
                <input type="number" name="price" step="0.01" required>

                <label for="details">å ±åƒ¹èªªæ˜ / é è¨ˆå·¥æœŸ:</label>
                <textarea name="details" rows="5" required></textarea>

                <button type="submit" class="btn btn-success">æäº¤å ±åƒ¹</button>
            </form>

        {% elif project.status == 'open' and my_proposal %}
            <h3>âœ… å·²å ±åƒ¹</h3>
            <p>æ‚¨å·²å ±åƒ¹ NTD {{ my_proposal.price | round(2) }}ï¼Œç›®å‰å ±åƒ¹ç‹€æ…‹ç‚º **{{ my_proposal.status }}**ï¼Œç­‰å¾…å§”è¨—äººå¯©æ ¸ã€‚</p>

        {% elif project.status == 'pending' and is_contractor_assigned %}
            {# ---------------------- æ¥æ¡ˆäººï¼šä¸Šå‚³çµæ¡ˆæª”æ¡ˆ ---------------------- #}
            <h3>ğŸ“¤ æäº¤çµæ¡ˆæª”æ¡ˆ</h3>
            <form method="POST" action="{{ url_for('submit_delivery', project_id=project.id) }}" enctype="multipart/form-data">
                <p>å°ˆæ¡ˆå·²è¢«æ‚¨æ‰¿æ¥ï¼Œè«‹ä¸Šå‚³æœ€çµ‚çµæ¡ˆæª”æ¡ˆã€‚</p>
                <label for="file">é¸æ“‡æª”æ¡ˆ:</label>
                <input type="file" name="file" required>
                <br><br>
                <button type="submit" class="btn btn-success">æäº¤çµæ¡ˆ</button>
            </form>

        {% elif project.status == 'waiting_review' and is_contractor_assigned %}
            <h3>â³ ç­‰å¾…å¯©æ ¸</h3>
            <p>æ‚¨å·²æäº¤çµæ¡ˆæª”æ¡ˆ
                {% if project.delivery_file_path %}
                    **{{ project.delivery_file_path }}**
                {% else %}
                    **[æª”æ¡ˆè·¯å¾‘éºå¤±æˆ–æœªæ­£ç¢ºå„²å­˜]**
                {% endif %}
                ï¼Œç­‰å¾…å§”è¨—äººå¯©æ ¸ä¸­ã€‚
            </p>
            <p class="flash warning">å¦‚æœè¢«é€€ä»¶ï¼Œå°ˆæ¡ˆç‹€æ…‹æœƒå›åˆ°ã€Œpendingã€ï¼Œæ‚¨å°‡éœ€è¦é‡æ–°æäº¤ã€‚</p>

        {% elif project.status == 'closed' and is_contractor_assigned %}
            <h3>ğŸ‰ å°ˆæ¡ˆå·²æˆåŠŸçµæ¡ˆ</h3>
            <p>å°ˆæ¡ˆå·²å®Œæˆä¸¦çµæ¡ˆã€‚</p>

            <!-- âœ… (C) çµæ¡ˆå¾Œäº’è©•ï¼ˆæ¥æ¡ˆäººä¹Ÿè¦èƒ½è©•å§”è¨—äººï¼‰ -->
            {% if project.contractor_id %}
              <div style="border:2px solid #333; padding:14px; margin-top:18px;">
                <h3>äº’è©•æ©Ÿåˆ¶</h3>
                <p style="color:#555;">çµæ¡ˆå¾Œ {{ review_deadline_days }} å¤©å…§å¯è©•åƒ¹åˆä½œå°è±¡ï¼ˆä¸‰ç¶­åº¦ 1~5 æ˜Ÿ + æ–‡å­—è©•è«–ï¼‰ã€‚</p>

                {% if my_existing_review %}
                  <p style="color:green;"><b>ä½ å·²é€å‡ºè©•åƒ¹ï¼š</b>ï¼ˆ{{ my_existing_review.avg_score()|round(2) }}/5ï¼‰</p>
                  <ul>
                    <li>åˆ†æ•¸1ï¼š{{ my_existing_review.score_1 }}</li>
                    <li>åˆ†æ•¸2ï¼š{{ my_existing_review.score_2 }}</li>
                    <li>åˆ†æ•¸3ï¼š{{ my_existing_review.score_3 }}</li>
                  </ul>
                  {% if my_existing_review.comment %}
                    <p>è©•è«–ï¼š{{ my_existing_review.comment }}</p>
                  {% endif %}
                {% else %}
                  {% if can_review %}
                    <p><b>è©•åƒ¹ç¶­åº¦ï¼š</b>{{ review_dims[0] }}ã€{{ review_dims[1] }}ã€{{ review_dims[2] }}</p>

                    <form method="POST" action="{{ url_for('submit_review', project_id=project.id) }}">
                      <label>{{ review_dims[0] }}ï¼ˆ1~5ï¼‰</label>
                      <input type="number" name="score_1" min="1" max="5" required><br><br>

                      <label>{{ review_dims[1] }}ï¼ˆ1~5ï¼‰</label>
                      <input type="number" name="score_2" min="1" max="5" required><br><br>

                      <label>{{ review_dims[2] }}ï¼ˆ1~5ï¼‰</label>
                      <input type="number" name="score_3" min="1" max="5" required><br><br>

                      <label>æ•´é«”è©•è«–ï¼ˆé¸å¡«ï¼‰</label><br>
                      <textarea name="comment" rows="3" style="width:100%;"></textarea><br><br>

                      <button type="submit" class="btn btn-success">é€å‡ºè©•åƒ¹</button>
                    </form>
                  {% else %}
                    <p style="color:#b00;">ç›®å‰ç„¡æ³•è©•åƒ¹ï¼ˆå¯èƒ½å·²è¶…éæœŸé™æˆ–ä¸ç¬¦åˆæ¢ä»¶ï¼‰ã€‚</p>
                  {% endif %}
                {% endif %}
              </div>
            {% endif %}

        {% endif %}

    {% else %}
        {# ---------------------- å…¬é–‹å°ˆæ¡ˆ (éç™»å…¥è€…æˆ–éç›¸é—œäººå£«) ---------------------- #}
        {% if project.status == 'open' %}
            <h3>â„¹ï¸ æ­¤ç‚ºé–‹æ”¾å°ˆæ¡ˆ</h3>
            <p>æ­¤å°ˆæ¡ˆç›®å‰å…¬é–‹æ‹›å‹Ÿä¸­ã€‚è«‹ç™»å…¥æ¥æ¡ˆäººå¸³è™Ÿå³å¯æäº¤å ±åƒ¹ã€‚</p>
        {% endif %}
    {% endif %}

    <hr>
    <a href="{{ url_for('dashboard') }}" class="btn btn-info">â† è¿”å›å„€è¡¨æ¿</a>
{% endblock %}
