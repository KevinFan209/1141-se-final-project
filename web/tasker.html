<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Tasker æ¡ˆä»¶ç®¡ç†ï¼ˆæ‰¿åŒ…è€…å°ˆç”¨ï¼‰</title>
    <style>
      :root {
        --sidebar-w: 220px;
        --accent: #e53935;
        --brand: #4285f4;
        --muted: #777;
        --bg: #f7f8fb;
        --card: #fff;
        --reply-yellow: #ffca28;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: system-ui, -apple-system, "Segoe UI", Roboto,
          "Noto Sans TC", sans-serif;
        background: var(--bg);
        color: #111;
      }
      .app {
        display: flex;
        min-height: 100vh;
      }
      .sidebar {
        width: var(--sidebar-w);
        background: linear-gradient(180, #fff, #f2f4f8);
        border-right: 1px solid #e6e9ef;
        padding: 20px;
      }
      .profile {
        padding: 12px;
        background: transparent;
        border-radius: 8px;
        margin-bottom: 12px;
      }
      .profile .role {
        font-weight: 600;
        color: var(--brand);
      }
      .profile .userid {
        margin-top: 6px;
        color: #333;
        font-size: 14px;
      }
      .profile .edit {
        display: inline-block;
        margin-top: 8px;
        font-size: 13px;
        color: var(--muted);
        text-decoration: none;
      }

      .menu ul {
        list-style: none;
        padding: 0;
        margin: 12px 0;
      }
      .menu li {
        padding: 10px;
        border-radius: 6px;
        cursor: pointer;
        color: #333;
        margin-bottom: 6px;
      }
      .menu li.active {
        background: #eef6ff;
        color: var(--brand);
        font-weight: 600;
      }

      .main {
        flex: 1;
        padding: 28px;
      }
      .main-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 18px;
      }
      .main-header h1 {
        margin: 0;
        font-size: 20px;
      }
      .tabs {
        display: flex;
        gap: 8px;
      }
      .tab {
        padding: 8px 14px;
        border-radius: 6px;
        border: 1px solid transparent;
        background: #eee;
        cursor: pointer;
      }
      .tab.active {
        background: var(--brand);
        color: #fff;
        border-color: rgba(0, 0, 0, 0.05);
      }

      .content {
        background: transparent;
      }
      .empty-state {
        background: var(--card);
        padding: 48px;
        border-radius: 10px;
        text-align: center;
        color: var(--muted);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.04);
      }
      .empty-state .empty-text {
        font-size: 18px;
        margin: 18px 0;
      }

      .primary {
        background: var(--accent);
        color: #fff;
        border: none;
        padding: 10px 16px;
        border-radius: 8px;
        cursor: pointer;
      }
      .hidden {
        display: none;
      }

      .case-list {
        display: grid;
        gap: 12px;
      }
      .case-item {
        background: var(--card);
        padding: 14px;
        border-radius: 8px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border: 1px solid #eef2f6;
      }
      .case-meta {
        color: var(--muted);
        font-size: 13px;
      }

      /* å‹•ä½œæ¬„ç½®ä¸­ï¼ŒåŸæœ¬æŒ‰éˆ•å€åŸŸä½ç½® */
      .actions-column {
        margin-top: 12px;
        display: flex;
        flex-direction: column;
        gap: 12px;
        justify-content: center; /* å‚ç›´ç½®ä¸­ */
        align-items: center;
        min-width: 140px;
      }

      /* å›å¾©æ¥­ä¸»æŒ‰éˆ•ï¼ˆé»ƒè‰²ï¼‰ */
      .btn-reply {
        background: linear-gradient(180deg, var(--reply-yellow), #ffc107);
        color: #3b2e00;
        border: 1px solid rgba(0, 0, 0, 0.06);
        padding: 10px 12px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
      }
      .btn-reply:hover {
        filter: brightness(0.98);
      }
      .status-wait {
        background: #f0f4f8;
        color: #555;
        padding: 8px 12px;
        border-radius: 8px;
        border: 1px solid #e1e6ee;
        font-weight: 600;
      }

      /* modal å…±ç”¨ */
      /* é®ç½©å±¤ï¼šç¢ºä¿å®ƒèƒ½è“‹ä½å…¨è¢å¹•ä¸¦ç½®ä¸­å…§å®¹ */
      .modal {
        display: none;
        position: fixed;
        z-index: 9999 !important;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.6); /* è®Šç°çš„æ•ˆæœ */

        /* æ ¸å¿ƒï¼šè®“å…§éƒ¨çš„ modal-content ç½®ä¸­ */
        justify-content: center;
        align-items: center;
      }

      .modal.show {
        display: flex;
      }
      /* å½ˆçª—ä¸»é«”ï¼šç¢ºä¿å®ƒæœ‰ç™½è‰²èƒŒæ™¯å’Œè¶³å¤ å¤§å° */
      .modal-content {
        background-color: #fff;
        width: 90%;
        max-width: 900px; /* æ‚¨è¨­å®šçš„å¯¬åº¦ */
        height: 80vh; /* è¨­å®šé«˜åº¦ï¼Œé¿å…ç¸®æˆä¸€æ¢ç·š */
        border-radius: 12px;
        display: flex; /* å…§éƒ¨ä½ˆå±€ */
        flex-direction: column;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        overflow: hidden; /* é˜²æ­¢å…§å®¹æº¢å‡º */
        position: relative;
      }
      .modal.show .modal-content {
        transform: translateY(0);
        opacity: 1;
      }
      .close-btn {
        position: absolute;
        top: 0.6rem;
        right: 0.6rem;
        font-size: 1.4rem;
        background: none;
        border: none;
        cursor: pointer;
      }
      label {
        display: block;
        margin: 10px 0 6px;
        font-size: 14px;
      }
      input,
      textarea,
      select {
        width: 100%;
        padding: 8px;
        border: 1px solid #d7dbe0;
        border-radius: 6px;
      }
      textarea {
        min-height: 120px;
        resize: vertical;
      }
      .form-row {
        display: flex;
        gap: 12px;
      }
      .col {
        flex: 1;
      }
      .file-list {
        margin-top: 8px;
        font-size: 0.95rem;
        color: #555;
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }
      .file-item {
        display: inline-block;
        width: 120px;
        padding: 6px;
        border: 1px solid #e6e9ef;
        border-radius: 6px;
        background: #fff;
        text-align: center;
        font-size: 12px;
        color: #333;
      }
      .file-item img {
        display: block;
        max-width: 100%;
        max-height: 80px;
        object-fit: cover;
        margin-bottom: 6px;
        border-radius: 4px;
      }
      .modal-actions {
        display: flex;
        gap: 8px;
        justify-content: flex-end;
        margin-top: 12px;
      }

      /* ä¿ç•™åŸæœ‰ contract list æ¨£å¼ */
      #contractList button.active {
        background-color: #2e7d32 !important;
        color: #fff !important;
        border: 1px solid rgba(0, 0, 0, 0.06) !important;
        box-shadow: 0 2px 6px rgba(46, 125, 50, 0.18);
      }
      #contractList button {
        background: #fff;
        color: #333;
        border: 1px solid #ddd;
        padding: 8px 10px;
        border-radius: 6px;
        cursor: pointer;
      }
      .menu li a {
        color: inherit;
        text-decoration: none;
        cursor: pointer;
        background: none;
        padding: 0;
        border: none;
        display: inline-block;
      }
      /* --- æ–°å¢ï¼šå¾…è§£æ±ºäº‹é …èˆ‡èŠå¤©è¦–çª—æ¨£å¼ --- */
      /* è®“æ–°çš„å½ˆçª—å±¤ç´šæ¯”åŸæœ¬çš„é«˜ï¼Œç¢ºä¿è“‹åœ¨ä¸Šé¢ */
      #issuesModal {
        z-index: 2000;
      }

      .chat-layout {
        display: flex;
        height: 60vh;
        border: 1px solid #e6e9ef;
        border-radius: 8px;
        overflow: hidden;
        margin-top: 10px;
      }

      /* å·¦å´ï¼šå¾…è§£æ±ºäº‹é … */
      .chat-sidebar {
        width: 280px;
        background: #f7f8fb;
        border-right: 1px solid #e6e9ef;
        display: flex;
        flex-direction: column;
      }

      .sidebar-header {
        padding: 15px;
        border-bottom: 1px solid #e6e9ef;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #fff;
      }

      .sidebar-header h4 {
        margin: 0;
        font-size: 16px;
        color: #333;
      }

      /* åœ“å½¢ç„¡æ–‡å­—åŠ è™ŸæŒ‰éˆ• */
      .add-issue-btn {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        background: var(--brand);
        color: #fff;
        border: none;
        font-size: 20px;
        line-height: 28px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0;
      }
      .add-issue-btn:hover {
        background: #3367d6;
      }

      .issue-list-container {
        flex: 1;
        overflow-y: auto;
        padding: 10px;
      }

      .issue-item {
        background: #fff;
        padding: 10px;
        border-radius: 6px;
        margin-bottom: 8px;
        border: 1px solid #e6e9ef;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 14px;
      }

      .issue-done-btn {
        background: #fff;
        border: 1px solid #4caf50;
        color: #4caf50;
        border-radius: 4px;
        font-size: 12px;
        padding: 4px 8px;
        cursor: pointer;
      }
      .issue-done-btn:hover {
        background: #4caf50;
        color: #fff;
      }

      /* å³å´ï¼šèŠå¤©ä»‹é¢ */
      .chat-main {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: #fff;
      }

      .chat-history {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        background: #fafafa;
      }

      .chat-message {
        margin-bottom: 15px;
        max-width: 80%;
        padding: 10px 14px;
        border-radius: 12px;
        font-size: 14px;
        line-height: 1.4;
        position: relative;
      }

      .msg-left {
        background: #fff;
        border: 1px solid #e6e9ef;
        align-self: flex-start;
        margin-right: auto;
        border-bottom-left-radius: 2px;
      }

      .msg-right {
        background: #eef6ff;
        color: #1a73e8;
        align-self: flex-end;
        margin-left: auto;
        border-bottom-right-radius: 2px;
        float: right;
        clear: both;
      }

      .chat-input-area {
        padding: 10px;
        border-top: 1px solid #e6e9ef;
        gap: 10px;
        background: #fff;
      }

      .chat-input-area input {
        flex: 1;
        border: 1px solid #d7dbe0;
        border-radius: 20px;
        padding: 8px 16px;
        outline: none;
      }
      /* æ–°å¢ï¼šæœªé¸æ“‡äº‹é …æ™‚çš„æç¤ºæ¨£å¼ */
      .chat-prompt {
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        color: #999;
        background: #fff;
        text-align: center;
        padding: 20px;
      }
      .rating-input {
  width: 60px;
  padding: 5px;
  border: 1px solid #ccc;
  border-radius: 4px;
}

/* è®“å·²çµæ¡ˆçš„ Task Card æœ‰è¦–è¦ºå€éš” */
.task-card:has(.review-btn-area) {
  border-left: 4px solid #ff9800;
  background: #fff9f0;
}
    </style>
  </head>
  <body>
    <div class="app">
      <aside class="sidebar">
        <div class="profile">
          <div class="role">æ‰¿åŒ…è€…</div>
          <div class="userid">ID:æœªç™»å…¥</div>
          <a class="edit" href="#">ç·¨è¼¯å€‹äººè³‡æ–™</a>
        </div>
        <nav class="menu">
          <ul>
            <li class="active" data-page="cases">æ¡ˆä»¶ç®¡ç†</li>
            <li><a href="main.html">ğŸ  é¦–é </a></li>
            <li><a href="tasklist.html">ğŸ“‹ ä»»å‹™åˆ—è¡¨</a></li>
            <li><a href="boss.html">ğŸ‘¤ ç™¼å‡ºæ¡ˆä»¶ç®¡ç†</a></li>
          </ul>
        </nav>
      </aside>

      <main class="main">
        <header class="main-header">
          <h1>æ¡ˆä»¶ç®¡ç†ï¼ˆæ‰¿åŒ…è€…è¦–è§’ï¼‰</h1>
          <div class="tabs" role="tablist">
            <button class="tab active" data-status="published">åˆŠç™»ä¸­</button>
            <button class="tab" data-status="completed">å·²æˆäº¤</button>
            <button class="tab" data-status="review">å¯©æ ¸ä¸­</button>
            <button class="tab" data-status="rejected">æœªé€šé</button>
          </div>
        </header>

        <section class="content">
          <div id="case-area">
            <div class="empty-state hidden" id="empty">
              <div class="illustration" aria-hidden="true"></div>
              <p class="empty-text">ç›®å‰æ²’æœ‰å¯é¡¯ç¤ºçš„æ¡ˆä»¶</p>
            </div>

            <div id="list" class="case-list"></div>

            <div style="text-align: center; margin-top: 24px"></div>
          </div>
        </section>
      </main>
    </div>

    <!-- Contract modalï¼ˆä¿ç•™ï¼‰ -->
    <div id="contractModal" class="modal" aria-hidden="true">
      <div class="modal-content">
        <button class="close-btn" id="closeContractModal">&times;</button>
        <h3>æ¥æ¡ˆç®¡ç†</h3>
        <div id="contractList" style="margin: 12px 0"></div>
        <div style="text-align: right">
          <button id="assignConfirmBtn" class="primary">âœ… ç¢ºå®šæŒ‡æ´¾</button>
        </div>
      </div>
    </div>

    <!-- æ–°å¢ï¼šå›å¾©æ¥­ä¸» modal -->
    <div id="replyModal" class="modal" aria-hidden="true">
      <div
        class="modal-content"
        role="dialog"
        aria-modal="true"
        aria-labelledby="replyTitle"
      >
        <button class="close-btn" id="closeReplyModal">&times;</button>
        <h3 id="replyTitle">å›å¾©æ¥­ä¸»</h3>

        <!-- å›å¾©æ¥­ä¸» modal å…§çš„è¡¨å–®ç‰‡æ®µï¼ˆå·²ç§»é™¤é è¨ˆå¤©æ•¸ï¼‰ -->
        <form id="replyForm" enctype="multipart/form-data">
          <input type="hidden" name="task_id" id="reply_task_id" value="" />
          <div class="task-field">
            <label for="reply_price">å ±åƒ¹</label>
            <input
              id="reply_price"
              name="price"
              type="text"
              placeholder="è¼¸å…¥å ±åƒ¹ï¼ˆä¾‹å¦‚ NT$2000 æˆ– é¢è­°ï¼‰"
              required
            />
          </div>

          <div class="task-field">
            <label for="reply_message">è¨Šæ¯</label>
            <textarea
              id="reply_message"
              name="message"
              placeholder="è¦å‘Šè¨´æ¥­ä¸»çš„å…§å®¹..."
              required
            ></textarea>
          </div>

          <div class="task-field">
            <label for="reply_files">é™„åŠ æª”æ¡ˆï¼ˆåœ–ç‰‡ã€PDFï¼Œå¯å¤šé¸ï¼‰</label>
            <input
              id="reply_files"
              name="reply_files[]"
              type="file"
              multiple
              accept="image/*,application/pdf"
            />
            <div id="replyFileList" class="file-list"></div>
          </div>

          <div class="modal-actions">
            <button
              type="button"
              id="cancelReply"
              class="primary"
              style="background: #eee; color: #333; border: 1px solid #ddd"
            >
              å–æ¶ˆ
            </button>
            <button type="submit" id="submitReply" class="primary">æäº¤</button>
          </div>
        </form>
      </div>
    </div>
    <!-- æ–°å¢ï¼šå›è¦†æ­·å²ç´€éŒ„ modal -->
    <div id="historyModal" class="modal" aria-hidden="true">
      <div class="modal-content" style="max-width: 600px">
        <div class="modal-header">
          <h2>å›è¦†æ­·å²ç´€éŒ„</h2>
          <button
            id="closeHistoryModal"
            style="
              border: none;
              background: none;
              font-size: 24px;
              cursor: pointer;
            "
          >
            &times;
          </button>
        </div>
        <div
          id="historyList"
          style="max-height: 400px; overflow-y: auto; padding: 15px"
        ></div>
      </div>
    </div>
    <!-- æ–°å¢ï¼šå¾…è§£æ±ºäº‹é …èˆ‡èŠå¤©è¦–çª— modal -->
    <div id="issuesModal" class="modal" aria-hidden="true">
      <div
        class="modal-content"
        style="max-width: 900px; padding: 0; overflow: hidden; height: 80vh"
      >
        <button
          class="close-btn"
          id="closeIssuesModal"
          style="z-index: 10; top: 10px; right: 10px"
        >
          &times;
        </button>

        <div style="padding: 15px 20px; border-bottom: 1px solid #eee">
          <h3 style="margin: 0">æ¡ˆä»¶å”ä½œèˆ‡æºé€š</h3>
        </div>

        <div class="chat-layout">
          <div class="chat-sidebar">
            <div class="sidebar-header">
              <h4>å¾…è§£æ±ºäº‹é …åˆ—è¡¨</h4>
            </div>
            <div id="issueListContainer" class="issue-list-container"></div>
          </div>

          <div class="chat-main">
            <div id="chatHistory" class="chat-history"></div>

            <div id="chatInputArea" class="chat-input-area">
              <input type="text" id="chatInput" placeholder="è¼¸å…¥è¨Šæ¯..." />
              <button
                id="chatSendBtn"
                class="primary"
                style="padding: 6px 16px"
              >
                é€å‡º
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- æ–°å¢ï¼šè©•åƒ¹ç™¼æ¡ˆäºº modal -->
    <div id="reviewModal" class="modal">
    <div class="modal-content" style="max-width: 400px;">
        <div class="modal-header">
            <h3 style="margin:0;">ğŸ“œ è©•åƒ¹ç™¼æ¡ˆäºº</h3>
            <span class="close-btn" onclick="toggleModal('reviewModal', false)">&times;</span>
        </div>
        <div class="modal-body" style="padding: 20px;">
            <form id="reviewForm">
                <input type="hidden" id="reviewTaskId">
                <input type="hidden" id="reviewRoleType">
                
                <div style="margin-bottom: 15px;">
                    <label id="label_score_1" style="display:block; font-weight:bold;"></label>
                    <input type="number" name="score_1" id="score_1" min="1" max="5" value="5"> æ˜Ÿ
                </div>
                <div style="margin-bottom: 15px;">
                    <label id="label_score_2" style="display:block; font-weight:bold;"></label>
                    <input type="number" name="score_2" id="score_2" min="1" max="5" value="5"> æ˜Ÿ
                </div>
                <div style="margin-bottom: 15px;">
                    <label id="label_score_3" style="display:block; font-weight:bold;"></label>
                    <input type="number" name="score_3" id="score_3" min="1" max="5" value="5"> æ˜Ÿ
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label style="display:block; font-weight:bold;">æ„è¦‹å›é¥‹ï¼š</label>
                    <textarea name="comment" id="reviewComment" style="width: 100%; height: 60px;"></textarea>
                </div>
                <button type="button" onclick="submitReview()" style="width:100%; padding:10px; background:#ff9800; color:white; border:none; border-radius:4px; cursor:pointer; font-weight:bold;">é€å‡ºè©•åƒ¹</button>
            </form>
        </div>
    </div>
</div>
    <script>
      // session å–å¾—èˆ‡ UI æ›´æ–°ï¼ˆç¶­æŒåŸé‚è¼¯ï¼‰
      fetch("backend/get_session_user.php", { credentials: "same-origin" })
        .then((res) => {
          if (!res.ok) throw new Error("ç„¡æ³•å–å¾— session");
          return res.json();
        })
        .then((data) => {
          window.currentUserId = String(data.user_id || "");
          const roleEl = document.querySelector(".profile .role");
          const idEl = document.querySelector(".profile .userid");
          if (roleEl) roleEl.textContent = data.username || "æ‰¿åŒ…è€…";
          if (idEl)
            idEl.textContent = data.user_id
              ? `ID:${data.user_id}`
              : "ID:æœªç™»å…¥";
          fetchAndRenderTasks();
        })
        .catch((err) => {
          console.warn("å–å¾— session ä½¿ç”¨è€…å¤±æ•—", err);
          window.currentUserId = "";
          fetchAndRenderTasks();
        });

      const GET_TASKS_URL = "backend/get_cases.php";
      const REPLY_URL = "backend/reply_owner.php"; // æ–°å¢å¾Œç«¯æ¥æ”¶è·¯å¾‘
      const DELETE_TASK_URL = "backend/delete_task.php";

      async function fetchAndRenderTasks() {
        try {
          const resp = await fetch(GET_TASKS_URL);
          if (!resp.ok) {
            const text = await resp.text();
            console.error("å–å¾—ä»»å‹™åˆ—è¡¨å¤±æ•—", resp.status, text);
            alert("ç„¡æ³•å–å¾—ä»»å‹™åˆ—è¡¨ï¼Œè«‹ç¨å¾Œå†è©¦");
            return;
          }
          const data = await resp.json();
          if (!Array.isArray(data)) {
            console.warn("å¾Œç«¯å›å‚³æ ¼å¼éŒ¯èª¤ï¼Œé æœŸç‚ºé™£åˆ—", data);
            alert("è³‡æ–™æ ¼å¼éŒ¯èª¤ï¼Œè«‹è¯çµ¡ç®¡ç†å“¡");
            return;
          }
          window.allTasks = data;
          renderTaskList(data);
        } catch (err) {
          console.error("fetch tasks error", err);
          alert("ç¶²è·¯éŒ¯èª¤ï¼Œç„¡æ³•è¼‰å…¥ä»»å‹™åˆ—è¡¨");
        }
      }

      async function deleteTask(id) {
        if (!confirm("ç¢ºå®šè¦åˆªé™¤é€™ç­†æ¡ˆä»¶å—ï¼Ÿ")) return;
        try {
          const resp = await fetch(DELETE_TASK_URL, {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: `id=${encodeURIComponent(id)}`,
          });
          const result = await resp.json();
          if (result.success) await fetchAndRenderTasks();
          else alert("åˆªé™¤å¤±æ•—ï¼š" + (result.message || "æœªçŸ¥éŒ¯èª¤"));
        } catch (err) {
          console.error("åˆªé™¤éŒ¯èª¤", err);
          alert("ç¶²è·¯éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦");
        }
      }

      // manageContract / contract modal (ä¿ç•™åŸæœ‰)
      let selectedContractor = null;
      let currentTaskIdForAssign = null;
      function manageContract(taskId) {
        currentTaskIdForAssign = taskId;
        fetch("backend/get_intents.php?task_id=" + taskId)
          .then((res) => res.json())
          .then((data) => {
            if (!Array.isArray(data) || data.length === 0) {
              alert("ç›®å‰å°šç„¡äººæå‡ºæ¥æ¡ˆæ„é¡˜");
              return;
            }
            const listEl = document.getElementById("contractList");
            listEl.innerHTML = "";
            data.forEach((user) => {
              const btn = document.createElement("button");
              btn.textContent = user.username;
              btn.className = "primary";
              btn.style.margin = "6px";
              btn.onclick = () => {
                selectedContractor = user.username;
                [...listEl.children].forEach((b) =>
                  b.classList.remove("active")
                );
                btn.classList.add("active");
              };
              listEl.appendChild(btn);
            });
            showContractModal();
          })
          .catch((err) => {
            console.error("å–å¾—æ¥æ¡ˆäººå¤±æ•—", err);
            alert("ç„¡æ³•å–å¾—æ¥æ¡ˆäººè³‡æ–™");
          });
      }
      window.manageContract = manageContract;
      function showContractModal() {
        const modal = document.getElementById("contractModal");
        modal.classList.add("show");
        modal.setAttribute("aria-hidden", "false");
        document.body.style.overflow = "hidden";
      }
      function hideContractModal() {
        const modal = document.getElementById("contractModal");
        modal.classList.remove("show");
        modal.setAttribute("aria-hidden", "true");
        document.body.style.overflow = "";
        selectedContractor = null;
      }
      document
        .getElementById("assignConfirmBtn")
        ?.addEventListener("click", () => {
          if (!selectedContractor || !currentTaskIdForAssign) {
            alert("è«‹å…ˆé¸æ“‡æ¥æ¡ˆäºº");
            return;
          }
          fetch("backend/assign_contractor.php", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: `task_id=${encodeURIComponent(
              currentTaskIdForAssign
            )}&contractor=${encodeURIComponent(selectedContractor)}`,
          })
            .then((res) => res.json())
            .then((data) => {
              if (data.success) {
                alert("âœ… å·²æˆåŠŸæŒ‡æ´¾æ¥æ¡ˆäºº");
                hideContractModal();
                fetchAndRenderTasks();
              } else alert("âŒ æŒ‡æ´¾å¤±æ•—ï¼š" + (data.message || "æœªçŸ¥éŒ¯èª¤"));
            })
            .catch((err) => {
              console.error("æŒ‡æ´¾éŒ¯èª¤", err);
              alert("âš ï¸ ç¶²è·¯éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦");
            });
        });
      document
        .getElementById("closeContractModal")
        ?.addEventListener("click", hideContractModal);

      // renderTaskListï¼šé¡¯ç¤ºå±¬æ–¼æ‰¿åŒ…è€…ï¼ˆcontractor_id = sessionï¼‰çš„æ¡ˆä»¶ï¼Œä¸¦æŠŠå‹•ä½œæ¬„æ”¹ç‚ºå–®ä¸€å›å¾©æŒ‰éˆ•
      function renderTaskList(items) {
        const listEl = document.getElementById("list");
        const emptyState = document.getElementById("empty");
        listEl.innerHTML = "";

        const currentUserId = String(window.currentUserId || "");
        const filtered = items.filter((it) => {
          const contractorId = it.contractor_id ?? it.contractor ?? "";
          return String(contractorId) === currentUserId && currentUserId !== "";
        });

        if (!filtered || filtered.length === 0) {
          emptyState.classList.remove("hidden");
          return;
        }
        emptyState.classList.add("hidden");

        const BASE_UPLOAD_PREFIX = "/web/backend/uploads/";

        filtered.forEach((it) => {
          const item = document.createElement("div");
          item.className = "case-item";

          const avatar = it.avatar || "ğŸ‘¤";
          const username = it.username || it.title || "åŒ¿åä½¿ç”¨è€…";
          const published_at = it.published_at
            ? new Date(it.published_at).toLocaleString()
            : it.created_at
            ? new Date(it.created_at).toLocaleString()
            : "";
          const region = it.region || "ä¸é™";

          // --- é™„ä»¶è§£æé‚è¼¯ (ä¿ç•™åŸæ¨£) ---
          let attachments = [];
          try {
            if (typeof it.attachments === "string" && it.attachments.trim() !== "")
              attachments = JSON.parse(it.attachments);
            else if (Array.isArray(it.attachments))
              attachments = it.attachments;
          } catch (err) {
            console.warn("é™„ä»¶è§£æå¤±æ•—", err, it.attachments);
            attachments = [];
          }

          const normalizeUrl = (a) => {
            if (!a) return null;
            if (a.url && typeof a.url === "string" && a.url.trim() !== "") return a.url;
            let p = a.path || a.file_name || a.filename || a.orig_name || "";
            if (!p) return null;
            p = p.replace(/\\/g, "/").trim();
            if (p.startsWith("/")) p = p.replace(/^\/+/, "");
            if (p.startsWith("uploads/")) {
              return BASE_UPLOAD_PREFIX.replace(/\/$/, "") + "/" + p.replace(/^uploads\//, "");
            }
            return BASE_UPLOAD_PREFIX.replace(/\/$/, "") + "/" + p;
          };

          const imagePreview = attachments
            .map((a) => {
              const mime = a && (a.mime || a.type || "");
              const src = normalizeUrl(a);
              const name = a && (a.filename || a.orig_name || a.file_name || "");
              if (!src) return null;
              if (mime && typeof mime === "string") {
                if (!mime.startsWith("image/")) return null;
              }
              return `<img src="${escapeHtml(src)}" alt="${escapeHtml(name)}" style="max-width:100px;max-height:80px;border-radius:6px;margin-top:8px;" />`;
            })
            .filter(Boolean)
            .join("");

          // --- çµæ¡ˆç‹€æ…‹åˆ¤æ–· (æ–°å¢) ---
          const isComp = it.is_completed === true || it.is_completed === "t" || it.is_completed === 1 || String(it.is_completed) === "true";

          // --- å›è¦†ç‹€æ…‹åˆ¤æ–· (ä¿ç•™åŸæ¨£) ---
          const replied =
            it.is_reply === true ||
            it.is_reply === 1 ||
            String(it.is_reply).toLowerCase() === "1" ||
            String(it.is_reply).toLowerCase() === "true";

          // --- æŒ‰éˆ•çµ„é‚è¼¯æ•´åˆ ---
          const issueBtnHtml = `<button class="primary" style="background:#009688; margin-top:8px;" onclick="openIssuesModal(${it.id})">å¾…è§£æ±ºäº‹é …ç®¡ç†</button>`;
          
          // è©•åƒ¹æŒ‰éˆ•ï¼šåƒ…åœ¨çµæ¡ˆæ™‚é¡¯ç¤º
          const reviewBtnHtml = isComp ? `<button class="primary" style="background:#ff9800; margin-top:8px; font-weight:bold;" onclick="openReviewModal(${it.id}, 'freelancer')">â­ è©•åƒ¹ç”²æ–¹</button>` : "";

          let actionsHtml = "";
          if (replied) {
            actionsHtml = `
              <div class="status-wait">ç­‰å¾…æ¥­ä¸»å›å¾©</div>
              <button class="primary" style="background:#6c757d; margin-top:8px;" onclick="openHistoryModal(${it.id})">å›è¦†æ­·å²</button>
              ${issueBtnHtml}
              ${reviewBtnHtml}
            `;
          } else {
            actionsHtml = `
              <button class="btn-reply" onclick="openReplyModal(${it.id})">å›å¾©æ¥­ä¸»</button>
              <button class="primary" style="background:#6c757d; margin-top:8px;" onclick="openHistoryModal(${it.id})">å›è¦†æ­·å²</button>
              ${issueBtnHtml}
              ${reviewBtnHtml}
            `;
          }

          item.innerHTML = `
            <div style="display:flex;gap:12px;align-items:flex-start">
                <div style="font-size:20px;line-height:1">${avatar}</div>
                <div style="flex:1">
                    <div><strong>${escapeHtml(username)}</strong></div>
                    <div class="case-meta">æ‰¿åŒ…è€… ID: ${escapeHtml(it.contractor_id ?? it.contractor ?? "")}</div>
                    <div class="case-meta">é ç®—: NT$${escapeHtml(it.budget)}</div>
                    <div class="case-meta">åœ°å€: ${escapeHtml(region)}</div>
                    <div class="case-meta">ç™¼ä½ˆ: ${escapeHtml(published_at)}</div>
                    ${imagePreview ? `<div class="case-meta">é™„åœ–ï¼š<br />${imagePreview}</div>` : ""}
                </div>
            </div>
            <div class="actions-column">
                ${actionsHtml}
            </div>
          `;
          listEl.appendChild(item);
        });
      }

      // reply modal è¡Œç‚º
      const replyModal = document.getElementById("replyModal");
      const replyForm = document.getElementById("replyForm");
      const replyFiles = document.getElementById("reply_files");
      const replyFileList = document.getElementById("replyFileList");
      const replyTaskIdInput = document.getElementById("reply_task_id");
      const closeReplyModalBtn = document.getElementById("closeReplyModal");
      const cancelReplyBtn = document.getElementById("cancelReply");

      function openReplyModal(taskId) {
        replyTaskIdInput.value = taskId;
        showReplyModal();
      }
      function showReplyModal() {
        replyModal.classList.add("show");
        replyModal.setAttribute("aria-hidden", "false");
        document.body.style.overflow = "hidden";
        // focus first input
        document.getElementById("reply_price").focus();
      }
      function hideReplyModal() {
        replyModal.classList.remove("show");
        replyModal.setAttribute("aria-hidden", "true");
        document.body.style.overflow = "";
        replyForm.reset();
        replyFileList.innerHTML = "";
      }
      closeReplyModalBtn?.addEventListener("click", hideReplyModal);
      cancelReplyBtn?.addEventListener("click", hideReplyModal);
      replyModal.addEventListener("click", (e) => {
        if (e.target === replyModal) hideReplyModal();
      });
      // ç¢ºä¿ DOM è¼‰å…¥å¾Œæ‰åŸ·è¡Œ
      document.addEventListener("DOMContentLoaded", () => {
        const chatInput = document.getElementById("chatInput");

        // å…ˆæª¢æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨ï¼Œé¿å…å ±éŒ¯
        if (chatInput) {
          chatInput.addEventListener("keypress", (e) => {
            if (e.key === "Enter" && currentSelectedIssueId !== null) {
              const sendBtn = document.getElementById("chatSendBtn");
              if (sendBtn) sendBtn.click();
            }
          });
        } else {
          console.error("æ‰¾ä¸åˆ° id='chatInput' çš„å…ƒç´ ï¼Œè«‹æª¢æŸ¥ HTML");
        }
      });

      // preview reply files
      replyFiles.addEventListener("change", (e) => {
        replyFileList.innerHTML = "";
        const files = Array.from(e.target.files || []);
        files.forEach((f) => {
          const item = document.createElement("div");
          item.className = "file-item";
          if (f.type.startsWith("image/")) {
            const img = document.createElement("img");
            const reader = new FileReader();
            reader.onload = (ev) => {
              img.src = ev.target.result;
            };
            reader.readAsDataURL(f);
            item.appendChild(img);
          } else {
            const ext = f.name.split(".").pop();
            const placeholder = document.createElement("div");
            placeholder.style.height = "64px";
            placeholder.style.display = "flex";
            placeholder.style.alignItems = "center";
            placeholder.style.justifyContent = "center";
            placeholder.style.background = "#fafafa";
            placeholder.textContent = ext.toUpperCase();
            item.appendChild(placeholder);
          }
          const name = document.createElement("div");
          name.className = "fname";
          name.textContent = f.name;
          item.appendChild(name);
          replyFileList.appendChild(item);
        });
      });

      // submit reply -> å°‡è³‡æ–™å¯«å…¥ DBï¼ˆPOST åˆ° backend/reply_owner.phpï¼‰
      replyForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const submitBtn = document.getElementById("submitReply");
        submitBtn.disabled = true;
        submitBtn.textContent = "æäº¤ä¸­...";

        try {
          const fd = new FormData(replyForm);
          // å¸¶ä¸Š session user idï¼ˆè‹¥æœ‰ï¼‰
          if (window.currentUserId)
            fd.append("responder_id", window.currentUserId);
          // ç™¼é€åˆ°å¾Œç«¯ï¼Œå¾Œç«¯éœ€è™•ç† attachments ä¸Šå‚³èˆ‡è³‡æ–™åº«å¯«å…¥
          const resp = await fetch(REPLY_URL, {
            method: "POST",
            body: fd,
            credentials: "same-origin",
          });
          if (!resp.ok) {
            const text = await resp.text();
            console.error("å›å¾©é€å‡ºå¤±æ•—", resp.status, text);
            alert("æäº¤å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
            return;
          }
          const result = await resp.json().catch(() => ({ success: resp.ok }));
          if (result && result.success === false) {
            alert("æäº¤å¤±æ•—ï¼š" + (result.message || "æœªçŸ¥éŒ¯èª¤"));
            return;
          }
          alert("å·²æˆåŠŸæäº¤å›å¾©");
          hideReplyModal();
          // åˆ·æ–°åˆ—è¡¨ï¼ˆè‹¥éœ€è¦ï¼‰
          fetchAndRenderTasks();
        } catch (err) {
          console.error("reply submit error", err);
          alert("ç¶²è·¯éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦");
        } finally {
          submitBtn.disabled = false;
          submitBtn.textContent = "æäº¤";
        }
      });
      // --- æ–°å¢ï¼šå›è¦†æ­·å²åŠŸèƒ½ ---
      window.openHistoryModal = async function (taskId) {
        const modal = document.getElementById("historyModal");
        const list = document.getElementById("historyList");

        modal.classList.add("show");
        list.innerHTML =
          "<div style='text-align:center; padding:20px;'>è¼‰å…¥ä¸­...</div>";

        try {
          const resp = await fetch(
            `backend/get_reply_history.php?task_id=${taskId}`
          );
          const data = await resp.json();

          if (data.success && data.history && data.history.length > 0) {
            list.innerHTML = data.history
              .map((h) => {
                let files = [];
                try {
                  // è§£æè³‡æ–™åº«çš„ JSONB å­—ä¸²
                  files =
                    typeof h.attachments === "string"
                      ? JSON.parse(h.attachments || "[]")
                      : h.attachments || [];
                } catch (e) {
                  files = [];
                }

                return `
                <div style="border:1px solid #ddd; padding:15px; margin-bottom:12px; border-radius:8px; background:#fff; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                    <div style="display:flex; justify-content:space-between; color:#888; font-size:12px; border-bottom:1px solid #eee; padding-bottom:5px; margin-bottom:10px;">
                        <span>ç‰ˆæœ¬: <strong>V${h.version_num}</strong></span>
                        <span>æ™‚é–“: ${h.created_at}</span>
                    </div>
                    <div style="margin-bottom:8px;">
                        <span style="background:#e8f0fe; color:#1a73e8; padding:2px 6px; border-radius:4px; font-weight:bold;">
                            é‡‘é¡: NT$${parseFloat(h.price).toLocaleString()}
                        </span>
                    </div>
                    <div style="font-size:14px; color:#444; line-height:1.5; background:#fcfcfc; padding:8px; border-radius:4px;">
                        ${
                          h.content
                            ? h.content.replace(/\n/g, "<br>")
                            : "<i>ç„¡èªªæ˜å…§å®¹</i>"
                        }
                    </div>
                    <div style="margin-top:12px; display:flex; flex-wrap:wrap; gap:8px;">
                        ${files
                          .map((f) => {
                            // é—œéµä¿®æ­£ï¼šåˆ¤æ–· f æ˜¯å¦ç‚ºç‰©ä»¶ï¼Œå–å…¶ path å±¬æ€§
                            const filePath =
                              typeof f === "object" && f !== null ? f.path : f;
                            const fileName =
                              typeof f === "object" && f !== null
                                ? f.orig_name || f.filename
                                : "ä¸‹è¼‰é™„ä»¶";

                            // åˆ¤æ–·è·¯å¾‘æ˜¯å¦å·²ç¶“åŒ…å« backend/ï¼Œé¿å…é‡è¤‡ç–ŠåŠ 
                            const finalHref = filePath.startsWith("backend/")
                              ? filePath
                              : `backend/${filePath}`;

                            return `
                            <a href="${finalHref}" target="_blank" download="${fileName}" 
                               style="display:inline-flex; align-items:center; padding:5px 12px; background:#34a853; color:white; border-radius:20px; text-decoration:none; font-size:12px; transition: background 0.2s;">
                               <span style="margin-right:4px;">ğŸ“¥</span> ${fileName}
                            </a>`;
                          })
                          .join("")}
                        ${
                          files.length === 0
                            ? '<span style="color:#ccc; font-size:12px;">ç„¡é™„ä»¶</span>'
                            : ""
                        }
                    </div>
                </div>`;
              })
              .join("");
          } else {
            list.innerHTML =
              "<div style='text-align:center; padding:20px; color:#888;'>ç›®å‰å°šç„¡æ­·å²ç´€éŒ„ã€‚</div>";
          }
        } catch (err) {
          console.error("Load history error:", err);
          list.innerHTML =
            "<div style='text-align:center; padding:20px; color:red;'>è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¢ºèªç¶²è·¯é€£ç·šæˆ–ç¨å¾Œå†è©¦ã€‚</div>";
        }
      };

      // é—œé–‰å½ˆçª—é‚è¼¯
      // 1. ç¶å®šé—œé–‰æŒ‰éˆ•äº‹ä»¶ (åŸæœ¬çš„éƒ¨åˆ†ï¼ŒåŠ ä¸Šå®‰å…¨æª¢æŸ¥)
      const closeHistoryBtn = document.getElementById("closeHistoryModal");
      if (closeHistoryBtn) {
        closeHistoryBtn.onclick = () => {
          document.getElementById("historyModal").classList.remove("show");
          document.body.style.overflow = ""; // æ¢å¾©é é¢æ»¾å‹•
        };
      }

      // 2. å¼·åŒ–åŠŸèƒ½ï¼šé»æ“Šå½ˆçª—å¤–éƒ¨(èƒŒæ™¯é®ç½©)ä¹Ÿå¯ä»¥é—œé–‰
      const historyModal = document.getElementById("historyModal");
      if (historyModal) {
        historyModal.onclick = (e) => {
          // å¦‚æœé»æ“Šçš„æ˜¯ modal æœ¬èº«(èƒŒæ™¯)ï¼Œè€Œä¸æ˜¯å…§å®¹å€åŸŸï¼Œå°±é—œé–‰
          if (e.target === historyModal) {
            historyModal.classList.remove("show");
            document.body.style.overflow = "";
          }
        };
      }

      // simple XSS escape
      function escapeHtml(str) {
        if (!str && str !== 0) return "";
        return String(str)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#39;");
      }

      // init fetch when no session result
      (function init() {
        if (!window.currentUserId) fetchAndRenderTasks();
      })();

      // 1. å…¨åŸŸè®Šæ•¸å®£å‘Š
      let allIssues = []; // å„²å­˜å¾ API æŠ“å–çš„æ‰€æœ‰äº‹é …
      let currentSelectedIssueId = null; // ç›®å‰é¸ä¸­çš„äº‹é …è³‡æ–™åº« ID
      let currentIssueTaskId = null; // ç›®å‰å°ˆæ¡ˆçš„ ID

      const BASE_API_URL = "backend/issue.php";
      // å®šç¾© API è·¯å¾‘ (è«‹ç¢ºä¿èˆ‡å¾Œç«¯ä¸€è‡´)
      const GET_ISSUES_URL = `${BASE_API_URL}?action=issues/list`;
      const GET_COMMENTS_URL = `${BASE_API_URL}?action=issues/comments`;
      const CREATE_COMMENT_URL = `${BASE_API_URL}?action=issue/comment/create`;

      // 2. ç•¶ DOM è¼‰å…¥å®Œæˆå¾ŒåŸ·è¡Œçš„é‚è¼¯
      document.addEventListener("DOMContentLoaded", () => {
        // ç¶å®šé—œé–‰å½ˆçª—äº‹ä»¶
        const closeBtn = document.getElementById("closeIssuesModal");
        if (closeBtn) {
          closeBtn.onclick = () => {
            const modal = document.getElementById("issuesModal");
            if (modal) {
              modal.style.display = "none";
              document.body.style.overflow = ""; // æ¢å¾©æ²å‹•
            }
          };
        }

        // ç¶å®šç™¼é€æŒ‰éˆ•äº‹ä»¶
        const chatSendBtn = document.getElementById("chatSendBtn");
        if (chatSendBtn) {
          chatSendBtn.onclick = handleSendMessage;
        }

        // ç¶å®š Enter éµäº‹ä»¶
        const chatInput = document.getElementById("chatInput");
        if (chatInput) {
          chatInput.addEventListener("keypress", (e) => {
            if (e.key === "Enter") {
              handleSendMessage();
            }
          });
        }
      });

      // 3. å½ˆçª—é–‹å•Ÿå‡½å¼ (æ›è¼‰åˆ° window ç¢ºä¿ HTML onclick æŠ“å¾—åˆ°)
      window.openIssuesModal = async function (taskId) {
        console.log("è§¸ç™¼å½ˆçª—, taskId:", taskId);
        currentIssueTaskId = taskId;

        const modal = document.getElementById("issuesModal");
        if (modal) {
          // 1. å¼·åˆ¶é¡¯ç¤ºå½ˆçª—
          modal.style.setProperty("display", "flex", "important");
          modal.style.visibility = "visible";
          modal.style.opacity = "1";

          // 2. è®“èƒŒæ™¯ä¸èƒ½æ²å‹•
          document.body.style.overflow = "hidden";

          // 3. æŠ“å–è³‡æ–™
          await fetchAndRenderIssues(taskId);

          // 4. åˆå§‹åŒ–å³å´ç•«é¢
          renderChatHistory();
        } else {
          alert("æ‰¾ä¸åˆ° id='issuesModal' çš„ HTML å…ƒç´ ï¼");
        }
      };

      // 4. æŠ“å–äº‹é …åˆ—è¡¨
      async function fetchAndRenderIssues(taskId) {
        try {
          const resp = await fetch(`${GET_ISSUES_URL}&project_id=${taskId}`);
          const data = await resp.json();
          if (data.success) {
            allIssues = data.issues || [];
            renderIssueList(allIssues);
          }
        } catch (err) {
          console.error("è¼‰å…¥åˆ—è¡¨å¤±æ•—:", err);
        }
      }

      // 5. æ¸²æŸ“å·¦å´åˆ—è¡¨
      function renderIssueList(issues) {
        const container = document.getElementById("issueListContainer");
        if (!container) return;

        if (!issues || issues.length === 0) {
          container.innerHTML = `<div style="padding:20px; color:#999; text-align:center;">æš«ç„¡å¾…è§£æ±ºäº‹é …</div>`;
          return;
        }

        container.innerHTML = "";
        issues.forEach((issue) => {
          const div = document.createElement("div");
          div.className = `issue-item ${
            currentSelectedIssueId == issue.id ? "active" : ""
          }`;
          const statusIcon = issue.issue_is_opened == 1 ? "ğŸ”´" : "ğŸŸ¢";
          div.innerHTML = `<span>${statusIcon} ${issue.title}</span>`;
          div.onclick = () => selectIssue(issue.id);
          container.appendChild(div);
        });
      }

      // 6. é¸æ“‡äº‹é …
      window.selectIssue = async function (issueId) {
        currentSelectedIssueId = issueId;

        // æ›´æ–°å·¦å´åˆ—è¡¨é¸ä¸­æ¨£å¼
        renderIssueList(allIssues);

        // æŠ“å–ç•™è¨€
        await fetchAndRenderComments(issueId);
      };

      // 7. æŠ“å–ç•™è¨€å…§å®¹
      async function fetchAndRenderComments(issueId) {
        try {
          const resp = await fetch(`${GET_COMMENTS_URL}&issue_id=${issueId}`);
          const data = await resp.json();
          if (data.success) {
            renderChatHistory(data.comments);
          }
        } catch (err) {
          console.error("è¼‰å…¥ç•™è¨€å¤±æ•—:", err);
        }
      }

      // 8. æ¸²æŸ“å°è©±å€åŸŸ
      function renderChatHistory(comments = []) {
        const historyContainer = document.getElementById("chatHistory");
        const inputArea = document.getElementById("chatInputArea");
        if (!historyContainer) return;

        historyContainer.innerHTML = "";

        if (currentSelectedIssueId === null) {
          historyContainer.innerHTML = `<div class="chat-prompt">è«‹å¾å·¦å´åˆ—è¡¨é¸æ“‡äº‹é …ä»¥æŸ¥çœ‹è¨è«–ã€‚</div>`;
          if (inputArea) inputArea.style.display = "none";
          return;
        }

        // ğŸ’¡ é—œéµï¼šæ ¹æ“š allIssues ä¸­çš„ç‹€æ…‹æ±ºå®šæ˜¯å¦é¡¯ç¤ºè¼¸å…¥æ¡†
        const currentIssue = allIssues.find(
          (i) => i.id == currentSelectedIssueId
        );
        if (inputArea) {
          const isOpen =
            currentIssue &&
            (currentIssue.issue_is_opened == 1 ||
              currentIssue.issue_is_opened == true);
          inputArea.style.display = isOpen ? "flex" : "none";
        }

        // æ¸²æŸ“è¨Šæ¯æ³¡æ³¡
        if (comments.length === 0) {
          historyContainer.innerHTML = `<div style="text-align:center; color:#999; margin:20px;">å°šç„¡è¨è«–ç´€éŒ„ã€‚</div>`;
        } else {
          comments.forEach((c) => {
            const isMe = String(c.user_id) === String(window.currentUserId);
            const msgDiv = document.createElement("div");
            msgDiv.className = `chat-message ${
              isMe ? "msg-right" : "msg-left"
            }`;
            msgDiv.textContent = c.content;
            historyContainer.appendChild(msgDiv);
          });
        }

        historyContainer.scrollTop = historyContainer.scrollHeight;
      }

      // 9. ç™¼é€ç•™è¨€è™•ç† (æ‰¿åŒ…è€…å°ˆç”¨ï¼šç§»é™¤çµæ¡ˆåŠŸèƒ½)
      async function handleSendMessage() {
        const input = document.getElementById("chatInput");
        if (!input) return;

        const content = input.value.trim();
        if (!currentSelectedIssueId || !content) return;

        // æ‰¿åŒ…è€…ä¸åˆ¤æ–·ã€ŒçµæŸissueã€ï¼Œç›´æ¥ç•¶ä¸€èˆ¬è¨Šæ¯ç™¼é€
        const form = new FormData();
        form.append("issue_id", currentSelectedIssueId);
        form.append("content", content);

        try {
          const resp = await fetch(CREATE_COMMENT_URL, {
            method: "POST",
            body: form,
          });
          const data = await resp.json();
          if (data.success) {
            input.value = "";
            await fetchAndRenderComments(currentSelectedIssueId);
          } else {
            alert("ç™¼é€å¤±æ•—ï¼š" + data.message);
          }
        } catch (err) {
          console.error("ç™¼é€å‡ºéŒ¯:", err);
        }
      }

      // è©•åƒ¹ç³»çµ±ï¼šé–‹å•Ÿå½ˆçª—
window.openReviewModal = function(taskId, role) {
    const modal = document.getElementById("reviewModal");
    const label1 = document.getElementById("label_score_1");
    const label2 = document.getElementById("label_score_2");
    const label3 = document.getElementById("label_score_3");

    // é˜²éŒ¯æª¢æŸ¥ï¼šå¦‚æœæ‰¾ä¸åˆ°å…ƒç´ å°±å ±è­¦ä¸¦é€€å‡ºï¼Œä¸æœƒå°è‡´æ•´å€‹é é¢æ›æ‰
    if (!modal || !label1 || !label2 || !label3) {
        console.error("éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°è©•åƒ¹å½ˆçª—çš„ HTML å…ƒç´ ï¼Œè«‹æª¢æŸ¥ ID æ˜¯å¦æ­£ç¢ºã€‚");
        alert("ç³»çµ±éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°è©•åƒ¹ä»‹é¢");
        return;
    }

    document.getElementById("reviewTaskId").value = taskId;
    document.getElementById("reviewRoleType").value = role;

    // è¨­å®šæ–‡å­—
    label1.innerText = "éœ€æ±‚åˆç†æ€§ï¼š";
    label2.innerText = "é©—æ”¶é›£åº¦ï¼š";
    label3.innerText = "åˆä½œæ…‹åº¦ï¼š";

    // ä½¿ç”¨æ‚¨ç¾æœ‰çš„ toggleModal
    if (typeof toggleModal === "function") {
        toggleModal("reviewModal", true);
    } else {
        modal.style.display = "flex";
    }
};

// è©•åƒ¹ç³»çµ±ï¼šæäº¤å¾Œç«¯
async function submitReview() {
    const fd = new FormData(document.getElementById("reviewForm"));
    // è£œé½Šä¸€äº›æ‰‹å‹•æ¬„ä½ (è‹¥ form å…§æ²’æœ‰)
    fd.append("task_id", document.getElementById("reviewTaskId").value);
    fd.append("role_type", "freelancer");

    try {
        const resp = await fetch('backend/submit_review.php', { method: 'POST', body: fd });
        const result = await resp.json();
        if (result.success) {
            alert("è©•åƒ¹æˆåŠŸï¼");
            toggleModal("reviewModal", false);
            // é‡æ–°è®€å–ä»»å‹™åˆ—è¡¨ä»¥æ›´æ–°ç‹€æ…‹ (å¯é¸)
            if (window.fetchAndRenderTasks) fetchAndRenderTasks();
        } else {
            alert("æäº¤å¤±æ•—ï¼š" + result.message);
        }
    } catch (err) {
        console.error(err);
        alert("ç¶²è·¯é€£ç·šå¤±æ•—");
    }
}

// é€šç”¨çš„å½ˆçª—é–‹é—œå‡½å¼
function toggleModal(modalId, show) {
  const modal = document.getElementById(modalId);
  if (!modal) return;
  modal.style.display = show ? "flex" : "none";
}
    </script>
  </body>
</html>
