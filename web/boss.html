<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Tasker æ¡ˆä»¶ç®¡ç†</title>
    <style>
      :root {
        --sidebar-w: 220px;
        --accent: #e53935;
        --brand: #4285f4;
        --muted: #777;
        --bg: #f7f8fb;
        --card: #fff;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: system-ui, -apple-system, "Segoe UI", Roboto,
          "Noto Sans TC", sans-serif;
        background: var(--bg);
        color: #111;
      }
      .app {
        display: flex;
        min-height: 100vh;
      }
      .sidebar {
        width: var(--sidebar-w);
        background: linear-gradient(180, #fff, #f2f4f8);
        border-right: 1px solid #e6e9ef;
        padding: 20px;
      }
      .profile {
        padding: 12px;
        background: transparent;
        border-radius: 8px;
        margin-bottom: 12px;
      }
      .profile .role {
        font-weight: 600;
        color: var(--brand);
      }
      .profile .userid {
        margin-top: 6px;
        color: #333;
        font-size: 14px;
      }
      .profile .edit {
        display: inline-block;
        margin-top: 8px;
        font-size: 13px;
        color: var(--muted);
        text-decoration: none;
      }
      .menu ul {
        list-style: none;
        padding: 0;
        margin: 12px 0;
      }
      .menu li {
        padding: 10px;
        border-radius: 6px;
        cursor: pointer;
        color: #333;
        margin-bottom: 6px;
      }
      .menu li.active {
        background: #eef6ff;
        color: var(--brand);
        font-weight: 600;
      }

      .main {
        flex: 1;
        padding: 28px;
      }
      .main-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 18px;
      }
      .main-header h1 {
        margin: 0;
        font-size: 20px;
      }
      .tabs {
        display: flex;
        gap: 8px;
      }
      .tab {
        padding: 8px 14px;
        border-radius: 6px;
        border: 1px solid transparent;
        background: #eee;
        cursor: pointer;
      }
      .tab.active {
        background: var(--brand);
        color: #fff;
        border-color: rgba(0, 0, 0, 0.05);
      }

      .content {
        background: transparent;
      }
      .empty-state {
        background: var(--card);
        padding: 48px;
        border-radius: 10px;
        text-align: center;
        color: var(--muted);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.04);
      }
      .empty-state .empty-text {
        font-size: 18px;
        margin: 18px 0;
      }
      .primary {
        background: var(--accent);
        color: #fff;
        border: none;
        padding: 10px 16px;
        border-radius: 8px;
        cursor: pointer;
      }
      .hidden {
        display: none;
      }

      .case-list {
        display: grid;
        gap: 12px;
      }
      .case-item {
        background: var(--card);
        padding: 14px;
        border-radius: 8px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border: 1px solid #eef2f6;
      }
      .case-meta {
        color: var(--muted);
        font-size: 13px;
      }
      dialog {
        border: none;
        border-radius: 10px;
        padding: 20px;
      }
      label {
        display: block;
        margin: 10px 0;
        font-size: 14px;
      }
      input,
      textarea {
        width: 100%;
        padding: 8px;
        border: 1px solid #d7dbe0;
        border-radius: 6px;
      }
      .modal-actions {
        display: flex;
        gap: 8px;
        justify-content: flex-end;
        margin-top: 12px;
      }
      /* modal å…±ç”¨ */
      /* Modal èƒŒæ™¯é®ç½© */
      /* Modal èƒŒæ™¯é®ç½© */
      .modal {
        display: none; /* åˆå§‹éš±è— */
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.6);
        z-index: 1000;
        justify-content: center;
        align-items: center;
        overflow: auto;
      }

      /* é¡¯ç¤ºæ™‚åŠ ä¸Šå‹•ç•« class */
      .modal.show {
        display: flex;
      }

      /* Modal å…§å®¹å®¹å™¨ï¼šå‹•ç•«åˆå§‹ç‹€æ…‹ */
      .modal-content {
        background-color: #fff;
        padding: 2rem;
        border-radius: 8px;
        max-width: 600px;
        width: 90%;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        position: relative;
        transform: translateY(50px);
        opacity: 0;
        transition: transform 0.4s ease, opacity 0.4s ease;
      }

      /* é¡¯ç¤ºå‹•ç•«ï¼šç”±ä¸‹å¾€ä¸Šæ·¡å…¥ */
      .modal.show .modal-content {
        transform: translateY(0);
        opacity: 1;
      }

      /* é—œé–‰å‹•ç•«ï¼šç”±ä¸Šå¾€ä¸‹æ·¡å‡º */
      .modal.hide .modal-content {
        transform: translateY(-50px);
        opacity: 0;
      }

      /* é—œé–‰æŒ‰éˆ• */
      .close-btn {
        position: absolute;
        top: 1rem;
        right: 1rem;
        font-size: 1.5rem;
        background: none;
        border: none;
        cursor: pointer;
      }

      /* è¡¨å–®æ¬„ä½æ’ç‰ˆ */
      .task-field {
        margin-bottom: 1.5rem;
      }

      .form-row {
        display: flex;
        gap: 1rem;
      }

      .col {
        flex: 1;
      }

      .submit-row {
        text-align: center;
      }

      .btn-submit {
        background-color: #007bff;
        color: white;
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }

      .btn-submit:hover {
        background-color: #0056b3;
      }

      /* é™„åŠ æª”æ¡ˆæ¸…å–®æ¨£å¼ */
      .file-list {
        margin-top: 0.5rem;
        font-size: 0.9rem;
        color: #555;
      }
      .file-item {
        display: inline-block;
        vertical-align: top;
        width: 120px;
        margin: 8px;
        padding: 6px;
        border: 1px solid #e6e9ef;
        border-radius: 6px;
        background: #fff;
        text-align: center;
        font-size: 12px;
        color: #333;
      }
      .file-item img {
        display: block;
        max-width: 100%;
        max-height: 80px;
        object-fit: cover;
        margin-bottom: 6px;
        border-radius: 4px;
      }
      .file-item .fname {
        display: block;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      /* æ¥æ¡ˆç®¡ç† modal è£¡è¢«é¸åˆ°çš„æŒ‰éˆ•æ¨£å¼ */
      #contractList button.active {
        background-color: #2e7d32 !important; /* ç¶ è‰² */
        color: #fff !important;
        border: 1px solid rgba(0, 0, 0, 0.06) !important;
        box-shadow: 0 2px 6px rgba(46, 125, 50, 0.18);
      }
      #contractList button {
        background: #fff;
        color: #333;
        border: 1px solid #ddd;
        padding: 8px 10px;
        border-radius: 6px;
        cursor: pointer;
      }
      .menu li a {
        color: inherit; /* ä½¿ç”¨çˆ¶å…ƒç´ æ–‡å­—è‰² -> çœ‹èµ·ä¾†åƒä¸€èˆ¬æ–‡å­— */
        text-decoration: none; /* å–æ¶ˆåº•ç·š */
        cursor: pointer; /* é¡¯ç¤ºå¯é»ç‹€æ…‹ï¼ˆhand pointerï¼‰ */
        background: none;
        padding: 0;
        border: none;
        display: inline-block;
      }
      /* --- æ–°å¢ï¼šå¾…è§£æ±ºäº‹é …èˆ‡èŠå¤©è¦–çª—æ¨£å¼ --- */
      /* è®“æ–°çš„å½ˆçª—å±¤ç´šæ¯”åŸæœ¬çš„é«˜ï¼Œç¢ºä¿è“‹åœ¨ä¸Šé¢ */
      #issuesModal {
        z-index: 2000;
      }

      .chat-layout {
        display: flex;
        height: 60vh;
        border: 1px solid #e6e9ef;
        border-radius: 8px;
        overflow: hidden;
        margin-top: 10px;
      }

      /* å·¦å´ï¼šå¾…è§£æ±ºäº‹é … */
      .chat-sidebar {
        width: 280px;
        background: #f7f8fb;
        border-right: 1px solid #e6e9ef;
        display: flex;
        flex-direction: column;
      }

      .sidebar-header {
        padding: 15px;
        border-bottom: 1px solid #e6e9ef;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #fff;
      }

      .sidebar-header h4 {
        margin: 0;
        font-size: 16px;
        color: #333;
      }

      /* åœ“å½¢ç„¡æ–‡å­—åŠ è™ŸæŒ‰éˆ• */
      .add-issue-btn {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        background: var(--brand);
        color: #fff;
        border: none;
        font-size: 20px;
        line-height: 28px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0;
      }
      .add-issue-btn:hover {
        background: #3367d6;
      }

      .issue-list-container {
        flex: 1;
        overflow-y: auto;
        padding: 10px;
      }

      .issue-item {
        background: #fff;
        padding: 10px;
        border-radius: 6px;
        margin-bottom: 8px;
        border: 1px solid #e6e9ef;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 14px;
      }

      .issue-done-btn {
        background: #fff;
        border: 1px solid #4caf50;
        color: #4caf50;
        border-radius: 4px;
        font-size: 12px;
        padding: 4px 8px;
        cursor: pointer;
      }
      .issue-done-btn:hover {
        background: #4caf50;
        color: #fff;
      }

      /* å³å´ï¼šèŠå¤©ä»‹é¢ */
      .chat-main {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: #fff;
      }

      .chat-history {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        background: #fafafa;
      }

      .chat-message {
        margin-bottom: 15px;
        max-width: 80%;
        padding: 10px 14px;
        border-radius: 12px;
        font-size: 14px;
        line-height: 1.4;
        position: relative;
      }

      .msg-left {
        background: #fff;
        border: 1px solid #e6e9ef;
        align-self: flex-start;
        margin-right: auto;
        border-bottom-left-radius: 2px;
      }

      .msg-right {
        background: #eef6ff;
        color: #1a73e8;
        align-self: flex-end;
        margin-left: auto;
        border-bottom-right-radius: 2px;
        float: right;
        clear: both;
      }

      .chat-input-area {
        padding: 10px;
        border-top: 1px solid #e6e9ef;
        gap: 10px;
        background: #fff;
      }

      .chat-input-area input {
        flex: 1;
        border: 1px solid #d7dbe0;
        border-radius: 20px;
        padding: 8px 16px;
        outline: none;
      }
      /* æ–°å¢ï¼šæœªé¸æ“‡äº‹é …æ™‚çš„æç¤ºæ¨£å¼ */
      .chat-prompt {
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        color: #999;
        background: #fff;
        text-align: center;
        padding: 20px;
      }
      .status-btn:disabled {
        filter: grayscale(1); /* è®Šæˆç°è‰² */
        box-shadow: none; /* ç§»é™¤é™°å½± */
        transform: none !important; /* ç§»é™¤ä»»ä½•ç¸®æ”¾æ•ˆæœ */
      }
    </style>
    <script>
      // å–å¾— session ä½¿ç”¨è€…è³‡æ–™ä¸¦æŠŠå´é‚Šæ¬„é¡¯ç¤ºæ›´æ–°ï¼ˆç­‰ DOM å»ºç«‹å¾Œå†æ›´æ–° DOMï¼‰
      function applySessionToUI(data) {
        const uid = data.user_id ?? "";
        const uname = data.username ?? "";

        window.currentUserId = String(uid);
        window.currentUsername = String(uname);

        const roleEl = document.querySelector(".profile .role");
        const idEl = document.querySelector(".profile .userid");

        if (roleEl) roleEl.textContent = uname ? uname : "è³£ä¸»";
        if (idEl) idEl.textContent = uid ? `ID:${uid}` : "ID:æœªç™»å…¥";
      }

      // å…ˆå‘å¾Œç«¯æ‹¿ sessionï¼ˆéåŒæ­¥ï¼‰ï¼Œæ‹¿åˆ°å¾Œå„²å­˜è³‡æ–™ï¼›ä½†åªæœ‰åœ¨ DOM æº–å‚™å¥½æ™‚æ‰å˜—è©¦æ›´æ–° UI
      fetch("backend/get_session_user.php", { credentials: "same-origin" })
        .then((res) => {
          if (!res.ok) throw new Error("ç„¡æ³•å–å¾— session");
          return res.json();
        })
        .then((data) => {
          // è‹¥ DOM å·²å°±ç·’ï¼Œç«‹å³æ›´æ–°ï¼›å¦å‰‡æ’å…¥ DOMContentLoaded å¾ŒåŸ·è¡Œ
          if (document.readyState === "loading") {
            window.__sessionData = data;
            window.addEventListener(
              "DOMContentLoaded",
              () => {
                if (window.__sessionData) {
                  applySessionToUI(window.__sessionData);
                  window.__sessionData = null;
                }
                if (typeof fetchAndRenderTasks === "function")
                  fetchAndRenderTasks();
              },
              { once: true }
            );
          } else {
            applySessionToUI(data);
            if (typeof fetchAndRenderTasks === "function")
              fetchAndRenderTasks();
          }
        })
        .catch((err) => {
          console.warn("å–å¾— session ä½¿ç”¨è€…å¤±æ•—", err);
          // è‹¥ DOM é‚„æ²’æº–å‚™å¥½ï¼Œç­‰ DOMContentLoaded å†é¡¯ç¤ºé è¨­æ–‡å­—
          if (document.readyState === "loading") {
            window.addEventListener(
              "DOMContentLoaded",
              () => {
                const roleEl = document.querySelector(".profile .role");
                const idEl = document.querySelector(".profile .userid");
                if (roleEl && roleEl.textContent.trim() === "")
                  roleEl.textContent = "è³£ä¸»";
                if (idEl && idEl.textContent.trim() === "")
                  idEl.textContent = "ID:æœªç™»å…¥";
              },
              { once: true }
            );
          } else {
            const roleEl = document.querySelector(".profile .role");
            const idEl = document.querySelector(".profile .userid");
            if (roleEl && roleEl.textContent.trim() === "")
              roleEl.textContent = "è³£ä¸»";
            if (idEl && idEl.textContent.trim() === "")
              idEl.textContent = "ID:æœªç™»å…¥";
          }
        });
    </script>
  </head>
  <body>
    <div class="app">
      <aside class="sidebar">
        <div class="profile">
          <div class="role">è³£ä¸»</div>
          <div class="userid">T6205518</div>
          <a class="edit" href="#">ç·¨è¼¯å€‹äººè³‡æ–™</a>
        </div>
        <nav class="menu">
          <ul>
            <li><a href="main.html">ğŸ  é¦–é </a></li>
            <li><a href="tasklist.html">ğŸ“‹ ä»»å‹™åˆ—è¡¨</a></li>
            <li><a href="tasker.html">âš™ï¸ æ‰¿æ¥ä»»å‹™ç®¡ç†</a></li>
          </ul>
        </nav>
      </aside>

      <main class="main">
        <header class="main-header">
          <h1>æ¡ˆä»¶ç®¡ç†</h1>
          <div class="tabs" role="tablist">
            <button class="tab active" data-status="published">åˆŠç™»ä¸­</button>
            <button class="tab" data-status="completed">å·²æˆäº¤</button>
            <button class="tab" data-status="review">å¯©æ ¸ä¸­</button>
            <button class="tab" data-status="rejected">æœªé€šé</button>
          </div>
        </header>

        <section class="content">
          <div id="case-area">
            <!-- ç©ºç‹€æ…‹ -->
            <div class="empty-state hidden" id="empty">
              <div class="illustration" aria-hidden="true"></div>
              <p class="empty-text">æ²’æœ‰åˆŠç™»ä¸­çš„æ¡ˆä»¶</p>
            </div>

            <!-- æ¡ˆä»¶åˆ—è¡¨ -->
            <div id="list" class="case-list"></div>

            <!-- æ°¸é é¡¯ç¤ºçš„åˆŠç™»æŒ‰éˆ• -->
            <div style="text-align: center; margin-top: 24px">
              <button id="publishBtn" class="primary">ç«‹å³åˆŠç™»</button>
            </div>
          </div>
        </section>
      </main>
    </div>

    <div id="newTaskModal" class="modal" aria-hidden="true">
      <div class="modal-content">
        <div class="task-modal">
          <button class="close-btn" id="closeNewTask">&times;</button>
          <h2>åˆŠç™»å¤–åŒ…ï¼Œäº«ä¸‰å¤§å„ªå‹¢</h2>

          <form id="newTaskForm" enctype="multipart/form-data">
            <div class="task-field">
              <label for="taskTitle">æ‚¨çš„éœ€æ±‚æ˜¯ä»€éº¼ï¼Ÿ</label>
              <input
                id="taskTitle"
                name="title"
                type="text"
                placeholder="æ‚¨çš„éœ€æ±‚æ˜¯ä»€éº¼ï¼Ÿ"
                required
              />
            </div>

            <div class="form-row">
              <div class="col task-field">
                <label for="taskBudget">é ç®—</label>
                <input
                  id="taskBudget"
                  name="budget"
                  type="text"
                  placeholder="è¼¸å…¥é ç®—ï¼Œä¾‹å¦‚ NT$1200 æˆ– é¢è­°"
                />
              </div>
              <div class="col task-field">
                <label for="taskRegion">åœ°å€</label>
                <select id="taskRegion" name="region" required>
                  <option value="">è«‹é¸æ“‡åœ°å€</option>
                  <option value="è‡ºåŒ—å¸‚">è‡ºåŒ—å¸‚</option>
                  <option value="æ–°åŒ—å¸‚">æ–°åŒ—å¸‚</option>
                  <option value="æ¡ƒåœ’å¸‚">æ¡ƒåœ’å¸‚</option>
                  <option value="è‡ºä¸­å¸‚">è‡ºä¸­å¸‚</option>
                  <option value="è‡ºå—å¸‚">è‡ºå—å¸‚</option>
                  <option value="é«˜é›„å¸‚">é«˜é›„å¸‚</option>
                  <option value="å®œè˜­ç¸£">å®œè˜­ç¸£</option>
                  <option value="æ–°ç«¹ç¸£">æ–°ç«¹ç¸£</option>
                  <option value="è‹—æ —ç¸£">è‹—æ —ç¸£</option>
                  <option value="å½°åŒ–ç¸£">å½°åŒ–ç¸£</option>
                  <option value="å—æŠ•ç¸£">å—æŠ•ç¸£</option>
                  <option value="é›²æ—ç¸£">é›²æ—ç¸£</option>
                  <option value="å˜‰ç¾©ç¸£">å˜‰ç¾©ç¸£</option>
                  <option value="å±æ±ç¸£">å±æ±ç¸£</option>
                  <option value="èŠ±è“®ç¸£">èŠ±è“®ç¸£</option>
                  <option value="è‡ºæ±ç¸£">è‡ºæ±ç¸£</option>
                  <option value="æ¾æ¹–ç¸£">æ¾æ¹–ç¸£</option>
                  <option value="åŸºéš†ç¸£">åŸºéš†ç¸£</option>
                  <option value="ä¸é™" selected>ä¸é™</option>
                </select>
              </div>
            </div>
            <div class="col task-field">
              <label for="taskClose">çµæ¡ˆæ—¥ï¼ˆé¸å¡«ï¼‰</label>
              <input id="taskClose" name="closed_at" type="date" />
            </div>

            <div class="task-field">
              <label for="taskMeta">ç”¨æ–¼å“ªå€‹æƒ…å¢ƒï¼Œç´°ç¯€èªªæ˜</label>
              <textarea
                id="taskMeta"
                name="description"
                placeholder="æè¿°ç´°ç¯€..."
              ></textarea>
            </div>

            <div class="task-field">
              <label for="taskFiles">é™„åŠ æ–‡ä»¶ï¼ˆåœ–ç‰‡ã€PDF ç­‰ï¼Œå¯å¤šé¸ï¼‰</label>
              <input
                id="taskFiles"
                name="taskFiles[]"
                type="file"
                multiple
                accept="image/*,application/pdf"
              />
              <div id="fileList" class="file-list"></div>
            </div>

            <div class="submit-row">
              <button type="submit" class="btn-submit">ç«‹å³å¤–åŒ…</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div id="contractModal" class="modal" aria-hidden="true">
      <div class="modal-content">
        <button class="close-btn" id="closeContractModal">&times;</button>
        <h3>æ¥æ¡ˆç®¡ç†</h3>
        <div id="contractList" style="margin: 12px 0"></div>
        <div style="text-align: right">
          <button id="assignConfirmBtn" class="primary">âœ… ç¢ºå®šæŒ‡æ´¾</button>
        </div>
      </div>
    </div>

    <!-- Replies Modal -->
    <div id="repliesModal" class="modal" aria-hidden="true">
      <div class="modal-content" style="max-width: 800px">
        <button class="close-btn" id="closeRepliesModal">&times;</button>
        <h3>æŸ¥çœ‹å›å¾©å…§å®¹</h3>
        <div
          id="repliesContainer"
          style="max-height: 60vh; overflow: auto; margin-top: 12px"
        ></div>

        <div class="modal-actions" style="margin-top: 12px">
          <div
            class="action-bar"
            style="margin-top: 15px; display: flex; gap: 10px"
          >
            <button id="openIssuesBtn" class="primary">å¾…è§£æ±ºäº‹é …ç®¡ç†</button>
            <button
              id="openHistoryBtn"
              style="
                background: #673ab7;
                color: white;
                border: none;
                padding: 10px 15px;
                border-radius: 6px;
                cursor: pointer;
                font-weight: bold;
              "
            >
              ğŸ“œ æŸ¥çœ‹å›è¦†æ­·å²
            </button>
          </div>
          <span id="statusBtnContainer"></span>
          <button
            id="replyAcceptBtn"
            class="primary"
            style="background: #4caf50"
          >
            æ¥å—å ±åƒ¹
          </button>
          <button
            id="replyRejectBtn"
            class="primary"
            style="background: #f44336"
          >
            é€€ä»¶
          </button>
          <button id="replyCloseBtn" class="primary" style="background: #777">
            é—œé–‰
          </button>
        </div>
      </div>
    </div>
    <!-- History Modal -->
    <div id="historyModal" class="modal">
      <div class="modal-content" style="max-width: 650px; width: 90%">
        <div class="modal-header">
          <h3 style="margin: 0">ğŸ“œ æ¡ˆä»¶å›è¦†æ­·å²ç´€éŒ„</h3>
          <span
            class="close-btn"
            onclick="window.toggleModal('historyModal', false)"
            >&times;</span
          >
        </div>
        <div
          id="historyList"
          class="modal-body"
          style="max-height: 65vh; overflow-y: auto; padding: 20px"
        ></div>
      </div>
    </div>
    <!-- Issues Modal -->
    <div id="issuesModal" class="modal" aria-hidden="true">
      <div
        class="modal-content"
        style="max-width: 900px; padding: 0; overflow: hidden; height: auto"
      >
        <button
          class="close-btn"
          id="closeIssuesModal"
          style="z-index: 10; top: 10px; right: 10px"
        >
          &times;
        </button>

        <div style="padding: 15px 20px; border-bottom: 1px solid #eee">
          <h3 style="margin: 0">æ¡ˆä»¶å”ä½œèˆ‡æºé€š</h3>
        </div>

        <div class="chat-layout">
          <div class="chat-sidebar">
            <div class="sidebar-header">
              <h4>å¾…è§£æ±ºäº‹é …</h4>
              <button id="addIssueBtn" class="add-issue-btn" title="æ–°å¢äº‹é …">
                +
              </button>
            </div>
            <div id="issueListContainer" class="issue-list-container"></div>
          </div>

          <div class="chat-main">
            <div id="chatHistory" class="chat-history"></div>

            <div id="chatInputArea" class="chat-input-area">
              <input
                type="text"
                id="chatInput"
                placeholder="è¼¸å…¥è¨Šæ¯... (è¼¸å…¥ã€ŒçµæŸissueã€ä»¥é—œé–‰æ­¤è¨è«–)"
              />
              <button
                id="chatSendBtn"
                class="primary"
                style="padding: 6px 16px"
              >
                é€å‡º
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- è©•åƒ¹ Modal -->
    <div id="reviewModal" class="modal" style="display: none">
      <div class="modal-content" style="max-width: 500px">
        <div class="modal-header">
          <h3 id="reviewTitle">å¡«å¯«è©•åƒ¹</h3>
          <span class="close-btn" onclick="toggleModal('reviewModal', false)"
            >&times;</span
          >
        </div>
        <div class="modal-body" style="padding: 20px">
          <form id="reviewForm">
            <input type="hidden" id="reviewTaskId" />
            <input type="hidden" id="reviewRoleType" />
            <div id="dimensionContainer">
              <div class="star-group" style="margin-bottom: 15px">
                <label id="label_score_1">ç¶­åº¦1</label>
                <input
                  type="number"
                  id="score_1"
                  min="1"
                  max="5"
                  value="5"
                  style="width: 50px"
                />
                é¡†æ˜Ÿ
              </div>
              <div class="star-group" style="margin-bottom: 15px">
                <label id="label_score_2">ç¶­åº¦2</label>
                <input
                  type="number"
                  id="score_2"
                  min="1"
                  max="5"
                  value="5"
                  style="width: 50px"
                />
                é¡†æ˜Ÿ
              </div>
              <div class="star-group" style="margin-bottom: 15px">
                <label id="label_score_3">ç¶­åº¦3</label>
                <input
                  type="number"
                  id="score_3"
                  min="1"
                  max="5"
                  value="5"
                  style="width: 50px"
                />
                é¡†æ˜Ÿ
              </div>
            </div>

            <div style="margin-bottom: 15px">
              <label>è³ªæ€§è©•è«–ï¼š</label>
              <textarea
                id="reviewComment"
                style="width: 100%; height: 80px"
                placeholder="å¯«ä¸‹å°é€™æ¬¡åˆä½œçš„çœ‹æ³•..."
              ></textarea>
            </div>

            <button
              type="button"
              onclick="submitReview()"
              class="primary"
              style="width: 100%"
            >
              é€å‡ºè©•åƒ¹
            </button>
          </form>
        </div>
      </div>
    </div>

    <script>
      // å°‡åŸæœ¬çš„ let currentRepliesTaskId = null; æ”¹ç‚ºï¼š
      window.currentRepliesTaskId = null;
      (function () {
        /** --- 1. é…ç½®èˆ‡å…¨åŸŸè®Šæ•¸ --- **/
        const API = {
          TASKS: "backend/get_cases.php",
          CREATE: "backend/create_task.php",
          UPDATE: "backend/update_task.php",
          DELETE: "backend/delete_task.php",
          TOGGLE: "backend/toggle_completed.php",
          INTENTS: "backend/get_intents.php",
          ASSIGN: "backend/assign_contractor.php",
          REPLIES: "backend/get_replies.php",
          ISSUES: "backend/issue.php", // å‡è¨­ç‚ºä¹‹å‰ç¨‹å¼ç¢¼æåˆ°çš„ FETCH_ISSUES_URL
        };
        const BASE_UPLOAD_PREFIX = "/web/backend/uploads/";

        window.allTasks = [];
        let currentTaskId = null;
        let selectedContractor = null;
        let currentRepliesTaskId = null;

        /** --- 2. é€šç”¨å·¥å…·å‡½å¼ --- **/

        // çµ±ä¸€è™•ç† Modal é¡¯ç¤º/éš±è—
        // åŠ ä¸Š window. ç¢ºä¿å…¨åŸŸå¯ç”¨
        window.toggleModal = function (modalId, isShow) {
          const modal = document.getElementById(modalId);
          if (!modal) {
            console.error(`æ‰¾ä¸åˆ° ID ç‚º ${modalId} çš„å½ˆçª—`);
            return;
          }

          if (isShow) {
            modal.style.display = "flex";
            modal.offsetHeight; // å¼·åˆ¶é‡ç¹ª

            modal.classList.add("show");
            modal.classList.remove("hide");
            modal.setAttribute("aria-hidden", "false");
            document.body.style.overflow = "hidden";

            const first = modal.querySelector(
              "input, select, textarea, button:not(.close-btn)"
            );
            if (first) setTimeout(() => first.focus(), 100);
          } else {
            modal.classList.remove("show");
            modal.classList.add("hide");
            modal.setAttribute("aria-hidden", "true");
            document.body.style.overflow = "";

            setTimeout(() => {
              if (modal.classList.contains("hide")) {
                modal.style.display = "none";
                modal.classList.remove("hide");
              }
            }, 400);
          }
        };

        // ä¿®æ­£ï¼šé»æ“Šå½ˆçª—å¤–éƒ¨èƒŒæ™¯è‡ªå‹•é—œé–‰ (é‡è¦ï¼)
        window.addEventListener("click", (e) => {
          // æª¢æŸ¥é»æ“Šçš„ç›®æ¨™æ˜¯ä¸æ˜¯å½ˆçª—æœ¬èº«ï¼ˆé€šå¸¸æ˜¯åŠé€æ˜èƒŒæ™¯å±¤ï¼‰
          if (e.target.classList.contains("modal")) {
            toggleModal(e.target.id, false);
          }
        });

        // çµ±ä¸€è™•ç† API è«‹æ±‚
        async function apiRequest(url, options = {}) {
          try {
            const resp = await fetch(url, {
              credentials: "same-origin",
              ...options,
            });
            if (!resp.ok) throw new Error(`HTTP error! status: ${resp.status}`);
            const data = await resp.json();
            if (data.success === false)
              throw new Error(data.message || "æœªçŸ¥éŒ¯èª¤");
            return data;
          } catch (err) {
            console.error(`API Error (${url}):`, err);
            alert("æ“ä½œå¤±æ•—ï¼š" + err.message);
            return null;
          }
        }

        // æª”æ¡ˆè·¯å¾‘æ¨™æº–åŒ–
        const normalizeUrl = (a) => {
  if (!a) return null;
  // 1. å¦‚æœè³‡æ–™åº«å·²ç¶“æœ‰å®Œæ•´ URL (ç”± create_task.php ç”¢ç”Ÿ)ï¼Œç›´æ¥å›å‚³
  if (a.url && a.url.trim() !== "") {
    // ç¢ºä¿è·¯å¾‘é–‹é ­ç¬¦åˆç›®å‰çš„ç’°å¢ƒ
    return a.url; 
  }
  
  // 2. å¦‚æœæ²’æœ‰ URL æ‰é€²å…¥å‚™æ´é‚è¼¯
  let p = (a.path || a.file_name || a.filename || "").replace(/\\/g, "/").trim();
  if (!p) return null;
  const cleanPath = p.replace(/^(\/|backend\/uploads\/|uploads\/)+/, "");
  return `${BASE_UPLOAD_PREFIX.replace(/\/$/, "")}/${cleanPath}`;
};

        function escapeHtml(str) {
          if (!str && str !== 0) return "";
          return String(str)
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#39;");
        }

        /** --- 3. æ ¸å¿ƒæ¥­å‹™åŠŸèƒ½ --- **/

        // å–å¾—ä¸¦æ¸²æŸ“ä»»å‹™æ¸…å–®
        async function fetchAndRenderTasks() {
          const data = await apiRequest(API.TASKS);
          if (!data || !Array.isArray(data)) return;

          window.allTasks = data;
          const listEl = document.getElementById("list");
          const emptyState = document.getElementById("empty");
          const myTasks = data.filter(
            (it) => String(it.poster_id) === String(window.currentUserId || "")
          );

          listEl.innerHTML = "";
          if (myTasks.length === 0) {
            emptyState.classList.remove("hidden");
            return;
          }
          emptyState.classList.add("hidden");

          myTasks.forEach((it) => {
            const published_at = it.published_at
              ? new Date(it.published_at).toLocaleString()
              : "";

            // è§£æé™„ä»¶åœ–ç‰‡
            let attachments = [];
            try {
              attachments =
                typeof it.attachments === "string"
                  ? JSON.parse(it.attachments)
                  : it.attachments || [];
            } catch (e) {}
            const imgHtml = attachments
              .map((a) => {
                const src = normalizeUrl(a);
                return src && (a.mime || "").startsWith("image/")
                  ? `<img src="${escapeHtml(
                      src
                    )}" style="max-width:100px;max-height:80px;border-radius:6px;margin-top:8px;">`
                  : "";
              })
              .join("");

            const item = document.createElement("div");
            item.className = "case-item";
            item.innerHTML = `
        <div style="display: flex; gap: 12px;">
          <div style="font-size: 20px;">ğŸ‘¤</div>
          <div style="flex: 1">
            <div><strong>${escapeHtml(it.username || it.title)}</strong></div>
            <div class="case-meta">é ç®—: NT$${escapeHtml(
              it.budget
            )} | åœ°å€: ${escapeHtml(it.region || "ä¸é™")}</div>
            <div class="case-meta">ç™¼ä½ˆ: ${escapeHtml(published_at)}</div>
            ${
              imgHtml ? `<div class="case-meta">é™„åœ–ï¼š<br>${imgHtml}</div>` : ""
            }
          </div>
        </div>
        <div style="margin-top:12px;display:flex;flex-direction:column;gap:12px;">
          <button class="primary" style="background:#6a1b9a;" onclick="openRepliesModal(${
            it.id
          })">æŸ¥çœ‹å›å¾©</button>
          <button class="primary" onclick="deleteTask(${it.id})">åˆªé™¤</button>
          <button class="primary" style="background:#007bff;" onclick="editTask(${
            it.id
          })">æ›´æ”¹</button>
          <button class="primary" style="background:#ffa726;" onclick="manageContract(${
            it.id
          })">æ¥æ¡ˆç®¡ç†</button>
        </div>`;
            listEl.appendChild(item);
          });
        }

        window.toggleCompleted = async function (id) {
          // ... (å‰é¢çš„ Issue æª¢æŸ¥é‚è¼¯ä¸è®Š) ...

          const result = await apiRequest(API.TOGGLE, {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: `id=${encodeURIComponent(id)}`,
          });

          if (result) {
            await fetchAndRenderTasks();
            const updatedTask = window.allTasks.find((t) => t.id == id);
            const isNowCompleted =
              updatedTask?.is_completed === true ||
              updatedTask?.is_completed === "t";

            if (isNowCompleted) {
              // 1. ç«‹å³æ›´æ–°æŒ‰éˆ•ç‹€æ…‹ç‚º Disabled
              renderStatusButton(id, true);

              // 2. å½ˆå‡ºè©•åƒ¹è¦–çª—
              setTimeout(() => {
                if (window.openReviewModal) {
                  window.openReviewModal(id, "client");
                }
              }, 500);
            } else {
              // è‹¥æ˜¯é–‹å•Ÿæ¡ˆä»¶ï¼Œå‰‡é¡¯ç¤ºå¯é»æ“Šçš„æŒ‰éˆ•
              renderStatusButton(id, false);
              openRepliesModal(id);
            }
          }
        };

        // åˆªé™¤ä»»å‹™
        window.deleteTask = async (id) => {
          if (!confirm("ç¢ºå®šè¦åˆªé™¤é€™ç­†æ¡ˆä»¶å—ï¼Ÿ")) return;
          if (
            await apiRequest(API.DELETE, {
              method: "POST",
              headers: { "Content-Type": "application/x-www-form-urlencoded" },
              body: `id=${encodeURIComponent(id)}`,
            })
          )
            fetchAndRenderTasks();
        };

        // ç·¨è¼¯ä»»å‹™
        window.editTask = (id) => {
          const task = window.allTasks.find((t) => String(t.id) === String(id));
          if (!task) return;
          const form = document.getElementById("newTaskForm");
          document.getElementById("taskTitle").value = task.title || "";
          document.getElementById("taskBudget").value = task.budget || "";
          document.getElementById("taskRegion").value = task.region || "";
          document.getElementById("taskMeta").value = task.description || "";
          document.getElementById("taskClose").value =
            task.closed_at?.split("T")[0] || "";
          form.setAttribute("data-edit-id", task.id);
          form.setAttribute(
            "data-original-attachments",
            JSON.stringify(task.attachments || [])
          );
          toggleModal("newTaskModal", true);
        };

        // æ¥æ¡ˆç®¡ç†
        // æ¥æ¡ˆç®¡ç†ï¼šæ–°å¢ä¸‹è¼‰é™„ä»¶æŒ‰éˆ•
        window.manageContract = async function (taskId) {
  currentTaskId = taskId;
  const listEl = document.getElementById("contractList");
  listEl.innerHTML = "<div style='text-align:center; padding:20px;'>è¼‰å…¥ä¸­...</div>";

  try {
    const data = await apiRequest(`${API.INTENTS}?task_id=${taskId}`);
    console.log("æ‡‰å¾µè€…åŸå§‹è³‡æ–™:", data);

    if (!data || data.length === 0) {
      listEl.innerHTML = "<div style='text-align:center; padding:20px; color:#888;'>ç›®å‰å°šç„¡äººæå‡ºæ¥æ¡ˆæ„é¡˜ã€‚</div>";
      toggleModal("contractModal", true);
      return;
    }

    listEl.innerHTML = "";

    // ä½¿ç”¨ for...of æ‰èƒ½é…åˆå…§éƒ¨éåŒæ­¥é‚è¼¯ï¼Œæˆ–è€…åœ¨å…§éƒ¨ç”¨ .then
    data.forEach((user) => {
      const card = document.createElement("div");
      card.style.cssText =
        "display: flex; flex-direction: column; gap: 10px; padding: 15px; border: 1px solid #e0e0e0; border-radius: 10px; margin-bottom: 15px; background: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.05);";

      // 1. é¸æ“‡æ¥æ¡ˆäººæŒ‰éˆ•
      const selectBtn = document.createElement("button");
      selectBtn.textContent = `æŒ‡æ´¾çµ¦ï¼š${user.username} ${user.quote ? "(å ±åƒ¹:" + user.quote + ")" : ""}`;
      selectBtn.className = "primary";
      selectBtn.style.width = "100%";
      selectBtn.onclick = () => {
        selectedContractor = user.username;
        [...listEl.querySelectorAll("button.primary")].forEach((b) => (b.style.background = ""));
        selectBtn.style.background = "#28a745";
      };
      card.appendChild(selectBtn);

      // --- æ–°å¢ï¼šè©•åƒ¹èˆ‡è³ªæ€§æ„è¦‹å€å¡Š ---
      const ratingSection = document.createElement("div");
      const ratingId = `rating_box_${user.user_id}`; // å‡è¨­ data è£¡æœ‰ user_id
      ratingSection.id = ratingId;
      ratingSection.style.cssText = "background: #fdf7f2; border-radius: 8px; padding: 10px; font-size: 13px; border: 1px solid #f9e2d0;";
      ratingSection.innerHTML = "<span style='color:#999;'>è©•åƒ¹è¼‰å…¥ä¸­...</span>";
      card.appendChild(ratingSection);

      // éåŒæ­¥æŠ“å–è©²æ¥æ¡ˆäººçš„è©•åƒ¹ (æ³¨æ„ï¼šé€™è£¡è¦ç¢ºèª user ç‰©ä»¶è£¡åŒ…å« user_id)
      const userIdForRating = user.user_id || user.id; 
      if (userIdForRating) {
        fetch(`backend/get_user_rating.php?user_id=${userIdForRating}`)
          .then(res => res.json())
          .then(resData => {
            if (resData.success && resData.total_reviews > 0) {
              const stars = "â­".repeat(Math.round(resData.average_score)) || "â­";
              let commentsHtml = resData.reviews.length > 0 
                ? resData.reviews.map(r => `<div style="color:#555; margin-top:4px; border-top:1px dashed #eec; padding-top:4px;">" ${r.comment} "</div>`).join("")
                : "ç„¡æ–‡å­—è©•è«–";
                
              ratingSection.innerHTML = `
                <div style="font-weight:bold; color:#e67e22;">${stars} ${resData.average_score.toFixed(1)} (${resData.total_reviews} å‰‡è©•åƒ¹)</div>
                <div style="font-size:12px; margin-top:5px;">${commentsHtml}</div>
              `;
            } else {
              ratingSection.innerHTML = "<span style='color:#bbb;'>â­ å°šç„¡è©•åƒ¹ç´€éŒ„ (æ–°é€²æ¥æ¡ˆè€…)</span>";
            }
          })
          .catch(() => {
            ratingSection.innerHTML = "<span style='color:#ff4d4f;'>è©•åƒ¹è®€å–å¤±æ•—</span>";
          });
      }

      // 2. é¡¯ç¤ºä¸‹è¼‰é€£çµå€å¡Š
      let files = [];
      try {
        if (user.attachments) {
          files = typeof user.attachments === "string" ? JSON.parse(user.attachments) : user.attachments;
        }
      } catch (e) {
        console.error("è§£æ attachments å¤±æ•—:", e);
      }

      if (Array.isArray(files) && files.length > 0) {
        const downloadSection = document.createElement("div");
        downloadSection.style.cssText = "border-top: 1px dashed #eee; margin-top: 5px; padding-top: 8px;";

        files.forEach((f) => {
          const rawUrl = f.url || f.path || (typeof f === "string" ? f : "");
          const fileName = f.orig_name || f.filename || "æŸ¥çœ‹é™„ä»¶";
          if (!rawUrl) return;

          let finalUrl = rawUrl;
          if (!rawUrl.startsWith("http") && !rawUrl.startsWith("/")) {
            if (!rawUrl.startsWith("backend/")) finalUrl = "backend/" + rawUrl;
          }

          const link = document.createElement("a");
          link.href = finalUrl;
          link.target = "_blank";
          link.innerHTML = `ğŸ“¥ ä¸‹è¼‰é™„ä»¶ï¼š${fileName}`;
          link.style.cssText = "display: block; margin-top: 6px; padding: 8px; background: #f1f3f4; color: #1a73e8; text-decoration: none; font-size: 13px; border-radius: 5px; text-align: center; border: 1px solid #dcdfe3; word-break: break-all;";
          downloadSection.appendChild(link);
        });
        card.appendChild(downloadSection);
      } else {
        const noFile = document.createElement("div");
        noFile.textContent = "æ­¤äººæœªæä¾›é™„ä»¶";
        noFile.style.cssText = "font-size: 12px; color: #aaa; text-align: center; margin-top: 5px;";
        card.appendChild(noFile);
      }

      listEl.appendChild(card);
    });

    toggleModal("contractModal", true);
  } catch (err) {
    console.error("manageContract Error:", err);
    alert("è®€å–è³‡æ–™å¤±æ•—");
  }
};

        /** --- 4. äº‹ä»¶ç›£è½åˆå§‹åŒ– --- **/
        document.addEventListener("DOMContentLoaded", () => {
          fetchAndRenderTasks();

          // ä»»å‹™è¡¨å–®é€å‡º
          document.getElementById("newTaskForm").onsubmit = async (e) => {
    e.preventDefault();
    const form = e.target;
    const isEdit = form.hasAttribute("data-edit-id");
    const formData = new FormData(form); // é€™è£¡å·²ç¶“å»ºç«‹äº† formData ç‰©ä»¶

    if (window.currentUserId)
        formData.append("poster_id", window.currentUserId);
    
    if (isEdit)
        formData.append("id", form.getAttribute("data-edit-id"));

    // âœ… ä¿®æ­£é»ï¼šå°‡ form.get æ”¹ç‚º formData.get
    if (formData.get("closed_at") === "") {
        formData.delete("closed_at");
    }

    const res = await apiRequest(isEdit ? API.UPDATE : API.CREATE, {
        method: "POST",
        body: formData,
    });

    if (res) {
        toggleModal("newTaskModal", false);
        form.reset();
        fetchAndRenderTasks();
    }
};

          // æª”æ¡ˆé è¦½
          document.getElementById("taskFiles").onchange = (e) => {
            const list = document.getElementById("fileList");
            list.innerHTML = "";
            Array.from(e.target.files).forEach((f) => {
              const item = document.createElement("div");
              item.className = "file-item";
              if (f.type.startsWith("image/")) {
                const img = document.createElement("img");
                const reader = new FileReader();
                reader.onload = (ev) => (img.src = ev.target.result);
                reader.readAsDataURL(f);
                item.appendChild(img);
              }
              item.innerHTML += `<span class="fname">${f.name}</span>`;
              list.appendChild(item);
            });
          };

          // åŸºç¤ UI äº‹ä»¶
          document.getElementById("publishBtn").onclick = () =>
            toggleModal("newTaskModal", true);
          document.getElementById("closeNewTask").onclick = () =>
            toggleModal("newTaskModal", false);
          document.getElementById("assignConfirmBtn").onclick = async () => {
            if (!selectedContractor) return alert("è«‹å…ˆé¸æ“‡æ¥æ¡ˆäºº");
            const res = await apiRequest(API.ASSIGN, {
              method: "POST",
              headers: { "Content-Type": "application/x-www-form-urlencoded" },
              body: `task_id=${currentTaskId}&contractor=${encodeURIComponent(
                selectedContractor
              )}`,
            });
            if (res) {
              alert("âœ… å·²æˆåŠŸæŒ‡æ´¾");
              toggleModal("contractModal", false);
              fetchAndRenderTasks();
            }
          };
        });

        // æš´éœ²å›è¦†ç›¸é—œå‡½å¼
        window.openRepliesModal = async (taskId) => {
          window.currentRepliesTaskId = taskId; // ç´€éŒ„ç•¶å‰ Task ID
          toggleModal("repliesModal", true); // é–‹å•Ÿå½ˆçª—

          const container = document.getElementById("repliesContainer");
          const statusBtnContainer =
            document.getElementById("statusBtnContainer");

          container.innerHTML =
            "<div style='text-align:center; padding:20px;'>ğŸ” è¼‰å…¥æœ€æ–°å›è¦†å…§å®¹ä¸­...</div>";

          try {
            // 1. æ”¹ç‚ºè®€å– get_reply_history.php (è®€å– replie_history è¡¨)
            const resp = await fetch(
              `backend/get_reply_history.php?task_id=${taskId}`
            );
            const data = await resp.json();

            if (!data.success || !data.history || data.history.length === 0) {
              container.innerHTML =
                "<div style='text-align:center; padding:40px; color:#999; border:1px dashed #ccc; border-radius:10px;'>ç›®å‰å°šç„¡ä»»ä½•å›è¦†ç´€éŒ„ (replie_history)</div>";
              return;
            }

            // 2. å–å¾—ç¬¬ä¸€ç­†è³‡æ–™ (æœ€æ–°çš„ä¸€é …)
            const latest = data.history[0];

            // è§£æé™„ä»¶
            let files = [];
            try {
              files =
                typeof latest.attachments === "string"
                  ? JSON.parse(latest.attachments || "[]")
                  : latest.attachments || [];
            } catch (e) {
              files = [];
            }

            // 3. æ¸²æŸ“æœ€æ–°ä¸€ç­†å›è¦†å…§å®¹
            container.innerHTML = `
      <div style="border: 2px solid #4285f4; padding: 20px; border-radius: 12px; background: #fff; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:10px;">
          <span style="background:#4285f4; color:white; padding:2px 10px; border-radius:20px; font-size:12px; font-weight:bold;">
            æœ€æ–°å›è¦† V${latest.version_num}
          </span>
          <span style="font-size:12px; color:#888;">æäº¤æ™‚é–“ï¼š${
            latest.created_at
          }</span>
        </div>

        <div style="margin-bottom:15px;">
          <div style="font-size:14px; font-weight:bold; color:#333; margin-bottom:8px;">å ±åƒ¹é‡‘é¡ï¼š</div>
          <div style="font-size:18px; color:#d32f2f; font-weight:bold;">NT$ ${parseFloat(
            latest.price || 0
          ).toLocaleString()}</div>
        </div>

        <div style="margin-bottom:15px;">
          <div style="font-size:14px; font-weight:bold; color:#333; margin-bottom:8px;">å›è¦†èªªæ˜ï¼š</div>
          <div style="background:#f8f9fa; padding:15px; border-radius:8px; color:#444; line-height:1.6; white-space:pre-wrap; border-left:4px solid #4285f4;">${escapeHtml(
            latest.content || "ç„¡èªªæ˜å…§å®¹"
          )}</div>
        </div>

        <div>
          <div style="font-size:14px; font-weight:bold; color:#333; margin-bottom:8px;">é™„ä»¶æª”æ¡ˆï¼š</div>
          <div style="display:flex; flex-wrap:wrap; gap:10px;">
            ${
              files.length > 0
                ? files
                    .map((f) => {
                      const fPath = f.path || f.url || f;
                      const fName = f.orig_name || f.filename || "ä¸‹è¼‰é™„ä»¶";
                      const finalUrl = fPath.startsWith("backend/")
                        ? fPath
                        : `backend/${fPath}`;
                      return `<a href="${finalUrl}" target="_blank" download="${fName}" 
                         style="display:inline-flex; align-items:center; padding:8px 16px; background:#fff; color:#1a73e8; text-decoration:none; border-radius:6px; font-size:13px; border:1px solid #1a73e8; font-weight:500;">
                         <span style="margin-right:5px;">ğŸ“¥</span> ${fName}</a>`;
                    })
                    .join("")
                : '<span style="color:#ccc; font-size:13px;">ç„¡é™„ä»¶</span>'
            }
          </div>
        </div>
      </div>
    `;

            // æ¸²æŸ“çµæ¡ˆç‹€æ…‹æŒ‰éˆ• (ç¶­æŒåŸé‚è¼¯)
            const task = window.allTasks
              ? window.allTasks.find((t) => t.id == taskId)
              : null;

            if (task && statusBtnContainer) {
              // åˆ¤æ–·æ˜¯å¦å·²çµæ¡ˆ (æ”¯æ´ boolean æˆ– PostgreSQL çš„ "t" å­—ä¸²)
              const isComp =
                task.is_completed === true || task.is_completed === "t";

              if (isComp) {
                // --- æƒ…æ³ Aï¼šå·²çµæ¡ˆ (æŒ‰éˆ•ç¦ç”¨) ---
                statusBtnContainer.innerHTML = `
            <button class="status-btn" 
                    disabled 
                    style="background: #bdc3c7; color: white; padding: 10px; border-radius: 6px; cursor: not-allowed; border: none; width: 100%; font-weight: bold; opacity: 0.8;">
                âœ… æ­¤æ¡ˆä»¶å·²çµæ¡ˆ (è©•åƒ¹å®Œæˆ)
            </button>`;
              } else {
                // --- æƒ…æ³ Bï¼šå°šæœªçµæ¡ˆ (æŒ‰éˆ•å¯ç”¨) ---
                statusBtnContainer.innerHTML = `
            <button onclick="toggleCompleted(${taskId})" class="status-btn" 
                    style="background: #f44336; color: white; padding: 10px; border-radius: 6px; cursor: pointer; border: none; width: 100%; font-weight: bold;">
                â³ å°šæœªçµæ¡ˆ (é»æ“Šåˆ‡æ›)
            </button>`;
              }
            }
          } catch (err) {
            console.error("è®€å– replie_history å¤±æ•—:", err);
            container.innerHTML =
              "<div style='text-align:center; padding:40px; color:#d32f2f;'>é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ get_reply_history.php æ˜¯å¦æ­£å¸¸</div>";
          }
        };
        // --- 1. é…ç½®èˆ‡è¼”åŠ©å‡½å¼ ---
        const REPLIES_API = {
          BASE: "backend/get_replies.php",
          ACCEPT: "backend/accept_reply.php",
          REJECT: "backend/reject_reply.php",
        };

        // ç‹€æ…‹æŒ‰éˆ•æ¸²æŸ“
        function renderStatusButton(taskId, isComp) {
          const statusBtnContainer =
            document.getElementById("statusBtnContainer");
          if (!statusBtnContainer) return;

          if (isComp) {
            // å¦‚æœå·²çµæ¡ˆï¼šæŒ‰éˆ•åŠ ä¸Š disabled å±¬æ€§ï¼Œä¸¦èª¿æ•´æ¨£å¼
            statusBtnContainer.innerHTML = `
            <button class="status-btn" 
                    disabled 
                    style="background: #9e9e9e; color: white; padding: 10px; border-radius: 6px; cursor: not-allowed; border: none; width: 100%; font-weight: bold; opacity: 0.7;">
              âœ… å·²çµæ¡ˆ (ä¸å¯è®Šæ›´)
            </button>`;
          } else {
            // å¦‚æœæœªçµæ¡ˆï¼šç¶­æŒåŸæœ¬çš„å¯é»æ“Šç‹€æ…‹
            statusBtnContainer.innerHTML = `
            <button onclick="toggleCompleted(${taskId})" class="status-btn" 
                    style="background: #f44336; color: white; padding: 10px; border-radius: 6px; cursor: pointer; border: none; width: 100%; font-weight: bold;">
              â³ å°šæœªçµæ¡ˆ (é»æ“Šåˆ‡æ›)
            </button>`;
          }
        }

        // é—œé–‰ Modal
        function closeRepliesModal() {
          const modal = document.getElementById("repliesModal");
          modal.classList.remove("show");
          modal.setAttribute("aria-hidden", "true");
          document.body.style.overflow = "";
          window.currentRepliesTaskId = window.selectedReplyId = null;
        }

        // --- 2. æ¸²æŸ“å›è¦†åˆ—è¡¨ ---
        function renderRepliesList(container, replies) {
          container.innerHTML = replies
            .map((reply) => {
              // å‡è¨­å¾Œç«¯å°‡ attachments å„²å­˜ç‚º JSON å­—ä¸²æˆ–é€—è™Ÿåˆ†éš”ï¼Œåœ¨æ­¤è§£æç‚ºé™£åˆ—
              let fileList = [];
              try {
                fileList =
                  typeof reply.attachments === "string"
                    ? JSON.parse(reply.attachments)
                    : reply.attachments || [];
              } catch (e) {
                fileList = reply.attachments
                  ? String(reply.attachments).split(",")
                  : [];
              }

              return `
      <div class="reply-item ${
        window.selectedReplyId == reply.id ? "active" : ""
      }" onclick="selectReply(${reply.id})">
        <div class="reply-header">
          <strong>æ‰¿æ¥äºº ID: ${reply.user_id}</strong>
          <span class="reply-date">${reply.created_at.slice(0, 16)}</span>
        </div>
        <div class="reply-content">${escapeHtml(reply.content)}</div>
        
        <div class="version-history" style="margin-top:10px; background:#f0f4f8; padding:8px; border-radius:4px;">
          <p style="font-size:12px; font-weight:bold; margin:0 0 5px 0;">ğŸ“‹ äº¤ä»˜æª”æ¡ˆç´€éŒ„ï¼š</p>
          <ul style="list-style:none; padding:0; margin:0;">
            ${fileList
              .map(
                (file, idx) => `
              <li style="font-size:13px; margin-bottom:4px;">
                <span style="background:#4285f4; color:white; padding:0 4px; border-radius:3px; font-size:10px;">V${
                  idx + 1
                }</span>
                <a href="${file}" target="_blank" download style="color:#1a73e8; text-decoration:none;">ä¸‹è¼‰ç‰ˆæœ¬æª”æ¡ˆ</a>
              </li>
            `
              )
              .join("")}
          </ul>
        </div>
      </div>
    `;
            })
            .join("");
        }

        // é¸æ“‡å›è¦†çš„ UI åˆ‡æ›
        window.selectReply = (btn, id) => {
          window.selectedReplyId = id;
          document.querySelectorAll(".reply-item").forEach((el) => {
            const isTarget = el.dataset.id == id;
            el.style.boxShadow = isTarget ? "0 4px 18px rgba(0,0,0,0.06)" : "";
            el.style.border = isTarget
              ? "1px solid #b39ddb"
              : "1px solid #eef2f6";
          });
        };

        // --- 3. è™•ç†æ¥å—/é€€ä»¶ API ---
        // å°‡åŸæœ¬çš„ async function handleReplyAction(actionType) ...
        // ä¿®æ”¹ç‚ºï¼š
        // å°‹æ‰¾åŸæœ¬çš„ async function handleReplyAction(actionType) ...
        // å°‡å…¶ä¿®æ”¹ç‚ºæ›è¼‰åˆ° window ä¸‹ï¼š
        window.handleReplyAction = async function (actionType) {
          if (!window.selectedReplyId) return alert("è«‹å…ˆé¸æ“‡ä¸€ç­†å›è¦†");
          const isReject = actionType === "reject";

          // é€€ä»¶æ™‚å¼·åˆ¶è¦æ±‚è¼¸å…¥ç†ç”±
          let reason = "";
          if (isReject) {
            reason = prompt("è«‹è¼¸å…¥é€€ä»¶åŸå› æˆ–ä¿®æ”¹å»ºè­°ï¼š");
            if (reason === null) return; // å–æ¶ˆ
            if (!reason.trim()) return alert("é€€ä»¶å¿…é ˆæä¾›ä¿®æ”¹å»ºè­°ã€‚");
          } else {
            if (!confirm("ç¢ºå®šæ¥å—æ­¤å›è¦†ä¸¦æŒ‡æ´¾æ‰¿æ¥è€…ï¼Ÿ")) return;
          }

          const body = new FormData();
          body.append("reply_id", window.selectedReplyId);
          body.append("action", actionType);
          if (isReject) body.append("message", reason);

          try {
            // å‘¼å«è™•ç† API (å¾Œç«¯éœ€å°æ‡‰è™•ç†é€€ä»¶ç‹€æ…‹)
            const resp = await fetch(
              isReject
                ? "backend/reject_reply.php"
                : "backend/accept_reply.php",
              {
                method: "POST",
                body,
                credentials: "same-origin",
              }
            );
            const result = await resp.json();
            if (result.success) {
              alert(isReject ? "å·²é€€ä»¶ï¼Œå°‡è¦æ±‚æ‰¿æ¥äººä¿®æ”¹ã€‚" : "å·²æ¥å—æŒ‡æ´¾ã€‚");
              window.openRepliesModal(window.currentRepliesTaskId);
            }
          } catch (err) {
            alert("æ“ä½œå¤±æ•—");
          }
        };
      })();
      // --- 4. åˆå§‹åŒ–äº‹ä»¶ç¶å®š ---
      document
        .querySelectorAll("#closeRepliesModal, #replyCloseBtn")
        .forEach((el) => (el.onclick = closeRepliesModal));
      document.getElementById("replyAcceptBtn").onclick = () =>
        handleReplyAction("accept");
      document.getElementById("replyRejectBtn").onclick = () =>
        handleReplyAction("reject");

      function escapeHtml(str) {
        if (!str) return "";
        return String(str).replace(
          /[&<>"']/g,
          (m) =>
            ({
              "&": "&amp;",
              "<": "&lt;",
              ">": "&gt;",
              '"': "&quot;",
              "'": "&#39;",
            }[m])
        );
      }

      //issue modal script
      /* --- 1. é…ç½®èˆ‡æ ¸å¿ƒå·¥å…· --- */
      const API = {
        ISSUE: "backend/issue.php",
        list: (pid) => `backend/issue.php?action=issues/list&project_id=${pid}`,
        comments: (iid) =>
          `backend/issue.php?action=issues/comments&issue_id=${iid}`,
      };

      // çµ±ä¸€ API è«‹æ±‚å·¥å…·
      async function apiFetch(url, options = {}) {
        try {
          const resp = await fetch(url, {
            credentials: "same-origin",
            ...options,
          });
          const ct = resp.headers.get("content-type");
          if (!ct || !ct.includes("application/json"))
            throw new Error("ä¼ºæœå™¨å›å‚³æ ¼å¼éŒ¯èª¤ (é JSON)");
          const data = await resp.json();
          if (!data.success) throw new Error(data.message || "æ“ä½œå¤±æ•—");
          return data;
        } catch (err) {
          console.error("API Error:", err);
          throw err;
        }
      }

      let state = {
        currentTaskId: null,
        selectedIssueId: null,
        allIssues: [],
        isCreating: false,
      };

      /* --- 2. äº‹é … Modal é‚è¼¯ --- */
      window.openIssuesModal = async function (taskId) {
        if (!window.currentUserId) return alert("è«‹ç­‰å¾…ä½¿ç”¨è€…è³‡è¨Šè¼‰å…¥...");

        state.currentTaskId = taskId;
        state.selectedIssueId = null;

        const modal = document.getElementById("issuesModal");
        const addBtn = document.getElementById("addIssueBtn");
        const task =
          typeof allTasks !== "undefined"
            ? allTasks.find((t) => t.id == taskId)
            : null;

        // çµæ¡ˆåˆ¤æ–·èˆ‡ UI é¡¯ç¤º
        const isComp =
          task?.is_completed === true || task?.is_completed === "t";
        if (addBtn) addBtn.style.display = isComp ? "none" : "flex";

        modal.classList.add("show");
        document.body.style.overflow = "hidden";

        await fetchAndRenderIssues(taskId);
        renderChatHistory();
      };

      function closeIssuesModal() {
        document.getElementById("issuesModal").classList.remove("show");
        document.body.style.overflow = "";
        state.currentTaskId = state.selectedIssueId = null;
      }

      /* --- 3. äº‹é …æ¸…å–®æ¸²æŸ“èˆ‡ CRUD --- */
      async function fetchAndRenderIssues(taskId) {
        const container = document.getElementById("issueListContainer");
        container.innerHTML = `<div class="loading">è¼‰å…¥ä¸­...</div>`;

        try {
          const data = await apiFetch(API.list(taskId));
          state.allIssues = data.issues || [];
          renderIssueList(state.allIssues);
        } catch (err) {
          container.innerHTML = `<div class="error">è¼‰å…¥å¤±æ•—: ${err.message}</div>`;
        }
      }

      function renderIssueList(issues) {
        const container = document.getElementById("issueListContainer");
        container.innerHTML = issues
          .map((issue) => {
            const isClosed =
              issue.issue_is_opened == true || issue.issue_is_opened == 1;
            const date = (issue.created_at || "").slice(0, 10);
            const activeClass =
              state.selectedIssueId == issue.id ? "active" : "";

            return `
      <div class="issue-item ${activeClass}" onclick="selectIssue(${issue.id})">
        <span class="issue-status" style="color:${
          isClosed ? "#e53935" : "#2e7d32"
        }">${isClosed ? "ğŸ”´" : "ğŸŸ¢"}</span>
        <span class="issue-title">${escapeHtml(issue.title)}</span>
        <span class="issue-date">${date}</span>
      </div>`;
          })
          .join("");
      }

      // æ–°å¢äº‹é …æµç¨‹
      document.getElementById("addIssueBtn").onclick = () => {
        if (state.isCreating) return;
        const container = document.getElementById("issueListContainer");
        const tempItem = document.createElement("div");
        tempItem.className = "issue-item creating";
        tempItem.innerHTML = `
    <span class="issue-status">âŒ›</span>
    <input type="text" id="tempInput" placeholder="è¼¸å…¥åç¨±å¾Œ Enter..." style="width:100%">
  `;
        container.prepend(tempItem);
        const input = tempItem.querySelector("#tempInput");
        input.focus();
        state.isCreating = true;

        input.onkeydown = async (e) => {
          if (e.key === "Enter") {
            const title = input.value.trim();
            if (title.length < 2) return alert("æ¨™é¡Œå¤ªçŸ­");
            try {
              const fd = new FormData();
              fd.append("project_id", state.currentTaskId);
              fd.append("title", title);
              const res = await apiFetch(`${API.ISSUE}?action=issues/create`, {
                method: "POST",
                body: fd,
              });
              state.isCreating = false;
              fetchAndRenderIssues(state.currentTaskId).then(() =>
                selectIssue(res.issue_id)
              );
            } catch (err) {
              alert(err.message);
              tempItem.remove();
              state.isCreating = false;
            }
          }
        };
        input.onblur = () => {
          if (!input.value.trim()) {
            tempItem.remove();
            state.isCreating = false;
          }
        };
      };

      /* --- 4. èŠå¤©èˆ‡ç•™è¨€é‚è¼¯ --- */
      window.selectIssue = async (issueId) => {
        state.selectedIssueId = issueId;
        renderIssueList(state.allIssues); // æ›´æ–°é¸ä¸­æ¨£å¼

        const history = document.getElementById("chatHistory");
        history.innerHTML = `<div class="loading">è¼‰å…¥ç•™è¨€ä¸­...</div>`;

        try {
          const data = await apiFetch(API.comments(issueId));
          renderChatHistory(data.comments);
        } catch (err) {
          history.innerHTML = "ç•™è¨€è¼‰å…¥å¤±æ•—";
        }
      };

      function renderChatHistory(comments = []) {
        const history = document.getElementById("chatHistory");
        const inputArea = document.getElementById("chatInputArea");

        if (!state.selectedIssueId) {
          history.innerHTML = `<div class="chat-prompt">è«‹é¸æ“‡äº‹é …é–‹å§‹è¨è«–ã€‚</div>`;
          if (inputArea) inputArea.style.display = "none";
          return;
        }

        const currentIssue = state.allIssues.find(
          (i) => i.id == state.selectedIssueId
        );
        const isOpened =
          currentIssue?.issue_is_opened == 1 ||
          currentIssue?.issue_is_opened == true;
        if (inputArea) inputArea.style.display = isOpened ? "flex" : "none";

        history.innerHTML = comments.length
          ? comments
              .map(
                (c) => `
    <div class="chat-message ${
      String(c.user_id) === window.currentUserId ? "msg-right" : "msg-left"
    }">
      ${escapeHtml(c.content)}
    </div><div style="clear:both"></div>
  `
              )
              .join("")
          : `<div class="empty-hint">é€™æ˜¯æ–°çš„è¨è«–ï¼Œé–‹å§‹å°è©±å§ï¼</div>`;

        history.scrollTop = history.scrollHeight;
      }

      // ç™¼é€ç•™è¨€ (å«ã€ŒçµæŸissueã€æŒ‡ä»¤)
      document.getElementById("chatSendBtn").onclick = async () => {
        const input = document.getElementById("chatInput");
        const content = input.value.trim();
        if (!content || !state.selectedIssueId) return;

        const isResolve = content === "çµæŸissue";
        const url = isResolve
          ? `${API.ISSUE}?action=issues/resolve`
          : `${API.ISSUE}?action=issue/comment/create`;

        if (isResolve && !confirm("ç¢ºå®šçµæ¡ˆå—ï¼Ÿ")) return;

        const fd = new FormData();
        fd.append("issue_id", state.selectedIssueId);
        if (!isResolve) fd.append("content", content);

        try {
          await apiFetch(url, { method: "POST", body: fd });
          input.value = "";
          await fetchAndRenderIssues(state.currentTaskId);
          isResolve ? renderChatHistory() : selectIssue(state.selectedIssueId);
        } catch (err) {
          alert(err.message);
        }
      };

      /* --- 5. äº‹ä»¶ç›£è½ --- */
      document
        .querySelectorAll("#closeIssuesModal, #issuesModal")
        .forEach((el) => {
          el.addEventListener("click", (e) => {
            if (e.target === el) closeIssuesModal();
          });
        });
      document.getElementById("chatInput").onkeypress = (e) => {
        if (e.key === "Enter") document.getElementById("chatSendBtn").click();
      };

      function escapeHtml(s) {
        return String(s || "").replace(
          /[&<>"']/g,
          (m) =>
            ({
              "&": "&amp;",
              "<": "&lt;",
              ">": "&gt;",
              '"': "&quot;",
              "'": "&#39;",
            }[m])
        );
      }
      // å»ºè­°æ”¾åœ¨ DOMContentLoaded å…§
      document.getElementById("openIssuesBtn").onclick = function () {
        // ä½¿ç”¨ window. å‰ç¶´ç¢ºä¿æŠ“åˆ°å…¨åŸŸè®Šæ•¸
        if (window.currentRepliesTaskId) {
          window.openIssuesModal(window.currentRepliesTaskId);
        } else {
          console.error("éŒ¯èª¤ï¼šcurrentRepliesTaskId ç‚ºç©º");
          alert("è«‹å…ˆé‡æ–°é–‹å•Ÿã€ŒæŸ¥çœ‹å›å¾©ã€è¦–çª—ä»¥å–å¾—æ¡ˆä»¶è³‡è¨Šã€‚");
        }
      };

      /* --- æ­·å²ç´€éŒ„åŠŸèƒ½å¯¦ä½œ --- */

      // 1. ç¶å®šæŒ‰éˆ•é»æ“Šäº‹ä»¶
      document.getElementById("openHistoryBtn").onclick = function () {
        // å„ªå…ˆå˜—è©¦å¾å…¨åŸŸç‹€æ…‹æˆ–ç•¶å‰å½ˆçª—ç´€éŒ„ä¸­ç²å– taskId
        const taskId =
          window.currentRepliesTaskId ||
          (window.state && window.state.currentTaskId);
        if (taskId) {
          openReplyHistory(taskId);
        } else {
          alert("è«‹å…ˆé¸æ“‡ä¸€å€‹æ¡ˆä»¶");
        }
      };

      // 2. é–‹å•Ÿæ­·å²ç´€éŒ„ä¸¦æ¸²æŸ“
      async function openReplyHistory(taskId) {
        const listContainer = document.getElementById("historyList");
        // å‘¼å«å…¨åŸŸå‡½å¼
        window.toggleModal("historyModal", true);

        listContainer.innerHTML =
          "<div style='text-align:center; padding:20px;'>ğŸ” è¼‰å…¥ç´€éŒ„ä¸­...</div>";

        try {
          const resp = await fetch(
            `backend/get_reply_history.php?task_id=${taskId}`
          );
          const data = await resp.json();

          if (data.success && data.history && data.history.length > 0) {
            listContainer.innerHTML = data.history
              .map((h, index) => {
                let files = [];
                try {
                  files =
                    typeof h.attachments === "string"
                      ? JSON.parse(h.attachments)
                      : h.attachments || [];
                } catch (e) {
                  files = [];
                }

                return `
          <div style="border: 1px solid #ddd; padding: 15px; margin-bottom: 15px; border-radius: 8px; background: ${
            index === 0 ? "#f0f7ff" : "#fff"
          };">
            <div style="display:flex; justify-content:space-between; font-size:12px; color:#888; margin-bottom:8px;">
              <span>ç‰ˆæœ¬ï¼š<strong>V${h.version_num}</strong> ${
                  index === 0 ? '<b style="color:#4285f4;">(æœ€æ–°)</b>' : ""
                }</span>
              <span>${h.created_at}</span>
            </div>
            <div style="margin-bottom:8px; font-weight:bold; color:#d32f2f;">å ±åƒ¹ï¼šNT$ ${parseFloat(
              h.price || 0
            ).toLocaleString()}</div>
            <div style="font-size:14px; color:#333; background:#f9f9f9; padding:10px; border-radius:4px; white-space:pre-wrap;">${
              h.content || "ç„¡æè¿°"
            }</div>
            
            <div style="margin-top:10px; display:flex; flex-wrap:wrap; gap:8px;">
              ${files
                .map((f) => {
                  const fPath = f.path || f.url || f;
                  const fName = f.orig_name || f.filename || "ä¸‹è¼‰é™„ä»¶";
                  const finalUrl = fPath.startsWith("backend/")
                    ? fPath
                    : `backend/${fPath}`;
                  return `
                  <a href="${finalUrl}" target="_blank" download="${fName}" 
                     style="font-size:12px; color:#1a73e8; text-decoration:none; background:#fff; padding:5px 10px; border-radius:4px; border:1px solid #1a73e8; display:flex; align-items:center;">
                     ğŸ“¥ ${fName}
                  </a>`;
                })
                .join("")}
            </div>
          </div>`;
              })
              .join("");
          } else {
            listContainer.innerHTML =
              "<div style='text-align:center; padding:40px; color:#999;'>å°šç„¡å›è¦†æ­·å²ã€‚</div>";
          }
        } catch (err) {
          console.error(err);
          listContainer.innerHTML =
            "<div style='text-align:center; padding:20px; color:red;'>è®€å–å¤±æ•—ï¼Œè«‹ç¢ºèªå¾Œç«¯é€£ç·šã€‚</div>";
        }
      }

      // é–‹å•Ÿè©•åƒ¹è¦–çª— (å‚³å…¥èº«ä»½èˆ‡ä»»å‹™ID)
      window.openReviewModal = function (taskId, role) {
        document.getElementById("reviewTaskId").value = taskId;
        document.getElementById("reviewRoleType").value = role;

        // æ ¹æ“šè§’è‰²é¡¯ç¤ºä¸åŒç¶­åº¦æ¨™é¡Œ
        if (role === "client") {
          document.getElementById("label_score_1").innerText = "éœ€æ±‚åˆç†æ€§ï¼š";
          document.getElementById("label_score_2").innerText = "é©—æ”¶é›£åº¦ï¼š";
          document.getElementById("label_score_3").innerText = "åˆä½œæ…‹åº¦ï¼š";
        } else {
          document.getElementById("label_score_1").innerText = "ç”¢å‡ºå“è³ªï¼š";
          document.getElementById("label_score_2").innerText = "åŸ·è¡Œæ•ˆç‡ï¼š";
          document.getElementById("label_score_3").innerText = "åˆä½œæ…‹åº¦ï¼š";
        }
        toggleModal("reviewModal", true);
      };

      // æäº¤è©•åƒ¹åˆ°å¾Œç«¯
      async function submitReview() {
        const fd = new FormData();
        fd.append("task_id", document.getElementById("reviewTaskId").value);
        fd.append("role_type", document.getElementById("reviewRoleType").value);
        fd.append("score_1", document.getElementById("score_1").value);
        fd.append("score_2", document.getElementById("score_2").value);
        fd.append("score_3", document.getElementById("score_3").value);
        fd.append("comment", document.getElementById("reviewComment").value);

        try {
          const resp = await fetch("backend/submit_review.php", {
            method: "POST",
            body: fd,
          });
          const result = await resp.json();
          if (result.success) {
            alert("è©•åƒ¹æˆåŠŸï¼");
            toggleModal("reviewModal", false);
          } else {
            alert("è©•åƒ¹å¤±æ•—ï¼š" + result.message);
          }
        } catch (e) {
          console.error(e);
        }
      }
    </script>
  </body>
</html>
