<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Tasker æ¡ˆä»¶ç®¡ç†</title>
    <style>
      :root {
        --sidebar-w: 220px;
        --accent: #e53935;
        --brand: #4285f4;
        --muted: #777;
        --bg: #f7f8fb;
        --card: #fff;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: system-ui, -apple-system, "Segoe UI", Roboto,
          "Noto Sans TC", sans-serif;
        background: var(--bg);
        color: #111;
      }
      .app {
        display: flex;
        min-height: 100vh;
      }
      .sidebar {
        width: var(--sidebar-w);
        background: linear-gradient(180, #fff, #f2f4f8);
        border-right: 1px solid #e6e9ef;
        padding: 20px;
      }
      .profile {
        padding: 12px;
        background: transparent;
        border-radius: 8px;
        margin-bottom: 12px;
      }
      .profile .role {
        font-weight: 600;
        color: var(--brand);
      }
      .profile .userid {
        margin-top: 6px;
        color: #333;
        font-size: 14px;
      }
      .profile .edit {
        display: inline-block;
        margin-top: 8px;
        font-size: 13px;
        color: var(--muted);
        text-decoration: none;
      }
      .menu ul {
        list-style: none;
        padding: 0;
        margin: 12px 0;
      }
      .menu li {
        padding: 10px;
        border-radius: 6px;
        cursor: pointer;
        color: #333;
        margin-bottom: 6px;
      }
      .menu li.active {
        background: #eef6ff;
        color: var(--brand);
        font-weight: 600;
      }

      .main {
        flex: 1;
        padding: 28px;
      }
      .main-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 18px;
      }
      .main-header h1 {
        margin: 0;
        font-size: 20px;
      }
      .tabs {
        display: flex;
        gap: 8px;
      }
      .tab {
        padding: 8px 14px;
        border-radius: 6px;
        border: 1px solid transparent;
        background: #eee;
        cursor: pointer;
      }
      .tab.active {
        background: var(--brand);
        color: #fff;
        border-color: rgba(0, 0, 0, 0.05);
      }

      .content {
        background: transparent;
      }
      .empty-state {
        background: var(--card);
        padding: 48px;
        border-radius: 10px;
        text-align: center;
        color: var(--muted);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.04);
      }
      .empty-state .empty-text {
        font-size: 18px;
        margin: 18px 0;
      }
      .primary {
        background: var(--accent);
        color: #fff;
        border: none;
        padding: 10px 16px;
        border-radius: 8px;
        cursor: pointer;
      }
      .hidden {
        display: none;
      }

      .case-list {
        display: grid;
        gap: 12px;
      }
      .case-item {
        background: var(--card);
        padding: 14px;
        border-radius: 8px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border: 1px solid #eef2f6;
      }
      .case-meta {
        color: var(--muted);
        font-size: 13px;
      }
      dialog {
        border: none;
        border-radius: 10px;
        padding: 20px;
      }
      label {
        display: block;
        margin: 10px 0;
        font-size: 14px;
      }
      input,
      textarea {
        width: 100%;
        padding: 8px;
        border: 1px solid #d7dbe0;
        border-radius: 6px;
      }
      .modal-actions {
        display: flex;
        gap: 8px;
        justify-content: flex-end;
        margin-top: 12px;
      }
      /* modal å…±ç”¨ */
      /* Modal èƒŒæ™¯é®ç½© */
      /* Modal èƒŒæ™¯é®ç½© */
      .modal {
        display: none; /* åˆå§‹éš±è— */
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.6);
        z-index: 1000;
        justify-content: center;
        align-items: center;
        overflow: auto;
      }

      /* é¡¯ç¤ºæ™‚åŠ ä¸Šå‹•ç•« class */
      .modal.show {
        display: flex;
      }

      /* Modal å…§å®¹å®¹å™¨ï¼šå‹•ç•«åˆå§‹ç‹€æ…‹ */
      .modal-content {
        background-color: #fff;
        padding: 2rem;
        border-radius: 8px;
        max-width: 600px;
        width: 90%;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        position: relative;
        transform: translateY(50px);
        opacity: 0;
        transition: transform 0.4s ease, opacity 0.4s ease;
      }

      /* é¡¯ç¤ºå‹•ç•«ï¼šç”±ä¸‹å¾€ä¸Šæ·¡å…¥ */
      .modal.show .modal-content {
        transform: translateY(0);
        opacity: 1;
      }

      /* é—œé–‰å‹•ç•«ï¼šç”±ä¸Šå¾€ä¸‹æ·¡å‡º */
      .modal.hide .modal-content {
        transform: translateY(-50px);
        opacity: 0;
      }

      /* é—œé–‰æŒ‰éˆ• */
      .close-btn {
        position: absolute;
        top: 1rem;
        right: 1rem;
        font-size: 1.5rem;
        background: none;
        border: none;
        cursor: pointer;
      }

      /* è¡¨å–®æ¬„ä½æ’ç‰ˆ */
      .task-field {
        margin-bottom: 1.5rem;
      }

      .form-row {
        display: flex;
        gap: 1rem;
      }

      .col {
        flex: 1;
      }

      .submit-row {
        text-align: center;
      }

      .btn-submit {
        background-color: #007bff;
        color: white;
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }

      .btn-submit:hover {
        background-color: #0056b3;
      }

      /* é™„åŠ æª”æ¡ˆæ¸…å–®æ¨£å¼ */
      .file-list {
        margin-top: 0.5rem;
        font-size: 0.9rem;
        color: #555;
      }
      .file-item {
        display: inline-block;
        vertical-align: top;
        width: 120px;
        margin: 8px;
        padding: 6px;
        border: 1px solid #e6e9ef;
        border-radius: 6px;
        background: #fff;
        text-align: center;
        font-size: 12px;
        color: #333;
      }
      .file-item img {
        display: block;
        max-width: 100%;
        max-height: 80px;
        object-fit: cover;
        margin-bottom: 6px;
        border-radius: 4px;
      }
      .file-item .fname {
        display: block;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      /* æ¥æ¡ˆç®¡ç† modal è£¡è¢«é¸åˆ°çš„æŒ‰éˆ•æ¨£å¼ */
      #contractList button.active {
        background-color: #2e7d32 !important; /* ç¶ è‰² */
        color: #fff !important;
        border: 1px solid rgba(0, 0, 0, 0.06) !important;
        box-shadow: 0 2px 6px rgba(46, 125, 50, 0.18);
      }
      #contractList button {
        background: #fff;
        color: #333;
        border: 1px solid #ddd;
        padding: 8px 10px;
        border-radius: 6px;
        cursor: pointer;
      }
      .menu li a {
        color: inherit; /* ä½¿ç”¨çˆ¶å…ƒç´ æ–‡å­—è‰² -> çœ‹èµ·ä¾†åƒä¸€èˆ¬æ–‡å­— */
        text-decoration: none; /* å–æ¶ˆåº•ç·š */
        cursor: pointer; /* é¡¯ç¤ºå¯é»ç‹€æ…‹ï¼ˆhand pointerï¼‰ */
        background: none;
        padding: 0;
        border: none;
        display: inline-block;
      }
      /* --- æ–°å¢ï¼šå¾…è§£æ±ºäº‹é …èˆ‡èŠå¤©è¦–çª—æ¨£å¼ --- */
      /* è®“æ–°çš„å½ˆçª—å±¤ç´šæ¯”åŸæœ¬çš„é«˜ï¼Œç¢ºä¿è“‹åœ¨ä¸Šé¢ */
      #issuesModal {
        z-index: 2000;
      }

      .chat-layout {
        display: flex;
        height: 60vh;
        border: 1px solid #e6e9ef;
        border-radius: 8px;
        overflow: hidden;
        margin-top: 10px;
      }

      /* å·¦å´ï¼šå¾…è§£æ±ºäº‹é … */
      .chat-sidebar {
        width: 280px;
        background: #f7f8fb;
        border-right: 1px solid #e6e9ef;
        display: flex;
        flex-direction: column;
      }

      .sidebar-header {
        padding: 15px;
        border-bottom: 1px solid #e6e9ef;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #fff;
      }

      .sidebar-header h4 {
        margin: 0;
        font-size: 16px;
        color: #333;
      }

      /* åœ“å½¢ç„¡æ–‡å­—åŠ è™ŸæŒ‰éˆ• */
      .add-issue-btn {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        background: var(--brand);
        color: #fff;
        border: none;
        font-size: 20px;
        line-height: 28px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0;
      }
      .add-issue-btn:hover {
        background: #3367d6;
      }

      .issue-list-container {
        flex: 1;
        overflow-y: auto;
        padding: 10px;
      }

      .issue-item {
        background: #fff;
        padding: 10px;
        border-radius: 6px;
        margin-bottom: 8px;
        border: 1px solid #e6e9ef;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 14px;
      }

      .issue-done-btn {
        background: #fff;
        border: 1px solid #4caf50;
        color: #4caf50;
        border-radius: 4px;
        font-size: 12px;
        padding: 4px 8px;
        cursor: pointer;
      }
      .issue-done-btn:hover {
        background: #4caf50;
        color: #fff;
      }

      /* å³å´ï¼šèŠå¤©ä»‹é¢ */
      .chat-main {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: #fff;
      }

      .chat-history {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        background: #fafafa;
      }

      .chat-message {
        margin-bottom: 15px;
        max-width: 80%;
        padding: 10px 14px;
        border-radius: 12px;
        font-size: 14px;
        line-height: 1.4;
        position: relative;
      }

      .msg-left {
        background: #fff;
        border: 1px solid #e6e9ef;
        align-self: flex-start;
        margin-right: auto;
        border-bottom-left-radius: 2px;
      }

      .msg-right {
        background: #eef6ff;
        color: #1a73e8;
        align-self: flex-end;
        margin-left: auto;
        border-bottom-right-radius: 2px;
        float: right;
        clear: both;
      }

      .chat-input-area {
        padding: 10px;
        border-top: 1px solid #e6e9ef;
        gap: 10px;
        background: #fff;
      }

      .chat-input-area input {
        flex: 1;
        border: 1px solid #d7dbe0;
        border-radius: 20px;
        padding: 8px 16px;
        outline: none;
      }
      /* æ–°å¢ï¼šæœªé¸æ“‡äº‹é …æ™‚çš„æç¤ºæ¨£å¼ */
      .chat-prompt {
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        color: #999;
        background: #fff;
        text-align: center;
        padding: 20px;
      }
    </style>
    <script>
      // å–å¾— session ä½¿ç”¨è€…è³‡æ–™ä¸¦æŠŠå´é‚Šæ¬„é¡¯ç¤ºæ›´æ–°ï¼ˆç­‰ DOM å»ºç«‹å¾Œå†æ›´æ–° DOMï¼‰
      function applySessionToUI(data) {
        const uid = data.user_id ?? "";
        const uname = data.username ?? "";

        window.currentUserId = String(uid);
        window.currentUsername = String(uname);

        const roleEl = document.querySelector(".profile .role");
        const idEl = document.querySelector(".profile .userid");

        if (roleEl) roleEl.textContent = uname ? uname : "è³£ä¸»";
        if (idEl) idEl.textContent = uid ? `ID:${uid}` : "ID:æœªç™»å…¥";
      }

      // å…ˆå‘å¾Œç«¯æ‹¿ sessionï¼ˆéåŒæ­¥ï¼‰ï¼Œæ‹¿åˆ°å¾Œå„²å­˜è³‡æ–™ï¼›ä½†åªæœ‰åœ¨ DOM æº–å‚™å¥½æ™‚æ‰å˜—è©¦æ›´æ–° UI
      fetch("backend/get_session_user.php", { credentials: "same-origin" })
        .then((res) => {
          if (!res.ok) throw new Error("ç„¡æ³•å–å¾— session");
          return res.json();
        })
        .then((data) => {
          // è‹¥ DOM å·²å°±ç·’ï¼Œç«‹å³æ›´æ–°ï¼›å¦å‰‡æ’å…¥ DOMContentLoaded å¾ŒåŸ·è¡Œ
          if (document.readyState === "loading") {
            window.__sessionData = data;
            window.addEventListener(
              "DOMContentLoaded",
              () => {
                if (window.__sessionData) {
                  applySessionToUI(window.__sessionData);
                  window.__sessionData = null;
                }
                if (typeof fetchAndRenderTasks === "function")
                  fetchAndRenderTasks();
              },
              { once: true }
            );
          } else {
            applySessionToUI(data);
            if (typeof fetchAndRenderTasks === "function")
              fetchAndRenderTasks();
          }
        })
        .catch((err) => {
          console.warn("å–å¾— session ä½¿ç”¨è€…å¤±æ•—", err);
          // è‹¥ DOM é‚„æ²’æº–å‚™å¥½ï¼Œç­‰ DOMContentLoaded å†é¡¯ç¤ºé è¨­æ–‡å­—
          if (document.readyState === "loading") {
            window.addEventListener(
              "DOMContentLoaded",
              () => {
                const roleEl = document.querySelector(".profile .role");
                const idEl = document.querySelector(".profile .userid");
                if (roleEl && roleEl.textContent.trim() === "")
                  roleEl.textContent = "è³£ä¸»";
                if (idEl && idEl.textContent.trim() === "")
                  idEl.textContent = "ID:æœªç™»å…¥";
              },
              { once: true }
            );
          } else {
            const roleEl = document.querySelector(".profile .role");
            const idEl = document.querySelector(".profile .userid");
            if (roleEl && roleEl.textContent.trim() === "")
              roleEl.textContent = "è³£ä¸»";
            if (idEl && idEl.textContent.trim() === "")
              idEl.textContent = "ID:æœªç™»å…¥";
          }
        });
    </script>
  </head>
  <body>
    <div class="app">
      <aside class="sidebar">
        <div class="profile">
          <div class="role">è³£ä¸»</div>
          <div class="userid">T6205518</div>
          <a class="edit" href="#">ç·¨è¼¯å€‹äººè³‡æ–™</a>
        </div>
        <nav class="menu">
          <ul>
            <li><a href="main.html">ğŸ  é¦–é </a></li>
            <li><a href="tasklist.html">ğŸ“‹ ä»»å‹™åˆ—è¡¨</a></li>
            <li><a href="tasker.html">âš™ï¸ æ‰¿æ¥ä»»å‹™ç®¡ç†</a></li>
          </ul>
        </nav>
      </aside>

      <main class="main">
        <header class="main-header">
          <h1>æ¡ˆä»¶ç®¡ç†</h1>
          <div class="tabs" role="tablist">
            <button class="tab active" data-status="published">åˆŠç™»ä¸­</button>
            <button class="tab" data-status="completed">å·²æˆäº¤</button>
            <button class="tab" data-status="review">å¯©æ ¸ä¸­</button>
            <button class="tab" data-status="rejected">æœªé€šé</button>
          </div>
        </header>

        <section class="content">
          <div id="case-area">
            <!-- ç©ºç‹€æ…‹ -->
            <div class="empty-state hidden" id="empty">
              <div class="illustration" aria-hidden="true"></div>
              <p class="empty-text">æ²’æœ‰åˆŠç™»ä¸­çš„æ¡ˆä»¶</p>
            </div>

            <!-- æ¡ˆä»¶åˆ—è¡¨ -->
            <div id="list" class="case-list"></div>

            <!-- æ°¸é é¡¯ç¤ºçš„åˆŠç™»æŒ‰éˆ• -->
            <div style="text-align: center; margin-top: 24px">
              <button id="publishBtn" class="primary">ç«‹å³åˆŠç™»</button>
            </div>
          </div>
        </section>
      </main>
    </div>

    <div id="newTaskModal" class="modal" aria-hidden="true">
      <div class="modal-content">
        <div class="task-modal">
          <button class="close-btn" id="closeNewTask">&times;</button>
          <h2>åˆŠç™»å¤–åŒ…ï¼Œäº«ä¸‰å¤§å„ªå‹¢</h2>

          <form id="newTaskForm" enctype="multipart/form-data">
            <div class="task-field">
              <label for="taskTitle">æ‚¨çš„éœ€æ±‚æ˜¯ä»€éº¼ï¼Ÿ</label>
              <input
                id="taskTitle"
                name="title"
                type="text"
                placeholder="æ‚¨çš„éœ€æ±‚æ˜¯ä»€éº¼ï¼Ÿ"
                required
              />
            </div>

            <div class="form-row">
              <div class="col task-field">
                <label for="taskBudget">é ç®—</label>
                <input
                  id="taskBudget"
                  name="budget"
                  type="text"
                  placeholder="è¼¸å…¥é ç®—ï¼Œä¾‹å¦‚ NT$1200 æˆ– é¢è­°"
                />
              </div>
              <div class="col task-field">
                <label for="taskRegion">åœ°å€</label>
                <select id="taskRegion" name="region" required>
                  <option value="">è«‹é¸æ“‡åœ°å€</option>
                  <option value="è‡ºåŒ—å¸‚">è‡ºåŒ—å¸‚</option>
                  <option value="æ–°åŒ—å¸‚">æ–°åŒ—å¸‚</option>
                  <option value="æ¡ƒåœ’å¸‚">æ¡ƒåœ’å¸‚</option>
                  <option value="è‡ºä¸­å¸‚">è‡ºä¸­å¸‚</option>
                  <option value="è‡ºå—å¸‚">è‡ºå—å¸‚</option>
                  <option value="é«˜é›„å¸‚">é«˜é›„å¸‚</option>
                  <option value="å®œè˜­ç¸£">å®œè˜­ç¸£</option>
                  <option value="æ–°ç«¹ç¸£">æ–°ç«¹ç¸£</option>
                  <option value="è‹—æ —ç¸£">è‹—æ —ç¸£</option>
                  <option value="å½°åŒ–ç¸£">å½°åŒ–ç¸£</option>
                  <option value="å—æŠ•ç¸£">å—æŠ•ç¸£</option>
                  <option value="é›²æ—ç¸£">é›²æ—ç¸£</option>
                  <option value="å˜‰ç¾©ç¸£">å˜‰ç¾©ç¸£</option>
                  <option value="å±æ±ç¸£">å±æ±ç¸£</option>
                  <option value="èŠ±è“®ç¸£">èŠ±è“®ç¸£</option>
                  <option value="è‡ºæ±ç¸£">è‡ºæ±ç¸£</option>
                  <option value="æ¾æ¹–ç¸£">æ¾æ¹–ç¸£</option>
                  <option value="åŸºéš†ç¸£">åŸºéš†ç¸£</option>
                  <option value="ä¸é™" selected>ä¸é™</option>
                </select>
              </div>
            </div>
            <div class="col task-field">
              <label for="taskClose">çµæ¡ˆæ—¥ï¼ˆé¸å¡«ï¼‰</label>
              <input id="taskClose" name="closed_at" type="date" />
            </div>

            <div class="task-field">
              <label for="taskMeta">ç”¨æ–¼å“ªå€‹æƒ…å¢ƒï¼Œç´°ç¯€èªªæ˜</label>
              <textarea
                id="taskMeta"
                name="description"
                placeholder="æè¿°ç´°ç¯€..."
              ></textarea>
            </div>

            <div class="task-field">
              <label for="taskFiles">é™„åŠ æ–‡ä»¶ï¼ˆåœ–ç‰‡ã€PDF ç­‰ï¼Œå¯å¤šé¸ï¼‰</label>
              <input
                id="taskFiles"
                name="taskFiles[]"
                type="file"
                multiple
                accept="image/*,application/pdf"
              />
              <div id="fileList" class="file-list"></div>
            </div>

            <div class="submit-row">
              <button type="submit" class="btn-submit">ç«‹å³å¤–åŒ…</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div id="contractModal" class="modal" aria-hidden="true">
      <div class="modal-content">
        <button class="close-btn" id="closeContractModal">&times;</button>
        <h3>æ¥æ¡ˆç®¡ç†</h3>
        <div id="contractList" style="margin: 12px 0"></div>
        <div style="text-align: right">
          <button id="assignConfirmBtn" class="primary">âœ… ç¢ºå®šæŒ‡æ´¾</button>
        </div>
      </div>
    </div>

    <!-- Replies Modal -->
    <div id="repliesModal" class="modal" aria-hidden="true">
      <div class="modal-content" style="max-width: 800px">
        <button class="close-btn" id="closeRepliesModal">&times;</button>
        <h3>æŸ¥çœ‹å›å¾©å…§å®¹</h3>
        <div
          id="repliesContainer"
          style="max-height: 60vh; overflow: auto; margin-top: 12px"
        ></div>

        <div class="modal-actions" style="margin-top: 12px">
          <button
            id="openIssuesBtn"
            class="primary"
            style="background: #009688; margin-right: auto"
          >
            å¾…è§£æ±ºäº‹é …ç®¡ç†
          </button>
          <span id="statusBtnContainer"></span>
          <button
            id="replyAcceptBtn"
            class="primary"
            style="background: #4caf50"
          >
            æ¥å—å ±åƒ¹
          </button>
          <button
            id="replyRejectBtn"
            class="primary"
            style="background: #f44336"
          >
            é€€ä»¶
          </button>
          <button id="replyCloseBtn" class="primary" style="background: #777">
            é—œé–‰
          </button>
        </div>
      </div>
    </div>
    <!-- Issues Modal -->
    <div id="issuesModal" class="modal" aria-hidden="true">
      <div
        class="modal-content"
        style="max-width: 900px; padding: 0; overflow: hidden; height: auto"
      >
        <button
          class="close-btn"
          id="closeIssuesModal"
          style="z-index: 10; top: 10px; right: 10px"
        >
          &times;
        </button>

        <div style="padding: 15px 20px; border-bottom: 1px solid #eee">
          <h3 style="margin: 0">æ¡ˆä»¶å”ä½œèˆ‡æºé€š</h3>
        </div>

        <div class="chat-layout">
          <div class="chat-sidebar">
            <div class="sidebar-header">
              <h4>å¾…è§£æ±ºäº‹é …</h4>
              <button id="addIssueBtn" class="add-issue-btn" title="æ–°å¢äº‹é …">
                +
              </button>
            </div>
            <div id="issueListContainer" class="issue-list-container"></div>
          </div>

          <div class="chat-main">
            <div id="chatHistory" class="chat-history"></div>

            <div id="chatInputArea" class="chat-input-area">
              <input
                type="text"
                id="chatInput"
                placeholder="è¼¸å…¥è¨Šæ¯... (è¼¸å…¥ã€ŒçµæŸissueã€ä»¥é—œé–‰æ­¤è¨è«–)"
              />
              <button
                id="chatSendBtn"
                class="primary"
                style="padding: 6px 16px"
              >
                é€å‡º
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const GET_TASKS_URL = "backend/get_cases.php";
      const CREATE_TASK_URL = "backend/create_task.php";
      const DELETE_TASK_URL = "backend/delete_task.php";
      const formData = new FormData(newTaskForm);

      async function deleteTask(id) {
        if (!confirm("ç¢ºå®šè¦åˆªé™¤é€™ç­†æ¡ˆä»¶å—ï¼Ÿ")) return;

        try {
          const resp = await fetch("backend/delete_task.php", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: `id=${encodeURIComponent(id)}`,
          });

          const result = await resp.json();
          if (result.success) {
            await fetchAndRenderTasks(); // âœ… æ­£ç¢ºå‡½å¼åç¨±
          } else {
            alert("åˆªé™¤å¤±æ•—ï¼š" + (result.message || "æœªçŸ¥éŒ¯èª¤"));
          }
        } catch (err) {
          console.error("åˆªé™¤éŒ¯èª¤", err);
          alert("ç¶²è·¯éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦");
        }
      }

      // ----- å¾å¾Œç«¯æŠ“å–ä»»å‹™ä¸¦æ¸²æŸ“ -----
      async function fetchAndRenderTasks() {
        try {
          const resp = await fetch(GET_TASKS_URL);
          if (!resp.ok) {
            const text = await resp.text();
            console.error("å–å¾—ä»»å‹™åˆ—è¡¨å¤±æ•—", resp.status, text);
            alert("ç„¡æ³•å–å¾—ä»»å‹™åˆ—è¡¨ï¼Œè«‹ç¨å¾Œå†è©¦");
            return;
          }

          const data = await resp.json();

          if (!Array.isArray(data)) {
            console.warn("å¾Œç«¯å›å‚³æ ¼å¼éŒ¯èª¤ï¼Œé æœŸç‚ºé™£åˆ—", data);
            alert("è³‡æ–™æ ¼å¼éŒ¯èª¤ï¼Œè«‹è¯çµ¡ç®¡ç†å“¡");
            return;
          }

          window.allTasks = data; // âœ… é—œéµï¼šè®“ editTask() èƒ½å­˜å–ä»»å‹™åˆ—è¡¨
          renderTaskList(data);
        } catch (err) {
          console.error("fetch tasks error", err);
          alert("ç¶²è·¯éŒ¯èª¤ï¼Œç„¡æ³•è¼‰å…¥ä»»å‹™åˆ—è¡¨");
        }
      }
      function editTask(id) {
        if (!Array.isArray(window.allTasks)) {
          console.warn("ä»»å‹™åˆ—è¡¨å°šæœªè¼‰å…¥");
          alert("è³‡æ–™å°šæœªè¼‰å…¥å®Œæˆï¼Œè«‹ç¨å¾Œå†è©¦");
          return;
        }

        const task = window.allTasks.find((t) => String(t.id) === String(id));
        if (!task) {
          console.warn("æ‰¾ä¸åˆ°è©²ç­†è³‡æ–™", id, window.allTasks);
          alert("æ‰¾ä¸åˆ°è©²ç­†è³‡æ–™");
          return;
        }

        // å¡«å…¥è¡¨å–®è³‡æ–™
        document.getElementById("taskTitle").value = task.title || "";
        document.getElementById("taskBudget").value = task.budget || "";
        document.getElementById("taskRegion").value = task.region || "";
        document.getElementById("taskMeta").value = task.description || "";
        document.getElementById("taskClose").value =
          task.closed_at?.split("T")[0] || "";

        newTaskForm.setAttribute("data-edit-id", task.id);
        newTaskForm.setAttribute(
          "data-original-attachments",
          JSON.stringify(task.attachments || [])
        );
        showModal();
      }
      function showModal() {
        newTaskModal.classList.remove("hide");
        newTaskModal.classList.add("show");
        newTaskModal.setAttribute("aria-hidden", "false");
        // focus ç¬¬ä¸€æ¬„ä½
        const first = newTaskForm.querySelector("input,select,textarea,button");
        if (first) first.focus();
        // é˜²æ­¢èƒŒæ™¯æ»¾å‹•
        document.body.style.overflow = "hidden";
      }

      async function toggleCompleted(id) {
        try {
          // --- 1. æ–°å¢æª¢æŸ¥é‚è¼¯ï¼šå–å¾—è©²æ¡ˆä»¶ä¸‹çš„æ‰€æœ‰ Issue ---
    const issueResp = await fetch(`${FETCH_ISSUES_URL}&project_id=${id}`);
    const issueData = await issueResp.json();

    if (issueData.success && issueData.issues) {
      // æª¢æŸ¥æ˜¯å¦é‚„æœ‰ä»»ä½• issue çš„ issue_is_opened æ˜¯ true æˆ– 1
      const hasOpenIssues = issueData.issues.some(
        (issue) => issue.issue_is_opened == true || issue.issue_is_opened == 1
      );

      if (hasOpenIssues) {
        alert("ç„¡æ³•çµæ¡ˆï¼šè©²æ¡ˆä»¶ä¸‹ä»æœ‰æœªè™•ç†å®Œæˆçš„å¾…è§£æ±ºäº‹é …ï¼");
        return; // æ””æˆªåŸ·è¡Œï¼Œä¸é€²è¡Œå¾ŒçºŒçµæ¡ˆå‹•ä½œ
      }
    }
    // --- 2. è‹¥ç„¡æœªå®Œæˆçš„ Issueï¼Œå‰‡ç¹¼çºŒåˆ‡æ›ç‹€æ…‹ ---
          const resp = await fetch("backend/toggle_completed.php", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: `id=${encodeURIComponent(id)}`,
          });

          const result = await resp.json();
          if (result.success) {
            await fetchAndRenderTasks(); // é‡æ–°è¼‰å…¥ä»»å‹™åˆ—è¡¨
    openRepliesModal(id);
          } else {
            alert("åˆ‡æ›å¤±æ•—ï¼š" + (result.message || "æœªçŸ¥éŒ¯èª¤"));
          }
        } catch (err) {
          console.error("åˆ‡æ›ç‹€æ…‹éŒ¯èª¤", err);
          alert("ç¶²è·¯éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦");
        }
      }
      (() => {
        // å…ƒä»¶åƒè€ƒ
        const publishBtn = document.getElementById("publishBtn");
        const newTaskModal = document.getElementById("newTaskModal");
        const modalContent = newTaskModal.querySelector(".modal-content");
        const closeNewTask = document.getElementById("closeNewTask");
        const newTaskForm = document.getElementById("newTaskForm");
        const taskFiles = document.getElementById("taskFiles");
        const fileList = document.getElementById("fileList");
        const listEl = document.getElementById("list");
        const emptyState = document.getElementById("empty");

        const GET_TASKS_URL = "backend/get_cases.php";
        const CREATE_TASK_URL = "backend/create_task.php";
        fetchAndRenderTasks();

        // ----- Modal é–‹é—œè™•ç† -----

        function hideModal() {
          // ä½¿ç”¨ hide class æ’­æ”¾é—œé–‰å‹•ç•«ï¼Œå†ç§»é™¤ show
          newTaskModal.classList.remove("show");
          newTaskModal.classList.add("hide");
          newTaskModal.setAttribute("aria-hidden", "true");
          document.body.style.overflow = "";
          // åœ¨å‹•ç•«çµæŸå¾Œå®Œå…¨éš±è— hide class
          setTimeout(() => {
            newTaskModal.classList.remove("hide");
          }, 420);
        }

        publishBtn.addEventListener("click", (e) => {
          e.preventDefault();
          showModal();
        });

        closeNewTask.addEventListener("click", (e) => {
          e.preventDefault();
          hideModal();
        });

        // é» modal èƒŒæ™¯é—œé–‰ï¼ˆè‹¥é»åˆ° content å‰‡ä¸é—œé–‰ï¼‰
        newTaskModal.addEventListener("click", (e) => {
          if (e.target === newTaskModal) hideModal();
        });

        // Esc é—œé–‰
        document.addEventListener("keydown", (e) => {
          if (e.key === "Escape" && newTaskModal.classList.contains("show")) {
            hideModal();
          }
        });

        // ----- æª”æ¡ˆé¡¯ç¤ºé è¦½ï¼ˆåƒ…æª”å / ç°¡å–®ç¸®åœ–ï¼‰ -----
        function renderFileList(files) {
          fileList.innerHTML = "";
          if (!files || files.length === 0) return;
          Array.from(files).forEach((f) => {
            const item = document.createElement("div");
            item.className = "file-item";
            // å¦‚æœæ˜¯åœ–ç‰‡å˜—è©¦é¡¯ç¤ºç¸®åœ–ï¼ˆä½¿ç”¨ FileReaderï¼‰
            if (f.type.startsWith("image/")) {
              const img = document.createElement("img");
              const reader = new FileReader();
              reader.onload = (ev) => {
                img.src = ev.target.result;
              };
              reader.readAsDataURL(f);
              item.appendChild(img);
            }
            const fname = document.createElement("span");
            fname.className = "fname";
            fname.textContent = f.name;
            item.appendChild(fname);
            fileList.appendChild(item);
          });
        }

        taskFiles.addEventListener("change", (e) => {
          renderFileList(e.target.files);
        });

        // ----- è¡¨å–®é€å‡ºï¼šPOST multipart/form-data -----
        newTaskForm.addEventListener("submit", async (e) => {
          e.preventDefault();

          const submitBtn = newTaskForm.querySelector('button[type="submit"]');
          submitBtn.disabled = true;
          submitBtn.textContent = "é€å‡ºä¸­...";

          const isEdit = newTaskForm.hasAttribute("data-edit-id");
          const editId = newTaskForm.getAttribute("data-edit-id");

          try {
            const formData = new FormData(newTaskForm); // âœ… å»ºç«‹ FormData

            // âœ… åŠ å…¥ poster_idï¼ˆæ”¾åœ¨å»ºç«‹ FormData ä¹‹å¾Œï¼‰
            if (window.currentUserId) {
              formData.append("poster_id", window.currentUserId);
            }

            // âœ… è™•ç† closed_at ç©ºå€¼
            const closedAt = formData.get("closed_at");
            if (closedAt === "") {
              formData.delete("closed_at"); // âœ… è®“å¾Œç«¯è‡ªç„¶åˆ¤æ–·ç‚º null
            }
            // âœ… è‹¥æ˜¯ç·¨è¼¯æ¨¡å¼ï¼ŒåŠ å…¥ id
            if (isEdit) formData.append("id", editId);

            // âœ… è‹¥æœªé‡æ–°ä¸Šå‚³æª”æ¡ˆï¼Œä¿ç•™åŸå§‹ attachments
            const files = taskFiles.files;
            if (files.length === 0) {
              const original = newTaskForm.getAttribute(
                "data-original-attachments"
              );
              if (original) formData.append("attachments", original);
            }

            // ====== æŠŠé€™æ®µæ›¿æ›åŸæœ¬çš„ fetch å‘¼å« ======
            const resp = await fetch(
              isEdit ? "backend/update_task.php" : CREATE_TASK_URL,
              {
                method: "POST",
                body: formData,
                credentials: "same-origin", // è‹¥ç‚ºè·¨åŸŸä¸”å¾Œç«¯å…è¨±å¸¶ cookieï¼Œæ”¹ç‚º "include"
              }
            );
            // ====== æ›¿æ›çµæŸ ======

            if (!resp.ok) {
              const text = await resp.text();
              console.error("ä»»å‹™é€å‡ºå¤±æ•—", resp.status, text);
              alert("é€å‡ºå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
              return;
            }

            await fetchAndRenderTasks();
            hideModal();
            newTaskForm.reset();
            fileList.innerHTML = "";
            newTaskForm.removeAttribute("data-edit-id");
            newTaskForm.removeAttribute("data-original-attachments");
          } catch (err) {
            console.error(err);
            alert("ç¶²è·¯éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦");
          } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = "ç«‹å³å¤–åŒ…";
          }
        });

        let selectedContractor = null;
        let currentTaskId = null;

        function manageContract(taskId) {
          currentTaskId = taskId;
          fetch("backend/get_intents.php?task_id=" + taskId)
            .then((res) => res.json())
            .then((data) => {
              if (!Array.isArray(data) || data.length === 0) {
                alert("ç›®å‰å°šç„¡äººæå‡ºæ¥æ¡ˆæ„é¡˜");
                return;
              }

              const listEl = document.getElementById("contractList");
              listEl.innerHTML = "";

              data.forEach((user, idx) => {
                const btn = document.createElement("button");
                btn.textContent = user.username;
                btn.className = "primary";
                btn.style.margin = "6px";
                btn.onclick = () => {
                  selectedContractor = user.username;
                  [...listEl.children].forEach((b) =>
                    b.classList.remove("active")
                  );
                  btn.classList.add("active");
                };
                listEl.appendChild(btn);
              });

              showContractModal();
            })
            .catch((err) => {
              console.error("å–å¾—æ¥æ¡ˆäººå¤±æ•—", err);
              alert("ç„¡æ³•å–å¾—æ¥æ¡ˆäººè³‡æ–™");
            });
        }
        // 1) æš´éœ²å‡½å¼åˆ°å…¨åŸŸï¼Œæ”¾åœ¨ manageContract å®šç¾©çµæŸä¹‹å¾Œ
        window.manageContract = manageContract;
        window.showContractModal = showContractModal;
        window.hideContractModal = hideContractModal;
        window.confirmContract = confirmContract;

        // 2) ç¶å®š modal ä¸Šçš„ DOM æŒ‰éˆ•ï¼ˆæ”¾åœ¨ IIFE å…§ã€modal element çš†å¯å­˜å–ä¹‹å¾Œï¼‰
        const assignBtn = document.getElementById("assignConfirmBtn");
        if (assignBtn) assignBtn.addEventListener("click", confirmContract);

        const closeContractBtn = document.getElementById("closeContractModal");
        if (closeContractBtn)
          closeContractBtn.addEventListener("click", hideContractModal);

        // 3)ï¼ˆé¸ç”¨ï¼‰é» modal èƒŒæ™¯é—œé–‰ï¼ˆè‹¥å°šæœªç¶ï¼‰
        const contractModalEl = document.getElementById("contractModal");
        if (contractModalEl) {
          contractModalEl.addEventListener("click", (e) => {
            if (e.target === contractModalEl) hideContractModal();
          });
        }

        function showContractModal() {
          const modal = document.getElementById("contractModal");
          modal.classList.add("show");
          modal.setAttribute("aria-hidden", "false");
          document.body.style.overflow = "hidden";
        }

        function hideContractModal() {
          const modal = document.getElementById("contractModal");
          modal.classList.remove("show");
          modal.setAttribute("aria-hidden", "true");
          document.body.style.overflow = "";
          selectedContractor = null;
        }

        function confirmContract() {
          if (!selectedContractor || !currentTaskId) {
            alert("è«‹å…ˆé¸æ“‡æ¥æ¡ˆäºº");
            return;
          }

          fetch("backend/assign_contractor.php", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: `task_id=${encodeURIComponent(
              currentTaskId
            )}&contractor=${encodeURIComponent(selectedContractor)}`,
          })
            .then((res) => res.json())
            .then((data) => {
              if (data.success) {
                alert("âœ… å·²æˆåŠŸæŒ‡æ´¾æ¥æ¡ˆäºº");
                hideContractModal();
                fetchAndRenderTasks();
              } else {
                alert("âŒ æŒ‡æ´¾å¤±æ•—ï¼š" + (data.message || "æœªçŸ¥éŒ¯èª¤"));
              }
            })
            .catch((err) => {
              console.error("æŒ‡æ´¾éŒ¯èª¤", err);
              alert("âš ï¸ ç¶²è·¯éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦");
            });
        }

        // ----- å¾å¾Œç«¯æŠ“å–ä»»å‹™ä¸¦æ¸²æŸ“ -----

        function renderTaskList(items) {
          console.log("å–å¾—ä»»å‹™åˆ—è¡¨", items);
          listEl.innerHTML = "";

          // âœ… éæ¿¾åªé¡¯ç¤ºå±¬æ–¼ç›®å‰ä½¿ç”¨è€…çš„æ¡ˆä»¶
          const currentUserId = String(window.currentUserId || "");
          items = items.filter((it) => String(it.poster_id) === currentUserId);
          console.log("ç›®å‰ä½¿ç”¨è€… ID", window.currentUserId);
          if (!items || items.length === 0) {
            emptyState.classList.remove("hidden");
            return;
          }
          emptyState.classList.add("hidden");

          // å› ç‚ºæª”æ¡ˆå¯¦éš›å­˜åœ¨ D:\... \www\web\uploadsï¼Œå°æ‡‰åˆ°ç¶²é è·¯å¾‘é€šå¸¸æ˜¯ /web/uploads/
          // å¦‚æœä½ çš„ä¼ºæœå™¨è¨­å®šä¸åŒï¼ˆä¾‹å¦‚ /uploads/ æˆ– /backend/uploads/ï¼‰ï¼Œè«‹èª¿æ•´æ­¤å¸¸æ•¸
          const BASE_UPLOAD_PREFIX = "/web/backend/uploads/";

          items.forEach((it) => {
            const item = document.createElement("div");
            item.className = "case-item";

            const avatar = it.avatar || "ğŸ‘¤";
            const username = it.username || it.title || "åŒ¿åä½¿ç”¨è€…";
            const phone = it.phone || it.contact || "";
            const published_at = it.published_at
              ? new Date(it.published_at).toLocaleString()
              : it.created_at
              ? new Date(it.created_at).toLocaleString()
              : "";
            const region = it.region || "ä¸é™";

            // è§£æ attachmentsï¼ˆæ”¯æ´å­—ä¸²æˆ–é™£åˆ—ï¼‰
            let attachments = [];
            try {
              if (
                typeof it.attachments === "string" &&
                it.attachments.trim() !== ""
              ) {
                attachments = JSON.parse(it.attachments);
              } else if (Array.isArray(it.attachments)) {
                attachments = it.attachments;
              }
            } catch (err) {
              console.warn("é™„ä»¶è§£æå¤±æ•—", err, it.attachments);
              attachments = [];
            }

            // normalizeUrl æ”¯æ´ a.url / a.path / Windows pathï¼ˆæŠŠåæ–œç·šæ”¹æ–œç·šï¼‰ä¸¦è£œä¸Š BASE_UPLOAD_PREFIX
            const normalizeUrl = (a) => {
              if (!a) return null;
              // è‹¥æœ‰ç›´æ¥å¯ç”¨çš„ url æ¬„ä½
              if (a.url && typeof a.url === "string" && a.url.trim() !== "")
                return a.url;

              let p = a.path || a.file_name || a.filename || a.orig_name || "";
              if (!p) return null;

              // æŠŠåæ–œç·šæ›æˆæ­£æ–œç·š
              p = p.replace(/\\/g, "/").trim();

              // å¦‚æœçœ‹èµ·ä¾†åƒå·²ç¶“æ˜¯ç›¸å° uploads/xxx è·¯å¾‘ï¼Œä¿è­‰æœ€å¾Œçµæœç‚º /web/uploads/xxx
              // å¸¸è¦‹å¾Œç«¯å­˜æ³•å¯èƒ½æ˜¯ "uploads/xxx.png" æˆ– "web/uploads/xxx.png"
              // ç§»é™¤é–‹é ­çš„æ–œç·šï¼Œå¾Œé¢ç”¨ BASE_UPLOAD_PREFIX æ¥åˆ
              if (p.startsWith("/")) p = p.replace(/^\/+/, "");

              // å¦‚æœ path å·²åŒ…å« 'web/uploads'ï¼Œå»æ‰é‡è¤‡éƒ¨åˆ†
              if (p.startsWith("/backend/uploads//")) {
                return "/" + p; // è®Šæˆ /web/uploads/xxx
              }
              // å¦‚æœ path é–‹é ­æ˜¯ 'uploads/'ï¼Œæ¥ä¸Š BASE_UPLOAD_PREFIX
              if (p.startsWith("uploads/")) {
                return (
                  BASE_UPLOAD_PREFIX.replace(/\/$/, "") +
                  "/" +
                  p.replace(/^uploads\//, "")
                );
              }

              // å¦å‰‡ï¼Œç›´æ¥æŠŠ path ç•¶ä½œæª”åæ¥åˆ°å‰ç¶´ä¸Š
              return BASE_UPLOAD_PREFIX.replace(/\/$/, "") + "/" + p;
            };

            // ç”¢ç”Ÿåœ–ç‰‡ HTMLï¼ˆåƒ…å– image é¡å‹ï¼‰
            const imagePreview = attachments
              .map((a) => {
                const mime = a && (a.mime || a.type || "");
                const src = normalizeUrl(a);
                const name =
                  a && (a.filename || a.orig_name || a.file_name || "");
                if (!src) return null;
                // è‹¥æœ‰ mimeï¼Œåƒ…è™•ç† image/*
                if (mime && typeof mime === "string") {
                  if (!mime.startsWith("image/")) return null;
                }
                return `<img src="${escapeHtml(src)}" alt="${escapeHtml(
                  name
                )}" style="max-width:100px;max-height:80px;border-radius:6px;margin-top:8px;" />`;
              })
              .filter(Boolean)
              .join("");

            // è‹¥ç„¡åœ–ä½† attachments æœ‰å…§å®¹ï¼Œå°å‡º debug è¨Šæ¯ï¼ˆæ–¹ä¾¿æ’éŒ¯ï¼‰
            if (!imagePreview && attachments.length > 0) {
              console.debug(
                "attachments (parsed) for item",
                it.id,
                attachments
              );
            }

            item.innerHTML = `
              <div style="display: flex; gap: 12px; align-items: flex-start">
                <div style="font-size: 20px; line-height: 1">${avatar}</div>
                <div style="flex: 1">
                  <div><strong>${escapeHtml(username)}</strong></div>
                  <div class="case-meta">ç™¼ä½ˆè€… ID: ${escapeHtml(
                    it.poster_id
                  )}</div>
                  <div class="case-meta">é ç®—: NT$${escapeHtml(it.budget)}</div>
                  <div class="case-meta">åœ°å€: ${escapeHtml(region)}</div>
                  <div class="case-meta">ç™¼ä½ˆ: ${escapeHtml(published_at)}</div>
                  ${
                    imagePreview
                      ? `
                  <div class="case-meta">é™„åœ–ï¼š<br />${imagePreview}</div>
                  `
                      : ""
                  }
                </div>
              </div>
              <div style="margin-top:12px;display:flex;flex-direction:column;gap:12px;">
                <button class="primary" style="padding:10px;background:#6a1b9a;" onclick="openRepliesModal(${
                  it.id
                })">æŸ¥çœ‹å›å¾©</button>
  <button class="primary" style="padding:10px;" onclick="deleteTask(${
    it.id
  })">åˆªé™¤</button>
  <button class="primary" style="padding:10px;background:#007bff;" onclick="editTask(${
    it.id
  })">æ›´æ”¹</button>
  <button class="primary" style="padding:10px;background:#ffa726;" onclick="manageContract(${
    it.id
  })">æ¥æ¡ˆç®¡ç†</button>
</div>

            `;

            listEl.appendChild(item);
          });
        }

        // ç°¡å–®é˜² XSS çš„ escape
        function escapeHtml(str) {
          if (!str && str !== 0) return "";
          return String(str)
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#39;");
        }

        window.renderTaskList = renderTaskList;

        // åˆå§‹è¼‰å…¥
        fetchAndRenderTasks();
      })();
      // replies modal logic
      const REPLIES_URL = "backend/get_replies.php"; // GET ?task_id=
      const ACCEPT_REPLY_URL = "backend/accept_reply.php"; // POST { reply_id, task_id }
      const REJECT_REPLY_URL = "backend/reject_reply.php"; // POST { reply_id }

      let currentRepliesTaskId = null;
      let selectedReplyId = null;

      function openRepliesModal(taskId) {
  currentRepliesTaskId = taskId;
  selectedReplyId = null;
  const modal = document.getElementById("repliesModal");
  const container = document.getElementById("repliesContainer");
  const statusBtnContainer = document.getElementById("statusBtnContainer"); // å–å¾—æŒ‰éˆ•å®¹å™¨

  container.innerHTML = "<p>è¼‰å…¥ä¸­â€¦</p>";
  statusBtnContainer.innerHTML = ""; // æ¸…ç©ºèˆŠçš„æŒ‰éˆ•
  
  modal.classList.add("show");
  modal.setAttribute("aria-hidden", "false");
  document.body.style.overflow = "hidden";

  fetch(`${REPLIES_URL}?task_id=${encodeURIComponent(taskId)}`, {
    credentials: "same-origin",
  })
    .then((r) => {
      if (!r.ok) throw new Error("Fetch replies failed");
      return r.json();
    })
    .then((data) => {
      // å‡è¨­å¾Œç«¯ data çµæ§‹æ˜¯ { replies: [...], task_status: "t", task_id: 123 }
      // æˆ–è€… data æ˜¯ä¸€å€‹é™£åˆ—ï¼Œä½ éœ€è¦å¾å…¨è®Šæ•¸ allTasks æ‰¾å‡ºè©² taskId çš„ç‹€æ…‹
      
      // ç¯„ä¾‹ï¼šå¾å…¨åŸŸè®Šæ•¸å°‹æ‰¾ç•¶å‰ä»»å‹™ç‰©ä»¶ï¼ˆå‡è¨­ä½ çš„ä¸»æ¸…å–®è³‡æ–™å­˜åœ¨ allTasksï¼‰
      const currentTask = allTasks.find(t => t.id == taskId);
      
      if (currentTask) {
        renderStatusButton(statusBtnContainer, currentTask);
      }

      renderRepliesList(container, data.replies || data); 
    })
    .catch((err) => {
      console.error("get replies error", err);
      container.innerHTML = `<p style="color:#e53935">å–å¾—å›å¾©å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦</p>`;
    });
}

// æ¸²æŸ“æŒ‰éˆ•çš„è¼”åŠ©å‡½æ•¸
// åœ¨ openRepliesModal æ¸²æŸ“æ™‚ï¼Œå¦‚æœç™¼ç¾æœ‰ open issuesï¼Œå¯è®“æŒ‰éˆ•ä¸å¯é»æ“Š
function renderStatusButton(targetElement, task, hasOpenIssues) {
  const isCompleted = task.is_completed === true || task.is_completed === "t";
  
  targetElement.innerHTML = `
    <button onclick="${hasOpenIssues ? 'alert(\'è«‹å…ˆè™•ç†å®Œå¾…è§£æ±ºäº‹é …\')' : `toggleCompleted(${task.id})`}" 
      style="padding:10px; opacity: ${hasOpenIssues && !isCompleted ? '0.5' : '1'}; background:${isCompleted ? '#4CAF50' : '#f44336'}; color:white; border:none; border-radius:6px; cursor:pointer;">
      ${isCompleted ? 'âœ… å·²çµæ¡ˆ' : 'â³ æœªçµæ¡ˆ'}
    </button>
  `;
}

      function closeRepliesModal() {
        const modal = document.getElementById("repliesModal");
        modal.classList.remove("show");
        modal.setAttribute("aria-hidden", "true");
        document.body.style.overflow = "";
        currentRepliesTaskId = null;
        selectedReplyId = null;
      }

      document
        .getElementById("closeRepliesModal")
        .addEventListener("click", closeRepliesModal);
      document
        .getElementById("replyCloseBtn")
        .addEventListener("click", closeRepliesModal);

      function renderRepliesList(container, replies) {
        if (!Array.isArray(replies) || replies.length === 0) {
          container.innerHTML = "<p>ç›®å‰é‚„æ²’æœ‰å›å¾©ã€‚</p>";
          return;
        }

        // build list
        container.innerHTML = "";
        replies.forEach((r) => {
          // r: { id, task_id, responder_id, price_text, message, attachments(json), status, created_at, responder_name? }
          const div = document.createElement("div");
          div.className = "case-item";
          div.style.flexDirection = "column";
          div.style.alignItems = "stretch";
          div.style.marginBottom = "8px";

          const header = document.createElement("div");
          header.style.display = "flex";
          header.style.justifyContent = "space-between";
          header.style.alignItems = "center";

          const left = document.createElement("div");
          left.innerHTML = `<strong>${escapeHtml(
            r.responder_name || "#" + r.responder_id
          )}</strong>
                        <div class="case-meta">å ±åƒ¹: ${escapeHtml(
                          r.price_text
                        )}</div>
                        <div class="case-meta">ç‹€æ…‹: ${escapeHtml(
                          r.status
                        )}</div>
                        <div class="case-meta">å›è¦†æ™‚é–“: ${escapeHtml(
                          r.created_at || ""
                        )}</div>`;

          header.appendChild(left);

          const right = document.createElement("div");
          right.innerHTML = `<button class="primary" style="padding:8px;background:${
            r.status === "accepted" ? "#4caf50" : "#007bff"
          }" data-reply-id="${r.id}">${
            r.status === "accepted" ? "å·²æ¥å—" : "é¸æ“‡"
          }</button>`;
          // button will be clickable to select this reply
          const chooseBtn = right.querySelector("button");
          chooseBtn.addEventListener("click", () => {
            // mark selected visually
            selectedReplyId = r.id;
            // highlight selection
            container.querySelectorAll(".case-item").forEach((el) => {
              el.style.boxShadow = "";
              el.style.border = "1px solid #eef2f6";
            });
            div.style.boxShadow = "0 4px 18px rgba(0,0,0,0.06)";
            div.style.border = "1px solid #b39ddb";
          });

          header.appendChild(right);
          div.appendChild(header);

          // message (å¯ç‚ºç©º)
          if (r.message) {
            const msg = document.createElement("div");
            msg.style.marginTop = "8px";
            msg.innerHTML = `<div style="font-weight:600">è¨Šæ¯</div><div style="white-space:pre-wrap">${escapeHtml(
              r.message
            )}</div>`;
            div.appendChild(msg);
          }

          // attachments: æ”¯æ´é™£åˆ—æˆ– JSON å­—ä¸²
          let attachments = [];
          try {
            if (
              typeof r.attachments === "string" &&
              r.attachments.trim() !== ""
            )
              attachments = JSON.parse(r.attachments);
            else if (Array.isArray(r.attachments)) attachments = r.attachments;
          } catch (err) {
            attachments = [];
          }

          if (attachments.length > 0) {
            const attWrap = document.createElement("div");
            attWrap.style.marginTop = "8px";
            attWrap.innerHTML = "<div style='font-weight:600'>é™„ä»¶</div>";
            const grid = document.createElement("div");
            grid.style.display = "flex";
            grid.style.flexWrap = "wrap";
            grid.style.gap = "8px";
            attachments.forEach((a) => {
              const aEl = document.createElement("div");
              aEl.className = "file-item";
              aEl.style.width = "140px";
              aEl.style.cursor = "pointer";
              // normalize url logic (use path/url/file_name)
              const src = (
                a.url ||
                a.path ||
                a.file_name ||
                a.filename ||
                a.orig_name ||
                ""
              )
                .toString()
                .replace(/\\/g, "/");
              const mime = (a.mime || a.type || "").toString();
              if (
                mime.startsWith("image/") ||
                src.match(/\.(jpe?g|png|gif|webp)(\?.*)?$/i)
              ) {
                aEl.innerHTML = `<img src="${escapeHtml(
                  src
                )}" alt="${escapeHtml(
                  a.orig_name || a.file_name || "file"
                )}" style="max-width:120px;max-height:90px;display:block;margin-bottom:6px;border-radius:6px" /><div class="fname">${escapeHtml(
                  a.orig_name || a.file_name || a.filename || "file"
                )}</div>`;
                aEl.addEventListener("click", () => window.open(src, "_blank"));
              } else {
                aEl.innerHTML = `<div style="font-size:12px;padding:10px;">ğŸ“„ ${escapeHtml(
                  a.orig_name || a.file_name || a.filename || "file"
                )}</div>`;
                aEl.addEventListener("click", () => window.open(src, "_blank"));
              }
              grid.appendChild(aEl);
            });
            attWrap.appendChild(grid);
            div.appendChild(attWrap);
          }

          container.appendChild(div);
        });

        // ensure no selection initially
        selectedReplyId = null;
      }

      // accept/reject button handlers
      document
        .getElementById("replyAcceptBtn")
        .addEventListener("click", async () => {
          if (!selectedReplyId) return alert("è«‹å…ˆåœ¨ä¸Šæ–¹é¸æ“‡ä¸€ç­†å›å¾©");
          if (!confirm("ç¢ºå®šæ¥å—æ­¤å›å¾©ä¸¦æŒ‡æ´¾æ‰¿æ¥è€…ï¼Ÿ")) return;
          try {
            const form = new FormData();
            form.append("reply_id", selectedReplyId);
            form.append("task_id", currentRepliesTaskId);
            const resp = await fetch(ACCEPT_REPLY_URL, {
              method: "POST",
              body: form,
              credentials: "same-origin",
            });
            const j = await resp.json();
            if (j.success) {
              alert("å·²æ¥å—");
              // refresh replies list and tasks
              openRepliesModal(currentRepliesTaskId);
              if (typeof fetchAndRenderTasks === "function")
                fetchAndRenderTasks();
            } else {
              alert("æ¥å—å¤±æ•—ï¼š" + (j.message || ""));
            }
          } catch (err) {
            console.error("accept error", err);
            alert("ç¶²è·¯éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦");
          }
        });

      document
        .getElementById("replyRejectBtn")
        .addEventListener("click", async () => {
          if (!selectedReplyId) return alert("è«‹å…ˆåœ¨ä¸Šæ–¹é¸æ“‡ä¸€ç­†å›å¾©");
          if (!confirm("ç¢ºå®šé€€ä»¶æ­¤å›å¾©ï¼Ÿ")) return;
          try {
            const form = new FormData();
            form.append("reply_id", selectedReplyId);
            const resp = await fetch(REJECT_REPLY_URL, {
              method: "POST",
              body: form,
              credentials: "same-origin",
            });
            const j = await resp.json();
            if (j.success) {
              alert("å·²é€€ä»¶");
              openRepliesModal(currentRepliesTaskId);
              if (typeof fetchAndRenderTasks === "function")
                fetchAndRenderTasks();
            } else {
              alert("é€€ä»¶å¤±æ•—ï¼š" + (j.message || ""));
            }
          } catch (err) {
            console.error("reject error", err);
            alert("ç¶²è·¯éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦");
          }
        });

      // reuse escapeHtml from page or define here
      function escapeHtml(str) {
        if (str === null || str === undefined) return "";
        return String(str)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#39;");
      }
      /* --- æ–°å¢/ä¿®æ”¹ï¼šå¾…è§£æ±ºäº‹é …èˆ‡èŠå¤©å®¤é‚è¼¯ (æ•´åˆ DB API) --- */

      // åœ¨ä½ çš„ <script> å€å¡Šå…§
      // åŸæœ¬: const FETCH_ISSUES_URL = "/issue.php/api/issues/list";

      // --- ä¿®æ”¹å¾Œ ---
      const BASE_API_URL = "backend/issue.php"; // ç¢ºä¿é€™æ˜¯ issue.php çš„çµ•å°æˆ–ç›¸å°è·¯å¾‘

      const FETCH_ISSUES_URL = `${BASE_API_URL}?action=issues/list`;
      const CREATE_ISSUE_URL = `${BASE_API_URL}?action=issues/create`;
      const RESOLVE_ISSUE_URL = `${BASE_API_URL}?action=issues/resolve`;
      const FETCH_COMMENTS_URL = `${BASE_API_URL}?action=issues/comments`;
      const CREATE_COMMENT_URL = `${BASE_API_URL}?action=issue/comment/create`;
      // --- ç‹€æ…‹ç®¡ç† (ä¿ç•™) ---
      let currentIssueTaskId = null;
      let currentSelectedIssueId = null;
      const commentCache = {};
      // ... ä¿æŒå…¶ä»– JS é‚è¼¯ä¸è®Š ...
      // --- 1. å½ˆçª—é–‹å•Ÿèˆ‡é—œé–‰ ---

      document
        .getElementById("openIssuesBtn")
        .addEventListener("click", function () {
          if (
            typeof currentRepliesTaskId !== "undefined" &&
            currentRepliesTaskId
          ) {
            openIssuesModal(currentRepliesTaskId);
          } else {
            alert("ç„¡æ³•å–å¾—æ¡ˆä»¶ ID");
          }
        });

      window.openIssuesModal = async function (taskId) {
  if (!window.currentUserId) {
    alert("è«‹å…ˆç™»å…¥æˆ–ç­‰å¾…ä½¿ç”¨è€…è³‡è¨Šè¼‰å…¥å®Œæˆã€‚");
    return;
  }

  currentIssueTaskId = taskId;
  currentSelectedIssueId = null;

  const modal = document.getElementById("issuesModal");
  const addIssueBtn = document.getElementById("addIssueBtn"); // å–å¾—æ–°å¢æŒ‰éˆ•

  // --- ğŸ’¡ éš±è—/é¡¯ç¤ºæ–°å¢æŒ‰éˆ•é‚è¼¯ ---
  // å¾ä¸»æ¸…å–®è®Šæ•¸ (å‡è¨­ç‚º allTasks) æ‰¾å‡ºè©²æ¡ˆä»¶
  // æ³¨æ„ï¼šè«‹ç¢ºä¿ä½ çš„ fetchAndRenderTasks æˆåŠŸå¾Œæœ‰å°‡è³‡æ–™å­˜å…¥ allTasks
  const currentTask = allTasks.find(t => t.id == taskId);

  if (currentTask) {
    // åˆ¤æ–·æ¡ˆä»¶æ˜¯å¦å·²çµæ¡ˆ (ç›¸å®¹å¸ƒæ—å€¼ true æˆ–è³‡æ–™åº«å­—ä¸² "t")
    const isTaskCompleted = currentTask.is_completed === true || currentTask.is_completed === "t";

    if (addIssueBtn) {
      if (isTaskCompleted) {
        // è‹¥å·²çµæ¡ˆï¼Œéš±è—æ–°å¢æŒ‰éˆ•
        addIssueBtn.style.display = "none";
      } else {
        // è‹¥æœªçµæ¡ˆï¼Œé¡¯ç¤ºæ–°å¢æŒ‰éˆ• (flex æ˜¯ç‚ºäº†ç¶­æŒåŸæœ‰çš„ UI æ’ç‰ˆ)
        addIssueBtn.style.display = "flex";
      }
    }
  }
  // ---------------------------------

  modal.classList.add("show");
  modal.setAttribute("aria-hidden", "false");
  document.body.style.overflow = "hidden";

  try {
    await fetchAndRenderIssues(taskId);
  } catch (error) {
    console.error("Open Issues Modal failed to load data:", error);
    alert("è¼‰å…¥å¾…è§£æ±ºäº‹é …å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ã€‚");
  }
  
  // æ¸²æŸ“èŠå¤©å€
  renderChatHistory();
};
      function closeIssuesModal() {
        const modal = document.getElementById("issuesModal");
        modal.classList.remove("show");
        modal.setAttribute("aria-hidden", "true");
        document.body.style.overflow = "";
        currentIssueTaskId = null;
        currentSelectedIssueId = null;
      }

      // ç¶å®šé—œé–‰äº‹ä»¶
      document
        .getElementById("closeIssuesModal")
        .addEventListener("click", closeIssuesModal);
      document.getElementById("issuesModal").addEventListener("click", (e) => {
        if (e.target === document.getElementById("issuesModal"))
          closeIssuesModal();
      });

      // --- 2. äº‹é …åˆ—è¡¨é‚è¼¯ (CRUD) ---

      // ç²å–ä¸¦æ¸²æŸ“äº‹é …
      // boss.html:1568 é™„è¿‘
      async function fetchAndRenderIssues(taskId) {
        const issueListContainer =
          document.getElementById("issueListContainer");
        issueListContainer.innerHTML = `<div style="text-align:center; padding: 20px; font-size:12px;">è¼‰å…¥ä¸­...</div>`;

        try {
          const resp = await fetch(`${FETCH_ISSUES_URL}&project_id=${taskId}`);
          // --- é—œéµæ–°å¢é‚è¼¯ ---
          // æª¢æŸ¥ Content-Type Header æ˜¯å¦ç‚º JSON
          const contentType = resp.headers.get("content-type");
          if (!contentType || !contentType.includes("application/json")) {
            // å¦‚æœä¸æ˜¯ JSONï¼Œå‰‡è®€å–å›æ‡‰æ–‡æœ¬ï¼Œä¸¦æ‹‹å‡ºéŒ¯èª¤
            const errorText = await resp.text();
            console.error("Non-JSON Response Received:", errorText);
            throw new Error(
              "ä¼ºæœå™¨å›æ‡‰é JSON æ ¼å¼ï¼Œè«‹æª¢æŸ¥ä¼ºæœå™¨éŒ¯èª¤æ—¥èªŒæˆ– API ç¶²å€ï¼"
            );
          }
          // --- é—œéµæ–°å¢é‚è¼¯çµæŸ ---

          // å¦‚æœå›æ‡‰æ˜¯ JSONï¼Œå‰‡ç¹¼çºŒè§£æ
          const data = await resp.json();

          if (data.success && data.issues) {
            renderIssueList(data.issues);
            allIssues = data.issues || [];
          } else {
            issueListContainer.innerHTML = `<div style="color:red; text-align:center; padding: 20px; font-size:12px;">è¼‰å…¥äº‹é …å¤±æ•—: ${
              data.message || "æœªçŸ¥éŒ¯èª¤"
            }</div>`;
          }
        } catch (err) {
          console.error("Fetch issues error:", err);
          // å°‡éŒ¯èª¤è¨Šæ¯é¡¯ç¤ºåœ¨ç•«é¢ä¸Šï¼Œæ–¹ä¾¿æª¢æŸ¥
          issueListContainer.innerHTML = `<div style="color:red; text-align:center; padding: 20px; font-size:12px;">
            API è«‹æ±‚éŒ¯èª¤ï¼š${err.message || "ç„¡æ³•é€£ç·šæˆ–è§£æè³‡æ–™"}
            <br>
            è«‹æª¢æŸ¥ Console å…§æ˜¯å¦æœ‰ 'Non-JSON Response Received' è¨Šæ¯ã€‚
        </div>`;
        }
      }

      // æ¸²æŸ“äº‹é …åˆ—è¡¨ UI
      // åœ¨ä½ çš„ <script> å€å¡Šå…§ï¼Œä¿®æ”¹ renderIssueList å‡½å¼ï¼š

      function renderIssueList(issues) {
        const container = document.getElementById("issueListContainer");
        container.innerHTML = "";

        issues.forEach((issue) => {
          const div = document.createElement("div");
          div.className = "issue-item";

          // 1. è™•ç†æ—¥æœŸæ ¼å¼åŒ– (åªå–å‰ 10 ä½å­—å…ƒ: YYYY-MM-DD)
          const rawDate = issue.created_at || "";
          const formattedDate = rawDate.includes(" ")
            ? rawDate.split(" ")[0]
            : rawDate.slice(0, 10);

          // 2. è™•ç†ç´…ç¶ ç‡ˆé‚è¼¯ (false=ç¶ è‰²/è™•ç†ä¸­, true=ç´…è‰²/å·²çµæ¡ˆ)
          const isClosed =
            issue.issue_is_opened == true || issue.issue_is_opened == 1;
          const statusChar = isClosed ? "ğŸ”´" : "ğŸŸ¢";
          const statusColor = isClosed ? "#e53935" : "#2e7d32";

          div.innerHTML = `
            <span class="issue-status" style="color: ${statusColor}">${statusChar}</span>
            <span class="issue-title">${escapeHtml(issue.title)}</span>
            <span class="issue-date">${formattedDate}</span>
        `;

          div.onclick = () => selectIssue(issue.id);
          container.appendChild(div);
        });
      }

      // æ–°å¢äº‹é …
      // ç¶å®šå·¦å´åˆ—è¡¨ä¸Šæ–¹çš„ "+" æŒ‰éˆ•
      document.getElementById("addIssueBtn").onclick = function () {
        // ğŸš¨ ä¿®æ­£ï¼šç¢ºä¿ container æœ‰è¢«å®šç¾©
        const container = document.getElementById("issueListContainer");

        if (!container) {
          console.error("æ‰¾ä¸åˆ° issueListContainerï¼Œè«‹æª¢æŸ¥ HTML ID æ˜¯å¦æ­£ç¢º");
          return;
        }

        if (document.querySelector(".issue-item.creating")) return;

        const newItem = document.createElement("div");
        newItem.className = "issue-item opened creating";
        newItem.id = "issue-temp-new-issue";

        // æ–°å¢æ™‚é è¨­ç‚ºè™•ç†ä¸­ï¼Œæ‰€ä»¥é¡¯ç¤ºç¶ è‰² (false)
        newItem.innerHTML = `
        <span class="issue-status" style="color: #2e7d32">ğŸŸ¢</span>
        <input type="text" id="tempIssueInput" placeholder="è¼¸å…¥åç¨±å¾ŒæŒ‰ Enter..." 
               style="width: 100%; border: 1px solid var(--brand); outline: none; padding: 2px 5px;">
        <span class="issue-date">ç¾åœ¨</span>
    `;

        container.prepend(newItem); // å°‡æ–°é …ç›®æ”¾åˆ°æœ€ä¸Šæ–¹
        const input = newItem.querySelector("#tempIssueInput");
        input.focus();

        input.onkeydown = async (e) => {
          if (e.key === "Enter") {
            const title = input.value.trim();
            if (title.length < 2) {
              alert("æ¨™é¡Œå¤ªçŸ­å›‰ï¼");
              newItem.remove();
              return;
            }
            await performSaveIssueToDB(title, newItem);
          }
        };

        input.onblur = () => {
          if (!input.value.trim()) newItem.remove();
        };
      };

      // å¯¦éš›å‚³é€åˆ°å¾Œç«¯çš„å‡½å¼
      async function performSaveIssueToDB(title, element) {
        const form = new FormData();
        form.append("project_id", currentRepliesTaskId); // ç¢ºä¿ä½ æœ‰é€™å€‹è®Šæ•¸
        form.append("title", title);

        element.querySelector(".issue-status").textContent = "âŒ›";

        try {
          const resp = await fetch(CREATE_ISSUE_URL, {
            method: "POST",
            body: form,
            credentials: "same-origin",
          });
          const j = await resp.json();

          if (j.success) {
            const realId = j.issue_id;
            // æ¨£å¼ç«‹å³æ”¹è®Šç‚ºå„²å­˜å¾Œçš„æ¨£å­
            element.id = `issue-${realId}`;
            element.dataset.id = realId;
            element.className = "issue-item opened";
            element.innerHTML = `
                <span class="issue-status">ğŸŸ¢</span>
                <span class="issue-title">${title}</span>
                <span class="issue-date">ç¾åœ¨</span>
            `;
            // é»æ“Šå¾Œå¯ä»¥é–‹å•ŸèŠå¤©
            element.onclick = () => selectIssue(realId);
            selectIssue(realId);
          } else {
            alert("æ–°å¢å¤±æ•—ï¼š" + j.message);
            element.remove();
          }
        } catch (err) {
          console.error("Save issue error:", err);
          element.remove();
        }
      }

      // å®Œæˆäº‹é …
      window.completeIssue = async function (issueId) {
        if (!confirm(`ç¢ºå®šæ¨™è¨˜ Issue #${issueId} ç‚ºã€Œå·²è™•ç†å®Œæˆã€å—ï¼Ÿ`)) return;

        const form = new FormData();
        form.append("issue_id", issueId);

        try {
          const resp = await fetch(RESOLVE_ISSUE_URL, {
            method: "POST",
            body: form,
            credentials: "same-origin",
          });
          const j = await resp.json();

          if (j.success) {
            alert("äº‹é …å·²æ¨™è¨˜ç‚ºå®Œæˆã€‚");
            if (currentSelectedIssueId === issueId) {
              currentSelectedIssueId = null; // å¦‚æœå®Œæˆçš„æ˜¯ç•¶å‰é¸ä¸­çš„ï¼Œå–æ¶ˆé¸æ“‡
            }
            await fetchAndRenderIssues(currentIssueTaskId); // é‡æ–°è¼‰å…¥åˆ—è¡¨
            renderChatHistory(); // é‡æ–°æ¸²æŸ“èŠå¤©å€ (å¯èƒ½é¡¯ç¤ºæç¤º)
          } else {
            alert("æ¨™è¨˜å¤±æ•—ï¼š" + (j.message || ""));
          }
        } catch (err) {
          console.error("Resolve issue error:", err);
          alert("ç¶²è·¯éŒ¯èª¤ï¼Œç„¡æ³•å®Œæˆäº‹é …");
        }
      };

      // é¸æ“‡äº‹é …
      window.selectIssue = async function (issueId) {
        if (issueId === currentSelectedIssueId) return; // é¿å…é‡è¤‡é¸æ“‡

        currentSelectedIssueId = issueId;

        // é‡æ–°æ¸²æŸ“åˆ—è¡¨ä»¥æ›´æ–°é¸ä¸­ç‹€æ…‹
        await fetchAndRenderIssues(currentIssueTaskId);

        // ç²å–ä¸¦æ¸²æŸ“è©²äº‹é …çš„ç•™è¨€
        await fetchAndRenderComments(issueId);
      };

      // --- 3. ç•™è¨€èŠå¤©é‚è¼¯ (CRUD) ---

      // ç²å–ä¸¦æ¸²æŸ“ç•™è¨€
      async function fetchAndRenderComments(issueId) {
        const historyContainer = document.getElementById("chatHistory");
        historyContainer.innerHTML = `<div style="text-align:center; padding: 20px; font-size:12px;">è¼‰å…¥ç•™è¨€ä¸­...</div>`;

        try {
          const resp = await fetch(`${FETCH_COMMENTS_URL}&issue_id=${issueId}`);
          const data = await resp.json();

          if (data.success && data.comments) {
            commentCache[issueId] = data.comments; // å¿«å–ç•™è¨€
            renderChatHistory(data.comments);
          } else {
            historyContainer.innerHTML = `<div style="color:red; text-align:center; padding: 20px; font-size:12px;">è¼‰å…¥ç•™è¨€å¤±æ•—: ${
              data.message || "æœªçŸ¥éŒ¯èª¤"
            }</div>`;
          }
        } catch (err) {
          console.error("Fetch comments error:", err);
          historyContainer.innerHTML = `<div style="color:red; text-align:center; padding: 20px; font-size:12px;">ç¶²è·¯éŒ¯èª¤ï¼Œç„¡æ³•è¼‰å…¥ç•™è¨€</div>`;
        }
      }

      // æ¸²æŸ“ç•™è¨€æ­·å²ç´€éŒ„ UI
      // ... (åœ¨ renderChatHistory å‡½å¼å…§éƒ¨)
      // è«‹ç¢ºèªæ‚¨çš„ renderChatHistory å‡½å¼èˆ‡ä»¥ä¸‹ç‰ˆæœ¬ä¸€è‡´
      let allIssues = []; // ç”¨æ–¼å­˜å„²ç›®å‰çš„æ‰€æœ‰äº‹é …åˆ—è¡¨

      function renderChatHistory(comments = null) {
        const historyContainer = document.getElementById("chatHistory"); // ç¢ºä¿å®šç¾©
        const inputArea = document.getElementById("chatInputArea"); // ç¢ºä¿å®šç¾©
        historyContainer.innerHTML = "";

        // æª¢æŸ¥æ˜¯å¦æœ‰é¸ä¸­çš„äº‹é …
        if (currentSelectedIssueId === null) {
          historyContainer.innerHTML = `<div class="chat-prompt">è«‹å¾å·¦å´åˆ—è¡¨ä¸­é¸æ“‡ä¸€å€‹å¾…è§£æ±ºäº‹é …ä»¥é–‹å§‹è¨è«–ã€‚</div>`;
          inputArea.style.display = "none"; // éš±è—è¼¸å…¥æ¡†
          return;
        }

        // æ ¹æ“šç›®å‰é¸ä¸­çš„ Issue çš„is_openç‹€æ…‹æ±ºå®šè¼¸å…¥å€é¡¯ç¤ºèˆ‡å¦
        const currentIssue = allIssues.find(
          (i) => i.id == currentSelectedIssueId
        );
        if (inputArea) {
          // åªæœ‰åœ¨ Issue å­˜åœ¨ä¸”ç‹€æ…‹ç‚º true (1) æ™‚æ‰é¡¯ç¤º flex
          if (
            currentIssue &&
            (currentIssue.issue_is_opened == true ||
              currentIssue.issue_is_opened == 1)
          ) {
            inputArea.style.display = "flex";
          } else {
            // å¦å‰‡è¨­ç‚º noneï¼Œé€™æœƒç›´æ¥å¯«å…¥ element.styleï¼Œæ¬Šé‡è¶³ä»¥è¦†è“‹ CSS
            inputArea.style.display = "none";
          }
        }

        const list = comments || commentCache[currentSelectedIssueId] || [];
        const currentUserIdStr = window.currentUserId;

        if (list.length === 0) {
          const div = document.createElement("div");
          div.style.textAlign = "center";
          div.style.color = "#999";
          div.style.fontSize = "12px";
          div.style.margin = "10px 0";
          div.textContent = "é€™æ˜¯æ–°çš„è¨è«–ï¼Œé–‹å§‹å°è©±å§ï¼";
          historyContainer.appendChild(div);
        }

        list.forEach((comment) => {
          const div = document.createElement("div");
          const isMe = String(comment.user_id) === currentUserIdStr;

          div.className = `chat-message ${isMe ? "msg-right" : "msg-left"}`;
          div.textContent = escapeHtml(comment.content);
          historyContainer.appendChild(div);

          const clear = document.createElement("div");
          clear.style.clear = "both";
          historyContainer.appendChild(clear);
        });
        // æ²å‹•åˆ°åº•éƒ¨
        historyContainer.scrollTop = historyContainer.scrollHeight;
      }

      // ç™¼é€ç•™è¨€
      // ç™¼é€ç•™è¨€æŒ‰éˆ•
      document.getElementById("chatSendBtn").onclick = async function (event) {
        if (currentSelectedIssueId === null) {
          alert("è«‹å…ˆé¸æ“‡ä¸€å€‹äº‹é …å†ç•™è¨€");
          return;
        }

        const input = document.getElementById("chatInput");
        const content = input.value.trim();
        if (content === "çµæŸissue") {
          if (!confirm("ç¢ºå®šè¦çµæ¡ˆä¸¦é—œé–‰æ­¤è¨è«–å—ï¼Ÿ")) return;

          const form = new FormData();
          form.append("issue_id", currentSelectedIssueId);

          try {
            // å‘¼å«æ‚¨ä¹‹å‰çš„å¾Œç«¯ API
            const resp = await fetch(
              "backend/issue.php?action=issues/resolve",
              {
                method: "POST",
                body: form,
              }
            );
            const j = await resp.json();

            if (j.success) {
              alert("æ­¤äº‹é …å·²çµæ¡ˆ");
              input.value = "";

              // ğŸš¨ é‡è¦ï¼šç«‹åˆ»é‡æ–°æŠ“å–è³‡æ–™ï¼Œé€™æœƒæ›´æ–° allIssues é™£åˆ—
              await fetchAndRenderIssues(currentIssueTaskId);

              // ğŸš¨ é‡è¦ï¼šé‡æ–°æ¸²æŸ“å°è©±æ¡†ï¼Œé€™æœƒè§¸ç™¼æˆ‘å€‘å¯«å¥½çš„éš±è—é‚è¼¯
              await renderChatHistory();
            } else {
              alert("é—œé–‰å¤±æ•—ï¼š" + j.message);
            }
          } catch (err) {
            console.error("Resolve error:", err);
          }
          return; // çµæŸåŸ·è¡Œï¼Œä¸è·‘å¾Œé¢çš„ã€Œç™¼é€ä¸€èˆ¬ç•™è¨€ã€é‚è¼¯
        }

        if (content) {
          const form = new FormData();
          form.append("issue_id", currentSelectedIssueId);
          form.append("content", content);

          try {
            // æ³¨æ„ï¼šé€™è£¡æ˜¯ CREATE_COMMENT_URL
            const resp = await fetch(CREATE_COMMENT_URL, {
              method: "POST",
              body: form,
              credentials: "same-origin",
            });
            const j = await resp.json();

            if (j.success) {
              input.value = ""; // æ¸…ç©ºè¼¸å…¥æ¡†
              await fetchAndRenderComments(currentSelectedIssueId); // åˆ·æ–°å°è©±
            } else {
              alert("ç™¼é€å¤±æ•—ï¼š" + j.message);
            }
          } catch (err) {
            console.error("Comment send error:", err);
          }
        }
      };

      // æ”¯æ´æŒ‰ Enter ç™¼é€
      document.getElementById("chatInput").addEventListener("keypress", (e) => {
        if (e.key === "Enter" && currentSelectedIssueId !== null) {
          document.getElementById("chatSendBtn").click();
        }
      });

      // åœ¨ä½ çš„ <script> å€å¡Šå…§æ–°å¢ä»¥ä¸‹å‡½å¼å’Œäº‹ä»¶ï¼š

      let isCreatingNewIssue = false; // ç‹€æ…‹æ¨™è¨˜ï¼Œé˜²æ­¢åŒæ™‚å‰µå»ºå¤šå€‹

      /**
       * åœ¨ UI ä¸Šæ–°å¢ä¸€å€‹å¯ä¾›ç·¨è¼¯çš„äº‹é …é …ç›®
       */
      function addNewIssueToUI() {
        if (isCreatingNewIssue) {
          // å¦‚æœå·²ç¶“åœ¨ç·¨è¼¯ï¼Œå‰‡ä¸åŸ·è¡Œ
          alert("è«‹å…ˆå®Œæˆç•¶å‰æ–°å¢çš„äº‹é …ã€‚");
          return;
        }

        // å‡è¨­æˆ‘å€‘ä½¿ç”¨ä¸€å€‹è‡¨æ™‚ ID ä¾†æ¨™è¨˜é€™å€‹ã€Œæœªå„²å­˜ã€çš„é …ç›®
        const TEMP_ID = "temp-new-issue";

        // 1. å‰µå»ºæ–°çš„åˆ—è¡¨é …ç›®
        const item = document.createElement("div");
        item.className = `issue-item opened creating`;
        item.dataset.id = TEMP_ID;
        item.id = `issue-${TEMP_ID}`;

        item.innerHTML = `
        <span class="issue-status">ğŸ†•</span>
        <span class="issue-title" data-issue-id="${TEMP_ID}">è«‹è¼¸å…¥æ¨™é¡Œ</span>
        <span class="issue-date">ä»Šå¤©</span>
    `;

        const issueListContainer =
          document.getElementById("issueListContainer");
        issueListContainer.prepend(item); // æ”¾åˆ°æœ€é ‚ç«¯

        // 2. ç«‹å³å•Ÿç”¨ç·¨è¼¯æ¨¡å¼
        const titleSpan = item.querySelector(".issue-title");
        enableIssueEdit(titleSpan);

        isCreatingNewIssue = true;
      }

      // ç¶å®š '+' æŒ‰éˆ•
      document
        .getElementById("addIssueBtn")
        .addEventListener("click", addNewIssueToUI);

      // å…¨åŸŸç‹€æ…‹ï¼šå„²å­˜ç•¶å‰ç·¨è¼¯çš„ Issue DOM å…ƒç´ 
      // å…¨åŸŸç‹€æ…‹ï¼šå„²å­˜ç•¶å‰ç·¨è¼¯çš„ Issue DOM å…ƒç´ 
      let currentEditingElement = null;

      // æ–°å¢æ¨™è¨˜ï¼šç”¨æ–¼é˜»æ­¢åœ¨ alert ä¹‹å¾Œç«‹å³é‡æ–°è§¸ç™¼ blur
      let isAlertActive = false;

      /**
       * å°‡ span å…ƒç´ è½‰æ›ç‚ºå¯è¼¸å…¥çš„ input æ¡†ï¼Œä¸¦ç¶å®šäº‹ä»¶
       */
      function enableIssueEdit(titleElement) {
        if (currentEditingElement) {
          // ç¢ºä¿åªèƒ½æœ‰ä¸€å€‹ç·¨è¼¯ä¸­çš„é …ç›®
          currentEditingElement.focus();
          return;
        }

        const issueId = titleElement.dataset.issueId;
        const originalText =
          titleElement.textContent.trim() === "è«‹è¼¸å…¥æ¨™é¡Œ"
            ? ""
            : titleElement.textContent;

        // å‰µå»º Input å…ƒç´ 
        const input = document.createElement("input");
        input.type = "text";
        input.value = originalText;
        input.placeholder = "è«‹è¼¸å…¥äº‹é …æ¨™é¡Œ (å¿…å¡«)";
        input.style.width = "100%";

        // æ›¿æ› DOM
        titleElement.replaceWith(input);
        input.focus();

        currentEditingElement = input; // è¨­ç½®ç•¶å‰ç·¨è¼¯å…ƒç´ 

        // --- ç¶å®šäº‹ä»¶ ---

        // 1. Enter éµäº‹ä»¶
        input.addEventListener("keydown", function (e) {
          if (e.key === "Enter") {
            e.preventDefault(); // é˜»æ­¢æ›è¡Œ
            input.blur(); // è§¸ç™¼å¤±ç„¦äº‹ä»¶ä¾†å„²å­˜
          }
        });

        // 2. å¤±ç„¦ (Blur) äº‹ä»¶ - ä¿®æ­£ç„¡é™è¿´åœˆçš„é—œéµ
        input.addEventListener("blur", async function () {
          if (isAlertActive) return;

          const newTitle = input.value.trim();

          // é©—è­‰é•·åº¦
          if (newTitle.length < 3) {
            isAlertActive = true;
            alert("âš ï¸ æ¨™é¡Œé•·åº¦ä¸è¶³ï¼Œè«‹è¼¸å…¥è‡³å°‘ 3 å€‹å­—ç¬¦ã€‚");
            setTimeout(() => {
              isAlertActive = false;
              input.focus();
            }, 100);
            return;
          }

          // --- é—œéµä¿®æ”¹ï¼šå‘¼å«å„²å­˜å‡½å¼ ---
          await saveNewIssue(issueId, newTitle, input);
        });

        // 3. é›¢é–‹é é¢å‰æç¤ºä¿å­˜
        window.addEventListener("beforeunload", function (e) {
          if (currentEditingElement) {
            e.preventDefault();
            e.returnValue = "";
          }
        });
      }

      /**
       * å„²å­˜æ–°çš„ Issue åˆ°è³‡æ–™åº«
       */
      async function saveNewIssue(issueId, title, inputElement) {
        if (issueId !== "temp-new-issue" || !isCreatingNewIssue) return;

        const itemElement = document.getElementById(`issue-${issueId}`);
        if (!itemElement) return;

        // --- ğŸš€ æ¨‚è§€æ›´æ–°ï¼šç«‹å³æ”¹è®Šæ¨£å¼ ---
        const newSpan = document.createElement("span");
        newSpan.className = "issue-title";
        newSpan.textContent = title;
        newSpan.dataset.issueId = issueId; // æš«æ™‚ä½¿ç”¨ temp ID

        // ç«‹å³å°‡è¼¸å…¥æ¡†æ›å›æ–‡å­—æ¨™ç±¤
        inputElement.replaceWith(newSpan);
        itemElement.classList.remove("creating"); // ç§»é™¤ã€Œå»ºç«‹ä¸­ã€çš„ç‰¹æ®Šæ¨£å¼(å¦‚æœ‰)
        itemElement.querySelector(".issue-status").textContent = "âŒ›"; // é¡¯ç¤ºè™•ç†ä¸­åœ–ç¤º

        try {
          const form = new FormData();
          form.append("project_id", currentRepliesTaskId);
          form.append("title", title);

          const resp = await fetch(CREATE_ISSUE_URL, {
            method: "POST",
            body: form,
          });
          const data = await resp.json();

          if (data.success) {
            // å„²å­˜æˆåŠŸï¼šæ›´æ–°ç‚ºçœŸå¯¦ ID èˆ‡æ­£å¼åœ–ç¤º
            newSpan.dataset.issueId = data.issue_id;
            itemElement.dataset.id = data.issue_id;
            itemElement.id = `issue-${data.issue_id}`;
            itemElement.querySelector(".issue-status").textContent = "ğŸŸ¢";

            // é‡æ–°ç¶å®šé»æ“Šäº‹ä»¶ï¼Œè®“æ–°é …ç›®å¯ä»¥è¢«é¸ä¸­
            itemElement.onclick = () => selectIssue(data.issue_id);

            console.log("è³‡æ–™åº«å„²å­˜æˆåŠŸ");
          } else {
            throw new Error(data.message || "å„²å­˜å¤±æ•—");
          }
        } catch (err) {
          console.error("Save issue error:", err);
          alert("å„²å­˜å¤±æ•—ï¼š" + err.message);

          // --- ğŸ”™ å¾©åŸé‚è¼¯ï¼šå¦‚æœå¤±æ•—ï¼Œç§»é™¤è©²é …ç›®ä¸¦å…è¨±é‡æ–°æ–°å¢ ---
          itemElement.remove();
        } finally {
          isCreatingNewIssue = false;
          currentEditingElement = null;
        }
      }

      // æš´éœ² openIssuesModal çµ¦å…¨åŸŸä½¿ç”¨
      window.openIssuesModal = openIssuesModal;
    </script>
  </body>
</html>
